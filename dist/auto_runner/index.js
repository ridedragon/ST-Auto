import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',r=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),r&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),r&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,r,n,o){'string'==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(i[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);r&&i[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=o),a&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=a):c[2]=a),n&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=n):c[4]=''.concat(n)),t.push(c))}},t}},93:e=>{e.exports=function(e){return e[1]}},376:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var r=a(93),n=a.n(r),o=a(54),i=a.n(o)()(n());i.push([e.id,'.auto-runner-settings[data-v-2795a3fa]{padding:1rem;background-color:#2a2a2e;color:#f0f0f0;border-radius:8px;font-family:sans-serif}h2[data-v-2795a3fa],h3[data-v-2795a3fa]{color:#fff;border-bottom:1px solid #444;padding-bottom:.5rem;margin-top:1rem}.setting-group[data-v-2795a3fa]{margin-bottom:1rem}input[type=text][data-v-2795a3fa],input[type=password][data-v-2795a3fa],input[type=number][data-v-2795a3fa],textarea[data-v-2795a3fa]{width:100%;padding:.5rem;background-color:#3a3a3e;border:1px solid #555;color:#f0f0f0;border-radius:4px;margin-bottom:.5rem;box-sizing:border-box}textarea[data-v-2795a3fa]{min-height:100px;resize:vertical}button[data-v-2795a3fa]{background-color:#4a90e2;color:#fff;padding:.75rem 1.5rem;border:none;border-radius:4px;cursor:pointer;font-size:1rem;transition:background-color .2s}button[data-v-2795a3fa]:hover{background-color:#357abd}.toggle-switch[data-v-2795a3fa]{position:relative;display:inline-block;width:60px;height:34px}.toggle-switch input[data-v-2795a3fa]{opacity:0;width:0;height:0}.toggle-switch .slider[data-v-2795a3fa]{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.toggle-switch .slider[data-v-2795a3fa]:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}.toggle-switch input:checked+.slider[data-v-2795a3fa]{background-color:#4a90e2}.toggle-switch input:checked+.slider[data-v-2795a3fa]:before{transform:translateX(26px)}','']);const s=i},402:(e,t,a)=>{var r=a(376);r.__esModule&&(r=r.default),'string'==typeof r&&(r=[[e.id,r,'']]),r.locals&&(e.exports=r.locals);(0,a(424).A)('ea13aee8',r,!1,{ssrId:!0})},424:(e,t,a)=>{function r(e,t){for(var a=[],r={},n=0;n<t.length;n++){var o=t[n],i=o[0],s={id:e+':'+n,css:o[1],media:o[2],sourceMap:o[3]};r[i]?r[i].parts.push(s):a.push(r[i]={id:i,parts:[s]})}return a}a.d(t,{A:()=>m});var n='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!n)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var o={},i=n&&(document.head||document.getElementsByTagName('head')[0]),s=null,l=0,d=!1,c=function(){},p=null,u='data-vue-ssr-id',f='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(e,t,a,n){d=a,p=n||{};var i=r(e,t);return g(i),function(t){for(var a=[],n=0;n<i.length;n++){var s=i[n];(l=o[s.id]).refs--,a.push(l)}t?g(i=r(e,t)):i=[];for(n=0;n<a.length;n++){var l;if(0===(l=a[n]).refs){for(var d=0;d<l.parts.length;d++)l.parts[d]();delete o[l.id]}}}}function g(e){for(var t=0;t<e.length;t++){var a=e[t],r=o[a.id];if(r){r.refs++;for(var n=0;n<r.parts.length;n++)r.parts[n](a.parts[n]);for(;n<a.parts.length;n++)r.parts.push(h(a.parts[n]));r.parts.length>a.parts.length&&(r.parts.length=a.parts.length)}else{var i=[];for(n=0;n<a.parts.length;n++)i.push(h(a.parts[n]));o[a.id]={id:a.id,refs:1,parts:i}}}}function v(){var e=document.createElement('style');return e.type='text/css',i.appendChild(e),e}function h(e){var t,a,r=document.querySelector('style['+u+'~="'+e.id+'"]');if(r){if(d)return c;r.parentNode.removeChild(r)}if(f){var n=l++;r=s||(s=v()),t=x.bind(null,r,n,!1),a=x.bind(null,r,n,!0)}else r=v(),t=V.bind(null,r),a=function(){r.parentNode.removeChild(r)};return t(e),function(r){if(r){if(r.css===e.css&&r.media===e.media&&r.sourceMap===e.sourceMap)return;t(e=r)}else a()}}var b,y=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function x(e,t,a,r){var n=a?'':r.css;if(e.styleSheet)e.styleSheet.cssText=y(t,n);else{var o=document.createTextNode(n),i=e.childNodes;i[t]&&e.removeChild(i[t]),i.length?e.insertBefore(o,i[t]):e.appendChild(o)}}function V(e,t){var a=t.css,r=t.media,n=t.sourceMap;if(r&&e.setAttribute('media',r),p.ssrId&&e.setAttribute(u,t.id),n&&(a+='\n/*# sourceURL='+n.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},441:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,r]of t)a[e]=r;return a}}},a={};function r(e){var n=a[e];if(void 0!==n)return n.exports;var o=a[e]={id:e,exports:{}};return t[e](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const n=z,o=_;var i=r.n(o);const s=n.z.object({enabled:n.z.boolean().default(!1),prompt:n.z.string().default(''),apiUrl:n.z.string().default(''),apiKey:n.z.string().default(''),temperature:n.z.number().min(0).max(2).default(.7),maxReplies:n.z.number().min(1).default(10)});let l=0,d=!1;async function c(e){if(d)return void console.log('自动化脚本正在运行中，跳过本次触发。');const t=s.parse(getVariables({type:'script',script_id:getScriptId()})||{}),a=getChatMessages(-1)[0];if(t.enabled&&'assistant'===a.role&&!(l<=0)){d=!0,toastr.info(`自动化脚本介入，剩余 ${l} 次回复。`);try{const a=getChatMessages(`0-${e}`).map(e=>`${e.name}: ${e.message}`).join('\n'),r=await generate({user_input:`${a}\n\n${t.prompt}`,custom_api:{apiurl:t.apiUrl,key:t.apiKey,model:'claude-3-opus-20240229',temperature:t.temperature},should_stream:!1});if(!r||''===r.trim())throw new Error('副AI没有返回有效指令。');await createChatMessages([{role:'user',name:SillyTavern.name1,message:r}]),l--,toastr.success(`指令已发送，剩余 ${l} 次。`)}catch(e){console.error('自动化脚本运行出错:',e),toastr.error(`脚本错误: ${e.message}`)}finally{d=!1,l<=0&&(toastr.info('自动化任务完成。'),t.enabled=!1,replaceVariables(i().cloneDeep(t),{type:'script',script_id:getScriptId()}))}}}function p(e){const t=s.parse(getVariables({type:'script',script_id:getScriptId()})||{}),a=getChatMessages(0)[0];t.enabled&&1===getChatMessages('0-{{lastMessageId}}').length&&'user'===a.role&&(l=t.maxReplies,toastr.info(`自动化脚本已启动，将代替用户回复 ${l} 次。`))}const u=Vue,f={class:'auto-runner-settings'},m={class:'setting-group'},g={class:'toggle-switch'},v={class:'setting-group'},h={class:'setting-group'},b={class:'setting-group'},y=(0,u.defineComponent)({__name:'app',setup(e){const t=n.z.object({enabled:n.z.boolean().default(!1),prompt:n.z.string().default(''),apiUrl:n.z.string().default(''),apiKey:n.z.string().default(''),temperature:n.z.number().min(0).max(2).default(.7),maxReplies:n.z.number().min(1).default(10)}),a=(0,u.ref)(t.parse({}));(0,u.onMounted)(()=>{try{const e=getVariables({type:'script',script_id:getScriptId()});a.value=t.parse(e),toastr.info('设置已加载。')}catch(e){console.error('加载设置失败:',e),a.value=t.parse({}),toastr.warning('无法加载保存的设置，已使用默认设置。')}});const r=()=>{try{const e=t.parse(a.value);replaceVariables(i().cloneDeep(e),{type:'script',script_id:getScriptId()}),toastr.success('设置已成功保存！')}catch(e){console.error('保存设置失败:',e),toastr.error(`保存失败: ${e.message}`)}};return(e,t)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',f,[t[13]||(t[13]=(0,u.createElementVNode)('h2',null,'自动化运行脚本设置',-1)),(0,u.createElementVNode)('div',m,[(0,u.createElementVNode)('label',g,[t[6]||(t[6]=(0,u.createTextVNode)(' 启用脚本 ',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t[0]||(t[0]=e=>a.value.enabled=e)},null,512),[[u.vModelCheckbox,a.value.enabled]]),t[7]||(t[7]=(0,u.createElementVNode)('span',{class:'slider'},null,-1))])]),(0,u.createElementVNode)('div',v,[t[8]||(t[8]=(0,u.createElementVNode)('h3',null,'提示词设置',-1)),(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t[1]||(t[1]=e=>a.value.prompt=e),placeholder:'输入给副AI的指令...'},null,512),[[u.vModelText,a.value.prompt]])]),(0,u.createElementVNode)('div',h,[t[10]||(t[10]=(0,u.createElementVNode)('h3',null,'API 调用设置',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{type:'text','onUpdate:modelValue':t[2]||(t[2]=e=>a.value.apiUrl=e),placeholder:'API URL'},null,512),[[u.vModelText,a.value.apiUrl]]),(0,u.withDirectives)((0,u.createElementVNode)('input',{type:'password','onUpdate:modelValue':t[3]||(t[3]=e=>a.value.apiKey=e),placeholder:'API 密钥'},null,512),[[u.vModelText,a.value.apiKey]]),(0,u.createElementVNode)('label',null,[t[9]||(t[9]=(0,u.createTextVNode)(' Temperature: ',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{type:'number','onUpdate:modelValue':t[4]||(t[4]=e=>a.value.temperature=e),step:'0.1',min:'0',max:'2'},null,512),[[u.vModelText,a.value.temperature]])])]),(0,u.createElementVNode)('div',b,[t[12]||(t[12]=(0,u.createElementVNode)('h3',null,'自动化设置',-1)),(0,u.createElementVNode)('label',null,[t[11]||(t[11]=(0,u.createTextVNode)(' 最大回复次数: ',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{type:'number','onUpdate:modelValue':t[5]||(t[5]=e=>a.value.maxReplies=e),min:'1'},null,512),[[u.vModelText,a.value.maxReplies]])])]),(0,u.createElementVNode)('button',{onClick:r},'保存设置')]))}});r(402);const x=(0,r(441).A)(y,[['__scopeId','data-v-2795a3fa']]),V=(0,u.createApp)(x);function E(){!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('<div>').attr('script_id',getScriptId());$('#extensions_settings2').append(t),V.use(e()).mount(t[0])}function w(){V.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{E(),eventOn(tavern_events.MESSAGE_RECEIVED,c),eventOn(tavern_events.MESSAGE_SENT,p),console.log('自动化运行脚本已启动并监听事件。')}),$(window).on('pagehide',()=>{w()});