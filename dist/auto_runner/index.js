import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var s=0;s<this.length;s++){var i=this[s][0];null!=i&&(l[i]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);o&&l[u[0]]||(void 0!==r&&(void 0===u[5]||(u[1]='@layer'.concat(u[5].length>0?' '.concat(u[5]):'',' {').concat(u[1],'}')),u[5]=r),n&&(u[2]?(u[1]='@media '.concat(u[2],' {').concat(u[1],'}'),u[2]=n):u[2]=n),a&&(u[4]?(u[1]='@supports ('.concat(u[4],') {').concat(u[1],'}'),u[4]=a):u[4]=''.concat(a)),t.push(u))}},t}},93:e=>{e.exports=function(e){return e[1]}},151:(e,t,n)=>{n.r(t),n.d(t,{default:()=>s});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.wide-button[data-v-237f90f4]{width:100%;margin-top:10px}label[data-v-237f90f4]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-237f90f4]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-237f90f4]{width:100%}.description[data-v-237f90f4]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-237f90f4]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-237f90f4]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-237f90f4]{transform:scale(1.2)}.rule-name[data-v-237f90f4]{flex-grow:1}.rule-body[data-v-237f90f4]{display:flex;flex-direction:column;gap:5px}.set-manager[data-v-237f90f4]{display:flex;gap:10px;align-items:center}.set-select[data-v-237f90f4]{flex-grow:1}.set-buttons[data-v-237f90f4]{display:flex;gap:5px}.icon-button[data-v-237f90f4]{padding:6px 10px;line-height:1;flex-shrink:0}','']);const s=l},205:(e,t,n)=>{var o=n(151);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('566ccf17',o,!1,{ssrId:!0})},424:(e,t,n)=>{function o(e,t){for(var n=[],o={},a=0;a<t.length;a++){var r=t[a],l=r[0],s={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(s):n.push(o[l]={id:l,parts:[s]})}return n}n.d(t,{A:()=>f});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=a&&(document.head||document.getElementsByTagName('head')[0]),s=null,i=0,c=!1,u=function(){},d=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,a){c=n,d=a||{};var l=o(e,t);return v(l),function(t){for(var n=[],a=0;a<l.length;a++){var s=l[a];(i=r[s.id]).refs--,n.push(i)}t?v(l=o(e,t)):l=[];for(a=0;a<n.length;a++){var i;if(0===(i=n[a]).refs){for(var c=0;c<i.parts.length;c++)i.parts[c]();delete r[i.id]}}}}function v(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var a=0;a<o.parts.length;a++)o.parts[a](n.parts[a]);for(;a<n.parts.length;a++)o.parts.push(b(n.parts[a]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var l=[];for(a=0;a<n.parts.length;a++)l.push(b(n.parts[a]));r[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function b(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return u;o.parentNode.removeChild(o)}if(m){var a=i++;o=s||(s=g()),t=E.bind(null,o,a,!1),n=E.bind(null,o,a,!0)}else o=g(),t=w.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var h,x=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join('\n')});function E(e,t,n,o){var a=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,a);else{var r=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function w(e,t){var n=t.css,o=t.media,a=t.sourceMap;if(o&&e.setAttribute('media',o),d.ssrId&&e.setAttribute(p,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},427:(e,t,n)=>{var o=n(689);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('3f6cbc0e',o,!1,{ssrId:!0})},689:(e,t,n)=>{n.r(t),n.d(t,{default:()=>s});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.rule-header[data-v-1bbbb5ab]{display:flex;align-items:center;gap:10px}.drag-handle[data-v-1bbbb5ab]{cursor:grab}.rule-name[data-v-1bbbb5ab]{flex-grow:1;min-width:50px}.buttons[data-v-1bbbb5ab]{display:flex;flex-shrink:0;gap:5px}.icon-button[data-v-1bbbb5ab]{padding:4px 8px;line-height:1}.rule-body select[data-v-1bbbb5ab]{margin-top:5px}.wide-button[data-v-1bbbb5ab]{width:100%;margin-top:10px}.chat-history-placeholder[data-v-1bbbb5ab]{background-color:var(--bg3) !important}','']);const s=l}},n={};function o(e){var a=n[e];if(void 0!==a)return a.exports;var r=n[e]={id:e,exports:{}};return t[e](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const a=_;var r=o.n(a);const l=z,s=l.z.object({id:l.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:l.z.string().default(''),find:l.z.string().default(''),replace:l.z.string().default(''),enabled:l.z.boolean().default(!0)}),i=l.z.object({id:l.z.string().default(()=>`prompt_${Date.now()}_${Math.random()}`),name:l.z.string(),content:l.z.string(),enabled:l.z.boolean(),editing:l.z.boolean(),role:l.z.enum(['user','system','assistant']),is_chat_history:l.z.boolean().optional().default(!1)}),c=l.z.object({id:l.z.string().default(()=>`set_${Date.now()}_${Math.random()}`),name:l.z.string(),promptEntries:l.z.array(i)}),u=l.z.object({enabled:l.z.boolean().default(!1),promptSets:l.z.array(c).default([]),activePromptSetId:l.z.string().nullable().default(null),apiUrl:l.z.preprocess(e=>e??'',l.z.string()),apiKey:l.z.preprocess(e=>e??'',l.z.string()),model:l.z.preprocess(e=>e??'',l.z.string()),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(40),max_tokens:l.z.coerce.number().min(1).default(1024),totalReplies:l.z.coerce.number().min(1).default(10),executedCount:l.z.coerce.number().min(0).default(0),contextRegexRules:l.z.array(s).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:l.z.array(s).default([]),maxRetries:l.z.coerce.number().min(0).default(3),exemptionCount:l.z.coerce.number().min(0).default(0)}),d=Vue;var p;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(p||(p={}));let m=p.IDLE;const f=(0,d.ref)(u.parse({}));let v=0,g=0,b=!1;const h=(0,d.computed)(()=>{const e=f.value.promptSets.find(e=>e.id===f.value.activePromptSetId);return e||c.parse({name:'（无有效配置）',promptEntries:[]})});function x(){const e=window.prompt('请输入新配置的名称：',`新配置 ${f.value.promptSets.length+1}`);if(!e)return;const t=i.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=c.parse({name:e,promptEntries:[t]});f.value.promptSets.push(n),f.value.activePromptSetId=n.id,toastr.success(`已创建新配置 "${e}"`)}function E(){const e=h.value;if(!e||'（无有效配置）'===e.name)return;const t=window.prompt('请输入新的名称：',e.name);if(t&&t!==e.name){const n=f.value.promptSets.find(t=>t.id===e.id);n&&(n.name=t,toastr.success('配置已重命名'))}}function w(){if(f.value.promptSets.length<=1)return void toastr.error('无法删除最后一个配置集');const e=h.value;if(!e||!window.confirm(`确定要删除配置 "${e.name}" 吗？此操作不可撤销。`))return;const t=f.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(f.value.promptSets.splice(t,1),f.value.activePromptSetId=f.value.promptSets[Math.max(0,t-1)]?.id||null,toastr.success(`配置 "${e.name}" 已删除`))}function y(){const e=h.value;if(!e)return;const t=JSON.stringify(e,null,2),n=new Blob([t],{type:'application/json'}),o=URL.createObjectURL(n),a=document.createElement('a');a.href=o,a.download=`${e.name}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),toastr.success('当前配置已导出')}function V(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n),t=Array.isArray(e)?e:[e];let o=0;for(const e of t){const t=c.safeParse(e);if(t.success){if(f.value.promptSets.some(e=>e.name===t.data.name)){if(!window.confirm(`已存在名为 "${t.data.name}" 的配置。要覆盖它吗？`))continue;const e=f.value.promptSets.findIndex(e=>e.name===t.data.name);e>-1&&f.value.promptSets.splice(e,1)}t.data.id=`set_${Date.now()}_${Math.random()}`,f.value.promptSets.push(t.data),o++}else console.error('导入的数据格式无效:',t.error),toastr.error('一个或多个导入的配置格式无效，详情请查看控制台。')}o>0&&toastr.success(`成功导入 ${o} 个配置。`)}catch(e){console.error('导入失败:',e),toastr.error('导入文件失败，请确保是有效的JSON文件。')}},e.click()}function N(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let o;if(t){const e=t[1],n=t[2];o=new RegExp(e,n)}else o=new RegExp(e.find,'g');n=n.replace(o,e.replace)}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}(0,d.watch)(f,e=>{r().debounce(()=>{replaceVariables(e,{type:'script',script_id:getScriptId()})},500,{leading:!1,trailing:!0})()},{deep:!0});const k=e=>new Promise(t=>setTimeout(t,e));async function S(){try{const e=getVariables({type:'script',script_id:getScriptId()})||{},t=l.z.object({promptEntries:l.z.array(l.z.any()).optional(),promptSets:l.z.array(l.z.any()).optional()}).safeParse(e);if(t.success&&t.data.promptEntries){toastr.info('检测到旧版设置，正在迁移...');const n=c.parse({name:'默认配置',promptEntries:t.data.promptEntries});delete e.promptEntries,e.promptSets||(e.promptSets=[]),e.promptSets.push(n),e.activePromptSetId=n.id,toastr.success('设置迁移完成！')}if(e.promptSets&&0!==e.promptSets.length)for(const t of e.promptSets){if(!t.promptEntries.some(e=>e.is_chat_history)){const e=i.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});t.promptEntries.unshift(e),toastr.info(`为配置 "${t.name}" 补全了缺失的“聊天记录”条目。`)}}else{const t=i.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=c.parse({name:'默认配置',promptEntries:[t]});e.promptSets=[n],e.activePromptSetId=n.id}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null),f.value=u.parse(r().merge(u.parse({}),e))}catch(e){console.error('[AutoRunner] 加载或解析设置失败:',e),toastr.error('加载设置失败，将使用默认设置。'),f.value=u.parse({})}}async function C(){toastr.info('正在调用副AI...');const e=await getLastMessageId(),t=getChatMessages(`0-${e}`);if(!t||0===t.length)return toastr.error('无法获取聊天记录'),null;const n=[],o=t.filter(e=>'system'!==e.role).map(e=>{const t=N(e.message,f.value.contextRegexRules);return{role:e.role,content:t}});for(const e of h.value.promptEntries)e.is_chat_history?n.push(...o):e.enabled&&e.content&&n.push({role:e.role,content:e.content});const a={model:f.value.model,messages:n,temperature:f.value.temperature,top_p:f.value.top_p,top_k:f.value.top_k,max_tokens:f.value.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',a),toastr.info('完整的请求信息已打印到控制台 (F12)。');try{const e=await fetch(`${f.value.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${f.value.apiKey}`},body:JSON.stringify(a)});if(!e.ok)throw new Error(`副AI API 请求失败: ${e.statusText}`);const t=await e.json(),n=t.choices[0]?.message?.content;if(!n)throw new Error('副AI未返回有效内容');return toastr.success('副AI响应成功'),n}catch(e){return console.error('调用副AI时出错:',e),toastr.error(`调用副AI失败: ${e.message}`),null}}function I(e){b=e,toastr.info('“真·自动化”模式已'+(e?'开启':'关闭'))}async function R(){if(g<f.value.exemptionCount)return toastr.info(`豁免计数 (${g}) 小于豁免次数 (${f.value.exemptionCount})，跳过SSC和一键处理。`),g++,!0;const e=window.parent.aiOptimizer;if(!e||'function'!=typeof e.manualOptimize||'function'!=typeof e.optimizeText)return toastr.warning('未找到 AI Optimizer API，跳过优化步骤。'),toastr.info('执行“一键处理”...'),await eventEmit(getButtonEvent('一键处理')),await k(5e3),!0;try{toastr.info('自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`;let o;b?(toastr.info('[真·自动化] 自动确认步骤1。'),o=!0):o=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0});const a=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!o)return toastr.info('自动化流程已由用户在步骤1取消。'),!1;toastr.info('正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',s=await e.optimizeText(a,l,r);if(null===s)return toastr.info('优化被用户取消。'),!1;if(!s)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=s;const i=`\n                  <p><b>原始句子:</b></p>\n                  <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${a}</textarea>\n                  <p><b>优化后句子 (可编辑):</b></p>\n                  <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${s}</textarea>\n              `;let c;b?(toastr.info('[真·自动化] 自动确认步骤2。'),c=!0):c=await window.parent.SillyTavern.getContext().callGenericPopup(i,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0});const u=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return toastr.info('替换操作已由用户取消。'),!1;toastr.info('正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(a,u,e=>{e&&toastr.success('SSC 替换完成！'),t()})})}else toastr.info('在最后一条角色消息中未找到可优化的内容，跳过SSC优化。');return toastr.info('等待2秒以确保系统稳定...'),await k(2e3),await async function(){toastr.info('正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:o}=t,a=/<\/?br\b[^>]*>/gi;if(a.test(o)){const e=o.replace(a,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),toastr.success('“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),toastr.error('执行“一键处理”时发生错误。')}}(),await k(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),toastr.error(e.message,'自动化优化流程失败'),!1}}async function U(e=!1){if(m!==p.RUNNING||f.value.executedCount>=f.value.totalReplies&&(toastr.info('已达到总回复次数，全自动运行结束。'),1))return void T();e||await S();const t=(getChatMessages(-1)||[])[0];if(!t)return toastr.error('无法获取最后一条消息，自动化暂停。'),void(m=p.PAUSED);try{if('user'===t.role)toastr.info('检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{toastr.info('检测到AI消息，开始完整循环...');if(!await R())return toastr.warning('用户取消了操作，全自动运行已停止。'),void T();let e=null,t=0;for(;t<=f.value.maxRetries&&(e=await C(),!e);){if(t++,t>f.value.maxRetries)return toastr.error(`调用副AI已达到最大重试次数 (${f.value.maxRetries})，自动化已停止。`),void T();toastr.warning(`调用副AI失败，将在5秒后重试 (${t}/${f.value.maxRetries})`),await k(5e3)}if(!e)return toastr.error('未能从副AI获取回复，自动化已停止。'),void T();const n=N(e,f.value.subAiRegexRules);console.log('处理后的回复:',n),toastr.info('以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}await async function(){f.value.executedCount++}()}catch(e){console.error('自动化循环出错:',e),toastr.error(`自动化循环发生意外错误: ${e.message}，流程已终止。`),m=p.ERROR,T()}}function A(){m===p.RUNNING&&setTimeout(()=>U(!1),1e3)}function M(){m===p.RUNNING&&(toastr.warning('来自系统的停止信号，全自动运行已终止。'),T())}async function D(){m!==p.RUNNING&&(await k(1e3),await S(),toastr.success('全自动运行已启动！'),m=p.RUNNING,v=0,g=0,f.value.executedCount=0,eventOn(tavern_events.MESSAGE_RECEIVED,A),eventOn(tavern_events.GENERATION_STOPPED,M),U(!0))}async function T(){if(m===p.IDLE)return;toastr.info('全自动运行已停止。'),m=p.IDLE,b&&(b=!1,toastr.info('“真·自动化”模式已随运行停止而关闭。')),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,A),eventRemoveListener(tavern_events.GENERATION_STOPPED,M),triggerSlash('/stop'),toastr.info('正在对最后生成的消息执行最终处理...'),await k(1e3);const e=(getChatMessages(-1)||[])[0];if(e&&'assistant'===e.role){f.value.exemptionCount>0&&(g=f.value.exemptionCount);await R()?toastr.success('最终处理完成，脚本已彻底结束。'):toastr.warning('最终处理被用户取消，脚本已彻底结束。')}else toastr.info('没有需要最终处理的AI消息，脚本已结束。')}function P(){T(),eventRemoveListener(getButtonEvent('全自动运行'),D)}const B={class:'flex-container flexFlowColumn'},O=['onDragstart','onDrop'],L={class:'rule-header'},j=['onUpdate:modelValue'],G=['onUpdate:modelValue','readonly'],F={class:'buttons'},J=['onClick'],K=['onClick'],H={key:0,class:'rule-body'},q=['onUpdate:modelValue'],W=['onUpdate:modelValue'],Q=(0,d.defineComponent)({__name:'PromptEditor',props:{entries:{}},emits:['update:entries'],setup(e,{emit:t}){const n=e,o=t,a=(0,d.computed)(()=>n.entries.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function r(){o('update:entries',n.entries)}function l(){const e=i.parse({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'}),t=[...n.entries,e];o('update:entries',t)}let s=-1;return(t,i)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',B,[(0,d.createElementVNode)('div',null,[i[1]||(i[1]=(0,d.createElementVNode)('strong',null,'提示词设置',-1)),(0,d.createTextVNode)(' (总词符数: '+(0,d.toDisplayString)(a.value)+')',1)]),((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)(e.entries,(e,t)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',{key:e.id,class:(0,d.normalizeClass)(['rule-item',{'chat-history-placeholder':e.is_chat_history}]),draggable:'true',onDragstart:e=>function(e){s=e}(t),onDragover:i[0]||(i[0]=(0,d.withModifiers)(()=>{},['prevent'])),onDrop:e=>function(e){if(-1===s||s===e)return;const t=[...n.entries],[a]=t.splice(s,1);t.splice(e,0,a),s=-1,o('update:entries',t)}(t)},[(0,d.createElementVNode)('div',L,[i[3]||(i[3]=(0,d.createElementVNode)('span',{class:'drag-handle'},'☰',-1)),e.is_chat_history?(0,d.createCommentVNode)('v-if',!0):(0,d.withDirectives)(((0,d.openBlock)(),(0,d.createElementBlock)('input',{key:0,'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle',onChange:r},null,40,j)),[[d.vModelCheckbox,e.enabled]]),(0,d.withDirectives)((0,d.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',readonly:e.is_chat_history,placeholder:'条目名称',onInput:r},null,40,G),[[d.vModelText,e.name]]),(0,d.createElementVNode)('div',F,[e.is_chat_history?(0,d.createCommentVNode)('v-if',!0):((0,d.openBlock)(),(0,d.createElementBlock)('button',{key:0,class:'menu_button icon-button',onClick:t=>function(e){e.editing=!e.editing,r()}(e)},[(0,d.createElementVNode)('i',{class:(0,d.normalizeClass)(['fa-solid',e.editing?'fa-folder-open':'fa-folder'])},null,2)],8,J)),e.is_chat_history?(0,d.createCommentVNode)('v-if',!0):((0,d.openBlock)(),(0,d.createElementBlock)('button',{key:1,class:'menu_button icon-button',onClick:e=>function(e){const t=[...n.entries];t.splice(e,1),o('update:entries',t)}(t)},[...i[2]||(i[2]=[(0,d.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])],8,K))])]),e.editing&&!e.is_chat_history?((0,d.openBlock)(),(0,d.createElementBlock)('div',H,[(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.content=t,class:'text_pole',placeholder:'提示词内容...',onInput:r},null,40,q),[[d.vModelText,e.content]]),(0,d.withDirectives)((0,d.createElementVNode)('select',{'onUpdate:modelValue':t=>e.role=t,class:'text_pole',onChange:r},[...i[4]||(i[4]=[(0,d.createElementVNode)('option',null,'user',-1),(0,d.createElementVNode)('option',null,'system',-1),(0,d.createElementVNode)('option',null,'assistant',-1)])],40,W),[[d.vModelSelect,e.role]])])):(0,d.createCommentVNode)('v-if',!0)],42,O))),128)),(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:l},'添加提示词条目')]))}});o(427);var X=o(42);const Y=(0,X.A)(Q,[['__scopeId','data-v-1bbbb5ab']]),Z={class:'inline-drawer'},ee={class:'inline-drawer-content'},te={class:'flex-container flexFlowColumn'},ne={class:'checkbox_label',for:'auto_runner_enabled'},oe={class:'flex-container flexFlowColumn'},ae={class:'set-manager'},re=['value'],le={class:'set-buttons'},se={class:'set-manager',style:{'margin-top':'10px'}},ie={class:'flex-container flexFlowColumn'},ce={class:'rule-header'},ue=['onUpdate:modelValue'],de=['onUpdate:modelValue'],pe=['onClick'],me={class:'rule-body'},fe=['onUpdate:modelValue'],ve=['onUpdate:modelValue'],ge={class:'flex-container flexFlowColumn'},be={class:'rule-header'},he=['onUpdate:modelValue'],xe=['onUpdate:modelValue'],_e=['onClick'],Ee={class:'rule-body'},we=['onUpdate:modelValue'],ye=['onUpdate:modelValue'],Ve={class:'flex-container flexFlowColumn'},Ne={key:0,value:''},ke=['value'],Se={for:'auto_runner_temperature'},Ce={for:'auto_runner_top_p'},Ie={for:'auto_runner_top_k'},Re={for:'auto_runner_max_tokens'},Ue={class:'flex-container flexFlowColumn'},Ae={id:'auto_runner_executed_count',class:'text_pole'},ze=(0,d.defineComponent)({__name:'app',setup(e){const t=(0,d.ref)([]);(0,d.watch)(()=>f.value.enabled,(e,t)=>{!0===e&&!1===t?(f.value.executedCount=0,eventOn(getButtonEvent('全自动运行'),()=>{m===p.RUNNING?T():D()}),S(),initializeGlobal('AutoRunnerCore',{toggleTrulyAutomatedMode:I})):!1===e&&!0===t&&P()}),(0,d.onMounted)(()=>{f.value.model&&!t.value.includes(f.value.model)&&t.value.push(f.value.model)});const n=e=>{if(h.value){const t=f.value.promptSets.find(e=>e.id===h.value.id);t&&(t.promptEntries=e)}},o=e=>{const t=s.parse({});'context'===e?f.value.contextRegexRules.push(t):f.value.subAiRegexRules.push(t)},a=(e,t)=>{'context'===e?f.value.contextRegexRules.splice(t,1):f.value.subAiRegexRules.splice(t,1)},l=async()=>{if(f.value.apiUrl)try{const e=await fetch(`${f.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=(await e.json()).data.map(e=>e.id);t.value=r().union(t.value,n),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',Z,[r[43]||(r[43]=(0,d.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,d.createElementVNode)('b',null,'自动化运行脚本设置'),(0,d.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,d.createElementVNode)('div',ee,[(0,d.createElementVNode)('div',te,[(0,d.createElementVNode)('label',ne,[(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>(0,d.unref)(f).enabled=e),type:'checkbox'},null,512),[[d.vModelCheckbox,(0,d.unref)(f).enabled]]),r[19]||(r[19]=(0,d.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),r[37]||(r[37]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createCommentVNode)(' 配置集管理 '),(0,d.createElementVNode)('div',oe,[r[23]||(r[23]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'提示词配置集')],-1)),(0,d.createElementVNode)('div',ae,[(0,d.withDirectives)((0,d.createElementVNode)('select',{'onUpdate:modelValue':r[1]||(r[1]=e=>(0,d.unref)(f).activePromptSetId=e),class:'text_pole set-select'},[((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)((0,d.unref)(f).promptSets,e=>((0,d.openBlock)(),(0,d.createElementBlock)('option',{key:e.id,value:e.id},(0,d.toDisplayString)(e.name),9,re))),128))],512),[[d.vModelSelect,(0,d.unref)(f).activePromptSetId]]),(0,d.createElementVNode)('div',le,[(0,d.createElementVNode)('button',{class:'menu_button icon-button',title:'新建配置',onClick:r[2]||(r[2]=(...e)=>(0,d.unref)(x)&&(0,d.unref)(x)(...e))},[...r[20]||(r[20]=[(0,d.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])]),(0,d.createElementVNode)('button',{class:'menu_button icon-button',title:'重命名当前配置',onClick:r[3]||(r[3]=(...e)=>(0,d.unref)(E)&&(0,d.unref)(E)(...e))},[...r[21]||(r[21]=[(0,d.createElementVNode)('i',{class:'fa-solid fa-pen-to-square'},null,-1)])]),(0,d.createElementVNode)('button',{class:'menu_button icon-button danger',title:'删除当前配置',onClick:r[4]||(r[4]=(...e)=>(0,d.unref)(w)&&(0,d.unref)(w)(...e))},[...r[22]||(r[22]=[(0,d.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])])])]),(0,d.createElementVNode)('div',se,[(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[5]||(r[5]=(...e)=>(0,d.unref)(V)&&(0,d.unref)(V)(...e))},'导入配置'),(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[6]||(r[6]=(...e)=>(0,d.unref)(y)&&(0,d.unref)(y)(...e))},'导出当前配置')])]),r[38]||(r[38]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createVNode)(Y,{entries:(0,d.unref)(h).promptEntries,'onUpdate:entries':n},null,8,['entries']),r[39]||(r[39]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createCommentVNode)(' 新的上下文正则编辑器 '),(0,d.createElementVNode)('div',ie,[r[24]||(r[24]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'上下文正则处理')],-1)),r[25]||(r[25]=(0,d.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)((0,d.unref)(f).contextRegexRules,(e,t)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,d.createElementVNode)('div',ce,[(0,d.withDirectives)((0,d.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,ue),[[d.vModelCheckbox,e.enabled]]),(0,d.withDirectives)((0,d.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,de),[[d.vModelText,e.name]]),(0,d.createElementVNode)('button',{class:'menu_button',onClick:e=>a('context',t)},'删除',8,pe)]),(0,d.createElementVNode)('div',me,[(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,fe),[[d.vModelText,e.find]]),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,ve),[[d.vModelText,e.replace]])])]))),128)),(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[7]||(r[7]=e=>o('context'))},'添加上下文规则')]),r[40]||(r[40]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createCommentVNode)(' 新的副AI输出正则编辑器 '),(0,d.createElementVNode)('div',ge,[r[26]||(r[26]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'副AI输出正则处理')],-1)),r[27]||(r[27]=(0,d.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)((0,d.unref)(f).subAiRegexRules,(e,t)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,d.createElementVNode)('div',be,[(0,d.withDirectives)((0,d.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,he),[[d.vModelCheckbox,e.enabled]]),(0,d.withDirectives)((0,d.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,xe),[[d.vModelText,e.name]]),(0,d.createElementVNode)('button',{class:'menu_button',onClick:e=>a('subAi',t)},'删除',8,_e)]),(0,d.createElementVNode)('div',Ee,[(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,we),[[d.vModelText,e.find]]),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,ye),[[d.vModelText,e.replace]])])]))),128)),(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[8]||(r[8]=e=>o('subAi'))},'添加副AI输出规则')]),r[41]||(r[41]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',Ve,[r[28]||(r[28]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'API 调用设置')],-1)),r[29]||(r[29]=(0,d.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[9]||(r[9]=e=>(0,d.unref)(f).apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[d.vModelText,(0,d.unref)(f).apiUrl]]),r[30]||(r[30]=(0,d.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[10]||(r[10]=e=>(0,d.unref)(f).apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[d.vModelText,(0,d.unref)(f).apiKey]]),(0,d.createElementVNode)('div',{class:'flex-container'},[(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:l},'获取模型')]),r[31]||(r[31]=(0,d.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,d.withDirectives)((0,d.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[11]||(r[11]=e=>(0,d.unref)(f).model=e),class:'text_pole'},[(0,d.unref)(f).model?(0,d.createCommentVNode)('v-if',!0):((0,d.openBlock)(),(0,d.createElementBlock)('option',Ne,'请先获取模型')),((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)(t.value,e=>((0,d.openBlock)(),(0,d.createElementBlock)('option',{key:e,value:e},(0,d.toDisplayString)(e),9,ke))),128))],512),[[d.vModelSelect,(0,d.unref)(f).model]]),(0,d.createElementVNode)('label',Se,'Temperature: '+(0,d.toDisplayString)((0,d.unref)(f).temperature),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[12]||(r[12]=e=>(0,d.unref)(f).temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[d.vModelText,(0,d.unref)(f).temperature,void 0,{number:!0}]]),(0,d.createElementVNode)('label',Ce,'Top P: '+(0,d.toDisplayString)((0,d.unref)(f).top_p),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[13]||(r[13]=e=>(0,d.unref)(f).top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[d.vModelText,(0,d.unref)(f).top_p,void 0,{number:!0}]]),(0,d.createElementVNode)('label',Ie,'Top K: '+(0,d.toDisplayString)((0,d.unref)(f).top_k),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[14]||(r[14]=e=>(0,d.unref)(f).top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[d.vModelText,(0,d.unref)(f).top_k,void 0,{number:!0}]]),(0,d.createElementVNode)('label',Re,'Max Tokens: '+(0,d.toDisplayString)((0,d.unref)(f).max_tokens),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[15]||(r[15]=e=>(0,d.unref)(f).max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[d.vModelText,(0,d.unref)(f).max_tokens,void 0,{number:!0}]])]),r[42]||(r[42]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',Ue,[r[32]||(r[32]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'自动化设置')],-1)),r[33]||(r[33]=(0,d.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[16]||(r[16]=e=>(0,d.unref)(f).totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[d.vModelText,(0,d.unref)(f).totalReplies,void 0,{number:!0}]]),r[34]||(r[34]=(0,d.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':r[17]||(r[17]=e=>(0,d.unref)(f).maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[d.vModelText,(0,d.unref)(f).maxRetries,void 0,{number:!0}]]),r[35]||(r[35]=(0,d.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':r[18]||(r[18]=e=>(0,d.unref)(f).exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[d.vModelText,(0,d.unref)(f).exemptionCount,void 0,{number:!0}]]),r[36]||(r[36]=(0,d.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,d.createElementVNode)('div',Ae,(0,d.toDisplayString)((0,d.unref)(f).executedCount),1)])])]))}});o(205);const Me=(0,X.A)(ze,[['__scopeId','data-v-237f90f4']]),De=(0,d.createApp)(Me);function Te(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),De.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function Pe(){De.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{Te()}),$(window).on('pagehide',()=>{Pe(),P()});