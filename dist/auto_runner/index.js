import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,a]of t)n[e]=a;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',a=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),a&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),a&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,a,r,l){'string'==typeof e&&(e=[[null,e,void 0]]);var o={};if(a)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(o[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);a&&o[d[0]]||(void 0!==l&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=l),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),r&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=r):d[4]=''.concat(r)),t.push(d))}},t}},62:(e,t,n)=>{var a=n(540);a.__esModule&&(a=a.default),'string'==typeof a&&(a=[[e.id,a,'']]),a.locals&&(e.exports=a.locals);(0,n(424).A)('1b5327b2',a,!1,{ssrId:!0})},93:e=>{e.exports=function(e){return e[1]}},424:(e,t,n)=>{function a(e,t){for(var n=[],a={},r=0;r<t.length;r++){var l=t[r],o=l[0],i={id:e+':'+r,css:l[1],media:l[2],sourceMap:l[3]};a[o]?a[o].parts.push(i):n.push(a[o]={id:o,parts:[i]})}return n}n.d(t,{A:()=>v});var r='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!r)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var l={},o=r&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,n,r){c=n,u=r||{};var o=a(e,t);return f(o),function(t){for(var n=[],r=0;r<o.length;r++){var i=o[r];(s=l[i.id]).refs--,n.push(s)}t?f(o=a(e,t)):o=[];for(r=0;r<n.length;r++){var s;if(0===(s=n[r]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete l[s.id]}}}}function f(e){for(var t=0;t<e.length;t++){var n=e[t],a=l[n.id];if(a){a.refs++;for(var r=0;r<a.parts.length;r++)a.parts[r](n.parts[r]);for(;r<n.parts.length;r++)a.parts.push(h(n.parts[r]));a.parts.length>n.parts.length&&(a.parts.length=n.parts.length)}else{var o=[];for(r=0;r<n.parts.length;r++)o.push(h(n.parts[r]));l[n.id]={id:n.id,refs:1,parts:o}}}}function g(){var e=document.createElement('style');return e.type='text/css',o.appendChild(e),e}function h(e){var t,n,a=document.querySelector('style['+p+'~="'+e.id+'"]');if(a){if(c)return d;a.parentNode.removeChild(a)}if(m){var r=s++;a=i||(i=g()),t=V.bind(null,a,r,!1),n=V.bind(null,a,r,!0)}else a=g(),t=y.bind(null,a),n=function(){a.parentNode.removeChild(a)};return t(e),function(a){if(a){if(a.css===e.css&&a.media===e.media&&a.sourceMap===e.sourceMap)return;t(e=a)}else n()}}var x,b=(x=[],function(e,t){return x[e]=t,x.filter(Boolean).join('\n')});function V(e,t,n,a){var r=n?'':a.css;if(e.styleSheet)e.styleSheet.cssText=b(t,r);else{var l=document.createTextNode(r),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(l,o[t]):e.appendChild(l)}}function y(e,t){var n=t.css,a=t.media,r=t.sourceMap;if(a&&e.setAttribute('media',a),u.ssrId&&e.setAttribute(p,t.id),r&&(n+='\n/*# sourceURL='+r.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},540:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var a=n(93),r=n.n(a),l=n(54),o=n.n(l)()(r());o.push([e.id,'.wide-button[data-v-9fdf88e0]{width:100%}label[data-v-9fdf88e0]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-9fdf88e0]{border:none;border-top:1px solid var(--bg2);margin:15px 0}input[type=range][data-v-9fdf88e0]{width:100%}','']);const i=o}},n={};function a(e){var r=n[e];if(void 0!==r)return r.exports;var l=n[e]={id:e,exports:{}};return t[e](l,l.exports,a),l.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const r=_;var l=a.n(r);const o=z,i=o.z.object({enabled:o.z.boolean().default(!1),prompt:o.z.preprocess(e=>e??'',o.z.string()),apiUrl:o.z.string().default(''),apiKey:o.z.string().default(''),model:o.z.string().default(''),temperature:o.z.number().min(0).max(2).default(.7),top_p:o.z.number().min(0).max(1).default(1),top_k:o.z.number().min(0).default(40),max_tokens:o.z.coerce.number().min(1).default(1024),totalReplies:o.z.coerce.number().min(1).default(10),remainingReplies:o.z.coerce.number().min(0).default(0),regex:o.z.string().default(String.raw`<StatusPlaceHolderImpl\/>
\s*<!--[\s\S]*?-->\s*
(<disclaimer>.*?<\/disclaimer>)|(<guifan>.*?<\/guifan>)|
\`\`\`start|<content>|<\/content>|\`\`\`end|<done>|\`<done>\`|
(<!--\s*consider\s*:\s*(.*?)\s*-->)|(.*?<\/think(ing)?>(\n)?)|(<think(ing)?>[\s\S]*?<\/think(ing)?>(\n)?)
/<UpdateVariable>[\s\S]*?</UpdateVariable>/gm`),subAiRegex:o.z.string().default(''),subAiRegexReplacement:o.z.preprocess(e=>e??'',o.z.string())});let s=!1;async function c(e){setTimeout(async()=>{await new Promise(e=>setTimeout(e,100));const t=i.parse(getVariables({type:'script',script_id:getScriptId()})||{}),n=getChatMessages(e)[0];if(console.log('[诊断] 获取到的消息对象:',n),t.enabled&&n&&'assistant'===n.role&&!(t.remainingReplies<=0)){s=!0,toastr.info(`自动执行: ${t.totalReplies-t.remainingReplies+1}/${t.totalReplies}`);try{const e=await substitudeMacros('{{char}}'),n=await substitudeMacros('{{user}}'),a=await getLastMessageId(),r=getChatMessages(`0-${a}`).filter(t=>t.name===n||t.name===e),o=new RegExp(t.regex,'gm'),i=`${r.map(e=>{const t=e.message.replace(o,'');return`${e.name}: ${t}`}).join('\n')}\n\n${t.prompt}`;console.log('发送给副AI的最终提示词:',i);const s=await generate({user_input:i,custom_api:{apiurl:t.apiUrl,key:t.apiKey,model:t.model,temperature:t.temperature,max_tokens:t.max_tokens},should_stream:!1});if(!s||''===s.trim())throw new Error('副AI没有返回有效指令。');let c=s;if(t.subAiRegex)try{const e=new RegExp(t.subAiRegex,'gm');c=c.replace(e,t.subAiRegexReplacement)}catch(e){const t=e;console.error('副AI正则处理出错:',t),toastr.error(`副AI正则处理错误: ${t.message}`)}$('#send_textarea').val(c),$('#send_but').trigger('click'),t.remainingReplies--,await replaceVariables(l().cloneDeep(t),{type:'script',script_id:getScriptId()})}catch(e){const t=e;console.error('自动化脚本运行出错:',t),toastr.error(`脚本错误: ${t.message}`)}finally{s=!1;const e=i.parse(getVariables({type:'script',script_id:getScriptId()})||{});e.remainingReplies<=0&&e.enabled&&(toastr.info('自动化任务完成。'),e.enabled=!1,await replaceVariables(l().cloneDeep(e),{type:'script',script_id:getScriptId()}))}}},0)}const d=Vue,u={class:'inline-drawer'},p={class:'inline-drawer-content'},m={class:'flex-container flexFlowColumn'},v={class:'checkbox_label',for:'auto_runner_enabled'},f={class:'flex-container flexFlowColumn'},g={class:'flex-container flexFlowColumn'},h={class:'flex-container flexFlowColumn'},x={class:'flex-container flexFlowColumn'},b={key:0,value:''},V=['value'],y={for:'auto_runner_temperature'},E={for:'auto_runner_top_p'},N={for:'auto_runner_top_k'},w={for:'auto_runner_max_tokens'},R={class:'flex-container flexFlowColumn'},k={class:'text_pole'},S=(0,d.defineComponent)({__name:'app',setup(e){const t=(0,d.ref)(i.parse({})),n=(0,d.ref)([]);(0,d.onMounted)(async()=>{try{const e=getVariables({type:'script',script_id:getScriptId()})||{},a=i.parse({}),r=l().merge(a,e);t.value=i.parse(r),t.value.model&&n.value.push(t.value.model)}catch(e){console.error('加载设置失败:',e),t.value=i.parse({})}}),(0,d.watch)(t,async e=>{try{const t=i.parse(e);await replaceVariables(l().cloneDeep(t),{type:'script',script_id:getScriptId()})}catch(e){const t=e;console.error('自动保存设置失败:',t)}},{deep:!0}),(0,d.watch)(()=>t.value.enabled,(e,n)=>{!0===e&&!1===n&&(t.value.remainingReplies=t.value.totalReplies)});const a=async()=>{if(t.value.apiUrl)try{const e=await fetch(`${t.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const a=(await e.json()).data.map(e=>e.id);n.value=l().union(n.value,a),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,d.openBlock)(),(0,d.createElementBlock)('div',u,[r[29]||(r[29]=(0,d.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,d.createElementVNode)('b',null,'自动化运行脚本设置'),(0,d.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,d.createElementVNode)('div',p,[(0,d.createElementVNode)('div',m,[(0,d.createElementVNode)('label',v,[(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>t.value.enabled=e),type:'checkbox'},null,512),[[d.vModelCheckbox,t.value.enabled]]),r[13]||(r[13]=(0,d.createElementVNode)('span',null,'启用脚本',-1))])]),r[24]||(r[24]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',f,[r[14]||(r[14]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'提示词设置')],-1)),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':r[1]||(r[1]=e=>t.value.prompt=e),class:'text_pole',placeholder:'输入给副AI的指令...'},null,512),[[d.vModelText,t.value.prompt]])]),r[25]||(r[25]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',g,[r[15]||(r[15]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'上下文正则处理')],-1)),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':r[2]||(r[2]=e=>t.value.regex=e),class:'text_pole',placeholder:'输入正则表达式...'},null,512),[[d.vModelText,t.value.regex]])]),r[26]||(r[26]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',h,[r[16]||(r[16]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'副AI输出正则处理')],-1)),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':r[3]||(r[3]=e=>t.value.subAiRegex=e),class:'text_pole',placeholder:'输入正则表达式...'},null,512),[[d.vModelText,t.value.subAiRegex]]),(0,d.withDirectives)((0,d.createElementVNode)('textarea',{'onUpdate:modelValue':r[4]||(r[4]=e=>t.value.subAiRegexReplacement=e),class:'text_pole',placeholder:'输入替换内容...'},null,512),[[d.vModelText,t.value.subAiRegexReplacement]])]),r[27]||(r[27]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',x,[r[17]||(r[17]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'API 调用设置')],-1)),r[18]||(r[18]=(0,d.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[5]||(r[5]=e=>t.value.apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[d.vModelText,t.value.apiUrl]]),r[19]||(r[19]=(0,d.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[6]||(r[6]=e=>t.value.apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[d.vModelText,t.value.apiKey]]),(0,d.createElementVNode)('div',{class:'flex-container'},[(0,d.createElementVNode)('button',{class:'menu_button wide-button',onClick:a},'获取模型')]),r[20]||(r[20]=(0,d.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,d.withDirectives)((0,d.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[7]||(r[7]=e=>t.value.model=e),class:'text_pole'},[t.value.model?(0,d.createCommentVNode)('v-if',!0):((0,d.openBlock)(),(0,d.createElementBlock)('option',b,'请先获取模型')),((0,d.openBlock)(!0),(0,d.createElementBlock)(d.Fragment,null,(0,d.renderList)(n.value,e=>((0,d.openBlock)(),(0,d.createElementBlock)('option',{key:e,value:e},(0,d.toDisplayString)(e),9,V))),128))],512),[[d.vModelSelect,t.value.model]]),(0,d.createElementVNode)('label',y,'Temperature: '+(0,d.toDisplayString)(t.value.temperature),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[8]||(r[8]=e=>t.value.temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[d.vModelText,t.value.temperature,void 0,{number:!0}]]),(0,d.createElementVNode)('label',E,'Top P: '+(0,d.toDisplayString)(t.value.top_p),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[9]||(r[9]=e=>t.value.top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[d.vModelText,t.value.top_p,void 0,{number:!0}]]),(0,d.createElementVNode)('label',N,'Top K: '+(0,d.toDisplayString)(t.value.top_k),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[10]||(r[10]=e=>t.value.top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[d.vModelText,t.value.top_k,void 0,{number:!0}]]),(0,d.createElementVNode)('label',w,'Max Tokens: '+(0,d.toDisplayString)(t.value.max_tokens),1),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[11]||(r[11]=e=>t.value.max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[d.vModelText,t.value.max_tokens,void 0,{number:!0}]])]),r[28]||(r[28]=(0,d.createElementVNode)('hr',null,null,-1)),(0,d.createElementVNode)('div',R,[r[21]||(r[21]=(0,d.createElementVNode)('div',null,[(0,d.createElementVNode)('strong',null,'自动化设置')],-1)),r[22]||(r[22]=(0,d.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,d.withDirectives)((0,d.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[12]||(r[12]=e=>t.value.totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[d.vModelText,t.value.totalReplies,void 0,{number:!0}]]),r[23]||(r[23]=(0,d.createElementVNode)('label',null,'自动执行次数',-1)),(0,d.createElementVNode)('div',k,(0,d.toDisplayString)(t.value.totalReplies-t.value.remainingReplies)+'/'+(0,d.toDisplayString)(t.value.totalReplies),1)])])]))}});a(62);const A=(0,a(42).A)(S,[['__scopeId','data-v-9fdf88e0']]),M=(0,d.createApp)(A);function D(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),M.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function I(){M.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{D(),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,c),console.log('自动化运行脚本已启动并监听事件。')}),$(window).on('pagehide',()=>{I()});