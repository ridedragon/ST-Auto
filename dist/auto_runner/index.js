import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const r=e.__vccOpts||e;for(const[e,n]of t)r[e]=n;return r}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var r='',n=void 0!==t[5];return t[4]&&(r+='@supports ('.concat(t[4],') {')),t[2]&&(r+='@media '.concat(t[2],' {')),n&&(r+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),r+=e(t),n&&(r+='}'),t[2]&&(r+='}'),t[4]&&(r+='}'),r}).join('')},t.i=function(e,r,n,o,a){'string'==typeof e&&(e=[[null,e,void 0]]);var s={};if(n)for(var i=0;i<this.length;i++){var d=this[i][0];null!=d&&(s[d]=!0)}for(var c=0;c<e.length;c++){var l=[].concat(e[c]);n&&s[l[0]]||(void 0!==a&&(void 0===l[5]||(l[1]='@layer'.concat(l[5].length>0?' '.concat(l[5]):'',' {').concat(l[1],'}')),l[5]=a),r&&(l[2]?(l[1]='@media '.concat(l[2],' {').concat(l[1],'}'),l[2]=r):l[2]=r),o&&(l[4]?(l[1]='@supports ('.concat(l[4],') {').concat(l[1],'}'),l[4]=o):l[4]=''.concat(o)),t.push(l))}},t}},93:e=>{e.exports=function(e){return e[1]}},238:(e,t,r)=>{r.r(t),r.d(t,{default:()=>i});var n=r(93),o=r.n(n),a=r(54),s=r.n(a)()(o());s.push([e.id,'.auto-runner-settings[data-v-15dd349a]{background-color:#f8f9fa;border:1px solid #dee2e6;border-radius:.25rem;padding:1.25rem;margin-bottom:1rem}.card-header[data-v-15dd349a]{background-color:#e9ecef;padding:.75rem 1.25rem;margin-bottom:0;border-bottom:1px solid #dee2e6}.form-group[data-v-15dd349a]{margin-bottom:1rem}.input-group[data-v-15dd349a]{display:flex}.form-control[data-v-15dd349a]{flex-grow:1}.input-group-append[data-v-15dd349a]{margin-left:-1px}.btn[data-v-15dd349a]{display:inline-block;font-weight:400;color:#212529;text-align:center;vertical-align:middle;cursor:pointer;-webkit-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;line-height:1.5;border-radius:.25rem}.btn-primary[data-v-15dd349a]{color:#fff;background-color:#007bff;border-color:#007bff}.btn[data-v-15dd349a]:disabled{opacity:.65}\n','']);const i=s},424:(e,t,r)=>{function n(e,t){for(var r=[],n={},o=0;o<t.length;o++){var a=t[o],s=a[0],i={id:e+':'+o,css:a[1],media:a[2],sourceMap:a[3]};n[s]?n[s].parts.push(i):r.push(n[s]={id:s,parts:[i]})}return r}r.d(t,{A:()=>m});var o='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!o)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var a={},s=o&&(document.head||document.getElementsByTagName('head')[0]),i=null,d=0,c=!1,l=function(){},u=null,p='data-vue-ssr-id',f='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(e,t,r,o){c=r,u=o||{};var s=n(e,t);return g(s),function(t){for(var r=[],o=0;o<s.length;o++){var i=s[o];(d=a[i.id]).refs--,r.push(d)}t?g(s=n(e,t)):s=[];for(o=0;o<r.length;o++){var d;if(0===(d=r[o]).refs){for(var c=0;c<d.parts.length;c++)d.parts[c]();delete a[d.id]}}}}function g(e){for(var t=0;t<e.length;t++){var r=e[t],n=a[r.id];if(n){n.refs++;for(var o=0;o<n.parts.length;o++)n.parts[o](r.parts[o]);for(;o<r.parts.length;o++)n.parts.push(h(r.parts[o]));n.parts.length>r.parts.length&&(n.parts.length=r.parts.length)}else{var s=[];for(o=0;o<r.parts.length;o++)s.push(h(r.parts[o]));a[r.id]={id:r.id,refs:1,parts:s}}}}function v(){var e=document.createElement('style');return e.type='text/css',s.appendChild(e),e}function h(e){var t,r,n=document.querySelector('style['+p+'~="'+e.id+'"]');if(n){if(c)return l;n.parentNode.removeChild(n)}if(f){var o=d++;n=i||(i=v()),t=x.bind(null,n,o,!1),r=x.bind(null,n,o,!0)}else n=v(),t=S.bind(null,n),r=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else r()}}var b,y=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function x(e,t,r,n){var o=r?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,o);else{var a=document.createTextNode(o),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(a,s[t]):e.appendChild(a)}}function S(e,t){var r=t.css,n=t.media,o=t.sourceMap;if(n&&e.setAttribute('media',n),u.ssrId&&e.setAttribute(p,t.id),o&&(r+='\n/*# sourceURL='+o.sources[0]+' */',r+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+' */'),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}},463:(e,t,r)=>{var n=r(238);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,r(424).A)('1ea67a1a',n,!1,{ssrId:!0})}},r={};function n(e){var o=r[e];if(void 0!==o)return o.exports;var a=r[e]={id:e,exports:{}};return t[e](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};let o,a=!1;async function s(e){if(a)return;await new Promise(e=>setTimeout(e,100));const t=getChatMessages(-1)[0];if(o.selectedModel&&t&&('user'===t.role||'assistant'===t.role)){a=!0,toastr.info('自动执行中...');try{const e=await getLastMessageId(),t=getChatMessages(`0-${e}`).map(e=>{const t=function(e,t){if(!t)return e;try{const r=new RegExp(t,'gm');return e.replace(r,'')}catch(t){return console.error('正则表达式错误:',t),toastr.error('正则表达式无效，请检查。'),e}}(e.message,o.regex);return`${e.name}: ${t}`}).join('\n'),r=await generate({user_input:t,custom_api:{model:o.selectedModel},should_stream:!1});if(!r||''===r.trim())throw new Error('副AI没有返回有效指令。');$('#send_textarea').val(r),$('#send_but').trigger('click')}catch(e){const t=e;console.error('自动化脚本运行出错:',t),toastr.error(`脚本错误: ${t.message}`)}finally{a=!1,toastr.info('自动执行完毕。')}}}const i=Vue,d=z,c=_;var l=n.n(c);const u=['<StatusPlaceHolderImpl\\/>','\\s*\x3c!--[\\s\\S]*?--\x3e\\s*','(<disclaimer>.*?<\\/disclaimer>)','(<guifan>.*?<\\/guifan>)','```start','<content>','<\\/content>','```end','<done>','`<done>`','(\x3c!--\\s*consider\\s*:[\\s\\S]*?--\x3e)','(.*?<\\/think(ing)?>(\\n)?)','(<think(ing)?>[\\s\\S]*?<\\/think(ing)?>(\\n)?)','<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>'].join('|'),p=d.z.object({selectedModel:d.z.string().default(''),regex:d.z.string().default(u)});const f={class:'auto-runner-settings card'},m={class:'card-body'},g={class:'form-group'},v={class:'input-group'},h={disabled:'',value:''},b=['value'],y={class:'input-group-append'},x=['disabled'],S={class:'form-group'},E=(0,i.defineComponent)({__name:'app',props:{settings:{}},setup(e){const t=e,r=(0,i.ref)(l().cloneDeep(t.settings)),n=(0,i.ref)([]),o=(0,i.ref)(!1);async function a(){o.value=!0,toastr.info('正在获取模型列表...','[AutoRunner]');try{const e=SillyTavern.completion_providers,t=[];for(const r of e)r.models&&t.push(...r.models);n.value=l().uniq(t).sort(),n.value.length>0?toastr.success('模型列表获取成功！','[AutoRunner]'):toastr.warning('未找到可用模型。请检查您的SillyTavern API设置。','[AutoRunner]')}catch(e){console.error('获取模型列表时出错:',e),toastr.error(`获取模型失败: ${e.message}`,'[AutoRunner] 错误')}finally{o.value=!1}}return(0,i.watch)(r,e=>{var t;t=e,replaceVariables(l().cloneDeep(t),{type:'script',script_id:getScriptId()})},{deep:!0}),(0,i.onMounted)(()=>{a()}),(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',f,[t[6]||(t[6]=(0,i.createElementVNode)('div',{class:'card-header'},[(0,i.createElementVNode)('h4',{class:'mb-0'},'Auto Runner 脚本设置')],-1)),(0,i.createElementVNode)('div',m,[(0,i.createElementVNode)('div',g,[t[2]||(t[2]=(0,i.createElementVNode)('label',{for:'model'},'副AI模型',-1)),(0,i.createElementVNode)('div',v,[(0,i.withDirectives)((0,i.createElementVNode)('select',{id:'model','onUpdate:modelValue':t[0]||(t[0]=e=>r.value.selectedModel=e),class:'form-control'},[(0,i.createElementVNode)('option',h,(0,i.toDisplayString)(o.value?'加载中...':'请选择一个模型'),1),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(n.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e,value:e},(0,i.toDisplayString)(e),9,b))),128))],512),[[i.vModelSelect,r.value.selectedModel]]),(0,i.createElementVNode)('div',y,[(0,i.createElementVNode)('button',{onClick:a,class:'btn btn-primary',disabled:o.value},(0,i.toDisplayString)(o.value?'正在获取...':'刷新模型'),9,x)])]),t[3]||(t[3]=(0,i.createElementVNode)('small',{class:'form-text text-muted'},'选择一个模型后，脚本将自动在每条消息后调用它。',-1))]),(0,i.createElementVNode)('div',S,[t[4]||(t[4]=(0,i.createElementVNode)('label',{for:'regex'},'内容处理正则表达式',-1)),(0,i.withDirectives)((0,i.createElementVNode)('textarea',{id:'regex','onUpdate:modelValue':t[1]||(t[1]=e=>r.value.regex=e),class:'form-control',rows:'8'},null,512),[[i.vModelText,r.value.regex]]),t[5]||(t[5]=(0,i.createElementVNode)('small',{class:'form-text text-muted'},' 在将对话历史发送给副AI之前，将使用此正则表达式（全局、多行模式）清除每条消息的内容。 ',-1))])])]))}});n(463);const N=(0,n(42).A)(E,[['__scopeId','data-v-15dd349a']]);let A;function w(t){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const r=$('#extensions_settings2');if(0===r.length)return void console.error('[AutoRunner] 找不到注入点 #extensions_settings2，无法创建界面。');const n=$('<div>').attr('script_id',getScriptId());r.append(n),A=(0,i.createApp)(N,{settings:t}),A.use(e()).mount(n[0])}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function V(){A&&A.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}const M=toastr;var k=n.n(M);$(()=>{const e=function(){const e=getVariables({type:'script',script_id:getScriptId()}),t=p.safeParse(e??{});return t.success?t.data:(console.error('Failed to parse settings, using default settings.',t.error),p.parse({}))}();w(e),function(e){o=e,eventOn(tavern_events.MESSAGE_SENT,s),eventOn(tavern_events.GENERATION_ENDED,s),console.log('自动化运行脚本已启动并监听事件。')}(e),k().success('Auto脚本加载成功')}),$(window).on('pagehide',()=>{V()});