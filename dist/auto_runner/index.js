import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,r]of t)n[e]=r;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',r=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),r&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),r&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,r,o,a){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(r)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);r&&l[u[0]]||(void 0!==a&&(void 0===u[5]||(u[1]='@layer'.concat(u[5].length>0?' '.concat(u[5]):'',' {').concat(u[1],'}')),u[5]=a),n&&(u[2]?(u[1]='@media '.concat(u[2],' {').concat(u[1],'}'),u[2]=n):u[2]=n),o&&(u[4]?(u[1]='@supports ('.concat(u[4],') {').concat(u[1],'}'),u[4]=o):u[4]=''.concat(o)),t.push(u))}},t}},93:e=>{e.exports=function(e){return e[1]}},122:(e,t,n)=>{var r=n(556);r.__esModule&&(r=r.default),'string'==typeof r&&(r=[[e.id,r,'']]),r.locals&&(e.exports=r.locals);(0,n(424).A)('20c78dee',r,!1,{ssrId:!0})},424:(e,t,n)=>{function r(e,t){for(var n=[],r={},o=0;o<t.length;o++){var a=t[o],l=a[0],i={id:e+':'+o,css:a[1],media:a[2],sourceMap:a[3]};r[l]?r[l].parts.push(i):n.push(r[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>v});var o='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!o)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var a={},l=o&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,u=function(){},d=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,n,o){c=n,d=o||{};var l=r(e,t);return f(l),function(t){for(var n=[],o=0;o<l.length;o++){var i=l[o];(s=a[i.id]).refs--,n.push(s)}t?f(l=r(e,t)):l=[];for(o=0;o<n.length;o++){var s;if(0===(s=n[o]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete a[s.id]}}}}function f(e){for(var t=0;t<e.length;t++){var n=e[t],r=a[n.id];if(r){r.refs++;for(var o=0;o<r.parts.length;o++)r.parts[o](n.parts[o]);for(;o<n.parts.length;o++)r.parts.push(h(n.parts[o]));r.parts.length>n.parts.length&&(r.parts.length=n.parts.length)}else{var l=[];for(o=0;o<n.parts.length;o++)l.push(h(n.parts[o]));a[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function h(e){var t,n,r=document.querySelector('style['+p+'~="'+e.id+'"]');if(r){if(c)return u;r.parentNode.removeChild(r)}if(m){var o=s++;r=i||(i=g()),t=y.bind(null,r,o,!1),n=y.bind(null,r,o,!0)}else r=g(),t=V.bind(null,r),n=function(){r.parentNode.removeChild(r)};return t(e),function(r){if(r){if(r.css===e.css&&r.media===e.media&&r.sourceMap===e.sourceMap)return;t(e=r)}else n()}}var x,b=(x=[],function(e,t){return x[e]=t,x.filter(Boolean).join('\n')});function y(e,t,n,r){var o=n?'':r.css;if(e.styleSheet)e.styleSheet.cssText=b(t,o);else{var a=document.createTextNode(o),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(a,l[t]):e.appendChild(a)}}function V(e,t){var n=t.css,r=t.media,o=t.sourceMap;if(r&&e.setAttribute('media',r),d.ssrId&&e.setAttribute(p,t.id),o&&(n+='\n/*# sourceURL='+o.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},556:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var r=n(93),o=n.n(r),a=n(54),l=n.n(a)()(o());l.push([e.id,'.wide-button[data-v-0f61328f]{width:100%}label[data-v-0f61328f]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-0f61328f]{border:none;border-top:1px solid var(--bg2);margin:15px 0}input[type=range][data-v-0f61328f]{width:100%}','']);const i=l}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={id:e,exports:{}};return t[e](a,a.exports,r),a.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const o=_;var a=r.n(o);const l=z,i=l.z.object({enabled:l.z.boolean().default(!1),prompt:l.z.preprocess(e=>e??'',l.z.string()),apiUrl:l.z.preprocess(e=>e??'',l.z.string()),apiKey:l.z.preprocess(e=>e??'',l.z.string()),model:l.z.preprocess(e=>e??'',l.z.string()),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(40),max_tokens:l.z.coerce.number().min(1).default(1024),totalReplies:l.z.coerce.number().min(1).default(10),remainingReplies:l.z.coerce.number().min(0).default(0),regex:l.z.string().default(String.raw`<StatusPlaceHolderImpl\/>
\s*<!--[\s\S]*?-->\s*
(<disclaimer>.*?<\/disclaimer>)|(<guifan>.*?<\/guifan>)|
\`\`\`start|<content>|<\/content>|\`\`\`end|<done>|\`<done>\`|
(<!--\s*consider\s*:\s*(.*?)\s*-->)|(.*?<\/think(ing)?>(\n)?)|(<think(ing)?>[\s\S]*?<\/think(ing)?>(\n)?)
/<UpdateVariable>[\s\S]*?</UpdateVariable>/gm`),subAiRegex:l.z.preprocess(e=>e||String.raw`^.*?<\/think(ing)?>\s*`,l.z.string()),subAiRegexReplacement:l.z.preprocess(e=>e??'',l.z.string()),maxRetries:l.z.coerce.number().min(0).default(3)});function s(){try{const e=getVariables({type:'script',script_id:getScriptId()})||{},t=i.parse({}),n=a().merge(t,e);return i.parse(n)}catch(e){return console.error('加载设置失败:',e),toastr.error('加载脚本设置失败，请检查配置。'),null}}let c=!1;async function u(){toastr.info('[自动运行] 检测到主AI消息，开始后处理...');try{toastr.info('[自动运行] 步骤 1/3: 触发“全自动优化(SSC)”...'),await eventEmit(getButtonEvent('全自动优化(SSC)')),await new Promise(e=>setTimeout(e,1500)),toastr.info('[自动运行] “全自动优化(SSC)”完成。'),toastr.info('[自动运行] 步骤 2/3: 触发“一键处理”...'),await eventEmit(getButtonEvent('一键处理')),toastr.info('[自动运行] “一键处理”事件已发送，开始轮询最终消息...');let e=null;const t=10,n=500;for(let r=0;r<t;r++){const t=(getChatMessages(-1)||[])[0];if(t&&'assistant'===t.role){e=t,toastr.info(`[自动运行] 在第 ${r+1} 次尝试中成功获取到AI最终消息。`);break}await new Promise(e=>setTimeout(e,n))}if(!e)return toastr.warning('[自动运行] 在“一键处理”后轮询超时，未能获取到有效的AI消息，流程中止。'),null;toastr.info('[自动运行] “一键处理”及消息轮询完成。'),toastr.info('[自动运行] 步骤 3/3: 调用副AI API...');const r=s();if(!r)return toastr.error('无法获取设置，无法调用副AI。'),p(),null;const o=await async function(e,t){const{apiUrl:n,apiKey:r,model:o,temperature:a,top_p:l,top_k:i,max_tokens:s,prompt:c,regex:u,subAiRegex:d,subAiRegexReplacement:p}=t;if(!n||!o)throw new Error('API地址或模型未设置');const m=(getChatMessages(-1)||[]).map(e=>`${e.role}: ${e.message}`).join('\n');let v=m;if(u)try{const e=new RegExp(u,'g');v=m.replace(e,'')}catch(e){console.error('上下文正则表达式无效:',e)}const f=`${c}\n\n以下是当前的对话历史:\n${v}\n\n主AI刚刚的回复是:\n${e}\n\n请根据以上信息，作为'副AI'进行回复:`,g=await fetch(`${n}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r}`},body:JSON.stringify({model:o,messages:[{role:'user',content:f}],temperature:a,top_p:l,top_k:i,max_tokens:s})});if(!g.ok)throw new Error(`副AI API调用失败: ${g.statusText}`);const h=await g.json();let x=h.choices[0]?.message?.content||'';if(d)try{const e=new RegExp(d,'g');x=x.replace(e,p||'')}catch(e){console.error('副AI输出正则表达式无效:',e)}return x.trim()}(e.message,r);return'string'==typeof o&&o.length>0?(toastr.info('[自动运行] 副AI已成功回复。'),o):(toastr.warning('[自动运行] 副AI (副AI) 没有返回有效的新提示词，流程中止。'),null)}catch(e){return console.error('[自动运行] handleMainAiReply 出错:',e),toastr.error('后处理流程发生错误，请查看控制台。'),null}}function d(){c||(c=!0,toastr.success('全自动运行已启动！','自动化控制'),async function(){const e=s();if(!e)return toastr.error('无法获取设置，自动化流程无法启动。'),void p();let t=e.remainingReplies,n='继续';for(;c&&t>0;)try{toastr.info(`[自动运行] 第 ${e.totalReplies-t+1} / ${e.totalReplies} 轮开始...`),toastr.info('[自动运行] 步骤 1: 副AI发送消息触发主AI...'),await triggerSlash(`/send as_user=true await=true "${n.replace(/"/g,'\\"')}"`);const r=await u();if(null===r){toastr.warning('[自动运行] 后处理失败，流程中断。'),p();break}n=r,t--;const o=s();o&&(o.remainingReplies=t,await replaceVariables(o,{type:'script',script_id:getScriptId()})),toastr.success(`[自动运行] 第 ${e.totalReplies-t} 轮完成。`)}catch(e){console.error('[全自动运行] 循环出错:',e),toastr.error('自动化运行时发生错误，请查看控制台。流程已终止。'),p();break}t<=0&&toastr.success('所有自动化任务已完成！'),p()}())}function p(){c&&(c=!1,toastr.info('全自动运行已停止。','自动化控制'),triggerSlash('/stop'))}function m(){console.log('Auto runner stopped via legacy stop()')}const v=Vue,f={class:'inline-drawer'},g={class:'inline-drawer-content'},h={class:'flex-container flexFlowColumn'},x={class:'checkbox_label',for:'auto_runner_enabled'},b={class:'flex-container flexFlowColumn'},y={class:'flex-container flexFlowColumn'},V={class:'flex-container flexFlowColumn'},E={class:'flex-container flexFlowColumn'},w={key:0,value:''},N=['value'],A={for:'auto_runner_temperature'},S={for:'auto_runner_top_p'},k={for:'auto_runner_top_k'},R={for:'auto_runner_max_tokens'},I={class:'flex-container flexFlowColumn'},C={class:'text_pole'},T={class:'flex-container flexFlowColumn'},M=(0,v.defineComponent)({__name:'app',setup(e){const t=(0,v.ref)(!1),n=(0,v.ref)(i.parse({})),r=(0,v.ref)([]);(0,v.onMounted)(async()=>{try{const e=getVariables({type:'script',script_id:getScriptId()})||{},t=i.parse({}),o=a().merge(t,e);n.value=i.parse(o),n.value.model&&r.value.push(n.value.model)}catch(e){console.error('加载设置失败:',e),n.value=i.parse({})}}),(0,v.watch)(n,async e=>{try{const t=i.parse(e);await replaceVariables(a().cloneDeep(t),{type:'script',script_id:getScriptId()})}catch(e){const t=e;console.error('自动保存设置失败:',t)}},{deep:!0}),(0,v.watch)(()=>n.value.enabled,(e,t)=>{!0===e&&!1===t?(n.value.remainingReplies=n.value.totalReplies,console.log('Auto runner started via legacy start()'),toastr.info('自动化脚本已启动。')):!1===e&&!0===t&&(m(),toastr.info('自动化脚本已停止。'))});const o=async()=>{if(n.value.apiUrl)try{const e=await fetch(`${n.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=(await e.json()).data.map(e=>e.id);r.value=a().union(r.value,t),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')},l=()=>{t.value?(p(),t.value=!1):(d(),t.value=!0)};return(e,a)=>((0,v.openBlock)(),(0,v.createElementBlock)('div',f,[a[33]||(a[33]=(0,v.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,v.createElementVNode)('b',null,'自动化运行脚本设置'),(0,v.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,v.createElementVNode)('div',g,[(0,v.createElementVNode)('div',h,[(0,v.createElementVNode)('label',x,[(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':a[0]||(a[0]=e=>n.value.enabled=e),type:'checkbox'},null,512),[[v.vModelCheckbox,n.value.enabled]]),a[14]||(a[14]=(0,v.createElementVNode)('span',null,'启用脚本',-1))])]),a[27]||(a[27]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',b,[a[15]||(a[15]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'提示词设置')],-1)),(0,v.withDirectives)((0,v.createElementVNode)('textarea',{'onUpdate:modelValue':a[1]||(a[1]=e=>n.value.prompt=e),class:'text_pole',placeholder:'输入给副AI的指令...'},null,512),[[v.vModelText,n.value.prompt]])]),a[28]||(a[28]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',y,[a[16]||(a[16]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'上下文正则处理')],-1)),(0,v.withDirectives)((0,v.createElementVNode)('textarea',{'onUpdate:modelValue':a[2]||(a[2]=e=>n.value.regex=e),class:'text_pole',placeholder:'输入正则表达式...'},null,512),[[v.vModelText,n.value.regex]])]),a[29]||(a[29]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',V,[a[17]||(a[17]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'副AI输出正则处理')],-1)),(0,v.withDirectives)((0,v.createElementVNode)('textarea',{'onUpdate:modelValue':a[3]||(a[3]=e=>n.value.subAiRegex=e),class:'text_pole',placeholder:'输入正则表达式...'},null,512),[[v.vModelText,n.value.subAiRegex]]),(0,v.withDirectives)((0,v.createElementVNode)('textarea',{'onUpdate:modelValue':a[4]||(a[4]=e=>n.value.subAiRegexReplacement=e),class:'text_pole',placeholder:'输入替换内容...'},null,512),[[v.vModelText,n.value.subAiRegexReplacement]])]),a[30]||(a[30]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',E,[a[18]||(a[18]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'API 调用设置')],-1)),a[19]||(a[19]=(0,v.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':a[5]||(a[5]=e=>n.value.apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[v.vModelText,n.value.apiUrl]]),a[20]||(a[20]=(0,v.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':a[6]||(a[6]=e=>n.value.apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[v.vModelText,n.value.apiKey]]),(0,v.createElementVNode)('div',{class:'flex-container'},[(0,v.createElementVNode)('button',{class:'menu_button wide-button',onClick:o},'获取模型')]),a[21]||(a[21]=(0,v.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,v.withDirectives)((0,v.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':a[7]||(a[7]=e=>n.value.model=e),class:'text_pole'},[n.value.model?(0,v.createCommentVNode)('v-if',!0):((0,v.openBlock)(),(0,v.createElementBlock)('option',w,'请先获取模型')),((0,v.openBlock)(!0),(0,v.createElementBlock)(v.Fragment,null,(0,v.renderList)(r.value,e=>((0,v.openBlock)(),(0,v.createElementBlock)('option',{key:e,value:e},(0,v.toDisplayString)(e),9,N))),128))],512),[[v.vModelSelect,n.value.model]]),(0,v.createElementVNode)('label',A,'Temperature: '+(0,v.toDisplayString)(n.value.temperature),1),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':a[8]||(a[8]=e=>n.value.temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[v.vModelText,n.value.temperature,void 0,{number:!0}]]),(0,v.createElementVNode)('label',S,'Top P: '+(0,v.toDisplayString)(n.value.top_p),1),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':a[9]||(a[9]=e=>n.value.top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[v.vModelText,n.value.top_p,void 0,{number:!0}]]),(0,v.createElementVNode)('label',k,'Top K: '+(0,v.toDisplayString)(n.value.top_k),1),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':a[10]||(a[10]=e=>n.value.top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[v.vModelText,n.value.top_k,void 0,{number:!0}]]),(0,v.createElementVNode)('label',R,'Max Tokens: '+(0,v.toDisplayString)(n.value.max_tokens),1),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':a[11]||(a[11]=e=>n.value.max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[v.vModelText,n.value.max_tokens,void 0,{number:!0}]])]),a[31]||(a[31]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',I,[a[22]||(a[22]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'自动化设置')],-1)),a[23]||(a[23]=(0,v.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':a[12]||(a[12]=e=>n.value.totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[v.vModelText,n.value.totalReplies,void 0,{number:!0}]]),a[24]||(a[24]=(0,v.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,v.withDirectives)((0,v.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':a[13]||(a[13]=e=>n.value.maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[v.vModelText,n.value.maxRetries,void 0,{number:!0}]]),a[25]||(a[25]=(0,v.createElementVNode)('label',null,'自动执行次数',-1)),(0,v.createElementVNode)('div',C,(0,v.toDisplayString)(n.value.totalReplies-n.value.remainingReplies)+'/'+(0,v.toDisplayString)(n.value.totalReplies),1)]),a[32]||(a[32]=(0,v.createElementVNode)('hr',null,null,-1)),(0,v.createElementVNode)('div',T,[a[26]||(a[26]=(0,v.createElementVNode)('div',null,[(0,v.createElementVNode)('strong',null,'手动循环控制')],-1)),(0,v.createElementVNode)('button',{class:(0,v.normalizeClass)(['menu_button',t.value?'primary-button':'secondary-button']),onClick:l},(0,v.toDisplayString)(t.value?'停止全自动运行':'启动全自动运行'),3)])])]))}});r(122);const U=(0,r(42).A)(M,[['__scopeId','data-v-0f61328f']]),D=(0,v.createApp)(U);function P(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),D.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function B(){D.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{P()}),$(window).on('pagehide',()=>{B(),m()});