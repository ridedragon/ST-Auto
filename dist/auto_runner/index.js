import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={17:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.rule-header[data-v-cdccef4e]{display:flex;align-items:center;gap:10px}.drag-handle[data-v-cdccef4e]{cursor:grab}.rule-name[data-v-cdccef4e]{flex-grow:1;min-width:50px}.buttons[data-v-cdccef4e]{display:flex;flex-shrink:0;gap:5px}.icon-button[data-v-cdccef4e]{padding:4px 8px;line-height:1}.rule-body select[data-v-cdccef4e]{margin-top:5px}.wide-button[data-v-cdccef4e]{width:100%;margin-top:10px}.chat-history-placeholder[data-v-cdccef4e]{background-color:var(--bg3) !important}','']);const i=l},37:(e,t,n)=>{var o=n(707);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('7131cbe3',o,!1,{ssrId:!0})},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&l[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),a&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=a):d[4]=''.concat(a)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},359:(e,t,n)=>{var o=n(17);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('ab4dc516',o,!1,{ssrId:!0})},424:(e,t,n)=>{function o(e,t){for(var n=[],o={},a=0;a<t.length;a++){var r=t[a],l=r[0],i={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(i):n.push(o[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>f});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=a&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,a){c=n,u=a||{};var l=o(e,t);return v(l),function(t){for(var n=[],a=0;a<l.length;a++){var i=l[a];(s=r[i.id]).refs--,n.push(s)}t?v(l=o(e,t)):l=[];for(a=0;a<n.length;a++){var s;if(0===(s=n[a]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete r[s.id]}}}}function v(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var a=0;a<o.parts.length;a++)o.parts[a](n.parts[a]);for(;a<n.parts.length;a++)o.parts.push(h(n.parts[a]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var l=[];for(a=0;a<n.parts.length;a++)l.push(h(n.parts[a]));r[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function h(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return d;o.parentNode.removeChild(o)}if(m){var a=s++;o=i||(i=g()),t=E.bind(null,o,a,!1),n=E.bind(null,o,a,!0)}else o=g(),t=y.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function E(e,t,n,o){var a=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,a);else{var r=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function y(e,t){var n=t.css,o=t.media,a=t.sourceMap;if(o&&e.setAttribute('media',o),u.ssrId&&e.setAttribute(p,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},441:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},707:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.section-wrapper[data-v-c8611f1c]{border-top:1px solid var(--bg2)}.section-wrapper[data-v-c8611f1c]:first-of-type{border-top:none}.section-wrapper[data-v-c8611f1c]:last-of-type{border-bottom:1px solid var(--bg2);margin-bottom:1em}.section-toggle-checkbox[data-v-c8611f1c]{display:none}.section-header[data-v-c8611f1c]{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:.25em 4px;border-radius:4px;transition:background-color .2s ease}.section-header[data-v-c8611f1c]:hover{background-color:var(--bg2-trans)}.section-header strong[data-v-c8611f1c]{font-size:1.1em}.section-header i[data-v-c8611f1c]{transition:transform .3s ease}.section-content[data-v-c8611f1c]{display:none;padding:10px 4px 0}.section-toggle-checkbox:checked+.section-header i[data-v-c8611f1c]{transform:rotate(90deg)}.section-toggle-checkbox:checked~.section-content[data-v-c8611f1c]{display:block}.wide-button[data-v-c8611f1c]{width:100%;margin-top:10px}label[data-v-c8611f1c]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-c8611f1c]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-c8611f1c]{width:100%}.description[data-v-c8611f1c]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-c8611f1c]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-c8611f1c]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-c8611f1c]{transform:scale(1.2)}.rule-name[data-v-c8611f1c]{flex-grow:1}.rule-body[data-v-c8611f1c]{display:flex;flex-direction:column;gap:5px}.set-manager[data-v-c8611f1c]{display:flex;gap:10px;align-items:center}.set-select[data-v-c8611f1c]{flex-grow:1}.set-buttons[data-v-c8611f1c]{display:flex;gap:5px}.icon-button[data-v-c8611f1c]{padding:6px 10px;line-height:1;flex-shrink:0}','']);const i=l}},n={};function o(e){var a=n[e];if(void 0!==a)return a.exports;var r=n[e]={id:e,exports:{}};return t[e](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const a=_;var r=o.n(a);const l=z,i=l.z.object({id:l.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:l.z.string().default(''),find:l.z.string().default(''),replace:l.z.string().default(''),enabled:l.z.boolean().default(!0)}),s=l.z.object({id:l.z.string().default(()=>`prompt_${Date.now()}_${Math.random()}`),name:l.z.string(),content:l.z.string(),enabled:l.z.boolean(),editing:l.z.boolean(),role:l.z.enum(['user','system','assistant']),is_chat_history:l.z.boolean().optional().default(!1)}),c=l.z.object({id:l.z.string().default(()=>`set_${Date.now()}_${Math.random()}`),name:l.z.string(),promptEntries:l.z.array(s)}),d=l.z.object({enabled:l.z.boolean().default(!0),promptSets:l.z.array(c).default([]),activePromptSetId:l.z.string().nullable().default(null),apiUrl:l.z.preprocess(e=>e??'',l.z.string()),apiKey:l.z.preprocess(e=>e??'',l.z.string()),model:l.z.preprocess(e=>e??'',l.z.string()),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(40),max_tokens:l.z.coerce.number().min(1).default(1024),totalReplies:l.z.coerce.number().min(1).default(10),executedCount:l.z.coerce.number().min(0).default(0),contextRegexRules:l.z.array(i).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:l.z.array(i).default([]),maxRetries:l.z.coerce.number().min(0).default(3),exemptionCount:l.z.coerce.number().min(0).default(0),conciseNotifications:l.z.boolean().default(!1)}),u=Vue,p=Symbol('ABORT_SIGNAL'),m=(0,u.ref)(!1);let f=null;var v;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(v||(v={}));let g=v.IDLE;const h=(0,u.ref)(d.parse({}));let b=0,x=0,E=!1;const y=(0,u.computed)(()=>{const e=h.value.promptSets.find(e=>e.id===h.value.activePromptSetId);return e||c.parse({name:'（无有效配置）',promptEntries:[]})});function N(){const e=window.prompt('请输入新配置的名称：',`新配置 ${h.value.promptSets.length+1}`);if(!e)return;const t=s.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=c.parse({name:e,promptEntries:[t]});h.value.promptSets.push(n),h.value.activePromptSetId=n.id,I('success',`已创建新配置 "${e}"`)}function w(){const e=y.value;if(!e||'（无有效配置）'===e.name)return;const t=window.prompt('请输入新的名称：',e.name);if(t&&t!==e.name){const n=h.value.promptSets.find(t=>t.id===e.id);n&&(n.name=t,I('success','配置已重命名'))}}function V(){if(h.value.promptSets.length<=1)return void I('error','无法删除最后一个配置集',!0);const e=y.value;if(!e||!window.confirm(`确定要删除配置 "${e.name}" 吗？此操作不可撤销。`))return;const t=h.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(h.value.promptSets.splice(t,1),h.value.activePromptSetId=h.value.promptSets[Math.max(0,t-1)]?.id||null,I('success',`配置 "${e.name}" 已删除`))}function k(){const e=y.value;if(!e)return;const t=JSON.stringify(e,null,2),n=new Blob([t],{type:'application/json'}),o=URL.createObjectURL(n),a=document.createElement('a');a.href=o,a.download=`${e.name}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),I('success','当前配置已导出')}function S(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n),t=Array.isArray(e)?e:[e];let o=0;for(const e of t){const t=c.safeParse(e);if(t.success){if(h.value.promptSets.some(e=>e.name===t.data.name)){if(!window.confirm(`已存在名为 "${t.data.name}" 的配置。要覆盖它吗？`))continue;const e=h.value.promptSets.findIndex(e=>e.name===t.data.name);e>-1&&h.value.promptSets.splice(e,1)}t.data.id=`set_${Date.now()}_${Math.random()}`,h.value.promptSets.push(t.data),o++}else console.error('导入的数据格式无效:',t.error),I('error','一个或多个导入的配置格式无效，详情请查看控制台。',!0)}o>0&&I('success',`成功导入 ${o} 个配置。`)}catch(e){console.error('导入失败:',e),I('error','导入文件失败，请确保是有效的JSON文件。',!0)}},e.click()}const C=r().debounce(e=>{const t=JSON.parse(JSON.stringify(e));replaceVariables(t,{type:'script',script_id:getScriptId()}),console.log('[AutoRunner] Settings saved.')},500);function I(e,t,n=!1){h.value.conciseNotifications&&!n||toastr[e](t)}function A(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let o;if(t){const e=t[1],n=t[2];o=new RegExp(e,n)}else o=new RegExp(e.find,'g');n=n.replace(o,e.replace)}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}(0,u.watch)(h,e=>{C(e)},{deep:!0});const R=e=>new Promise(t=>setTimeout(t,e));async function U(){const e=getVariables({type:'script',script_id:getScriptId()})||{},t=JSON.parse(JSON.stringify(e)),n=d.safeParse(t);if(n.success){const e=n.data;let t=!1;if(0===e.promptSets.length){const n=s.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),o=c.parse({name:'默认配置',promptEntries:[n]});e.promptSets.push(o),e.activePromptSetId=o.id,t=!0,I('info','未找到任何配置，已创建默认配置。')}else for(const n of e.promptSets)if(!n.promptEntries.some(e=>e.is_chat_history)){const e=s.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});n.promptEntries.unshift(e),t=!0,I('info',`为配置 "${n.name}" 补全了缺失的“聊天记录”条目。`)}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,t=!0),h.value=e,t&&(C.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}))}else{console.error('[AutoRunner] 加载或解析设置失败:',n.error),I('error','加载设置失败，将使用默认设置。',!0);const e=s.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),t=c.parse({name:'默认配置',promptEntries:[e]}),o=d.parse({promptSets:[t],activePromptSetId:t.id});h.value=o,C.cancel(),replaceVariables(JSON.parse(JSON.stringify(o)),{type:'script',script_id:getScriptId()})}}async function D(){toastr.info('正在向副AI发送消息...',void 0,{timeOut:0,extendedTimeOut:0,closeButton:!1,tapToDismiss:!1});m.value=!0,f=new AbortController;try{const e=await getLastMessageId(),t=getChatMessages(`0-${e}`);if(!t||0===t.length)return I('error','无法获取聊天记录',!0),null;const n=[],o=t.filter(e=>'system'!==e.role).map(e=>{const t=A(e.message,h.value.contextRegexRules);return{role:e.role,content:t}});for(const e of y.value.promptEntries)e.is_chat_history?n.push(...o):e.enabled&&e.content&&n.push({role:e.role,content:e.content});const a={model:h.value.model,messages:n,temperature:h.value.temperature,top_p:h.value.top_p,top_k:h.value.top_k,max_tokens:h.value.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',a),h.value.conciseNotifications||I('info','完整的请求信息已打印到控制台 (F12)。');const r=await fetch(`${h.value.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${h.value.apiKey}`},body:JSON.stringify(a),signal:f.signal});if(!r.ok)throw new Error(`副AI API 请求失败: ${r.statusText}`);const l=await r.json(),i=l.choices[0]?.message?.content;if(!i)throw new Error('副AI未返回有效内容');return I('success','副AI响应成功'),i}catch(e){return'AbortError'===e.name?(I('warning','已中止向副AI发送消息。',!0),p):(console.error('调用副AI时出错:',e),I('error',`调用副AI失败: ${e.message}`,!0),null)}finally{toastr.clear(),m.value=!1,f=null}}function P(){E=!E,I('info','“真·自动化”模式已'+(E?'开启':'关闭'),!0)}async function T(){if(x<h.value.exemptionCount)return I('info',`豁免计数 (${x}) 小于豁免次数 (${h.value.exemptionCount})，跳过SSC和一键处理。`),x++,!0;const e=window.parent.aiOptimizer;if(!e||'function'!=typeof e.manualOptimize||'function'!=typeof e.optimizeText)return I('warning','未找到 AI Optimizer API，跳过优化步骤。'),I('info','执行“一键处理”...'),await eventEmit(getButtonEvent('一键处理')),await R(5e3),!0;try{I('info','自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`;let o;E?(I('info','[真·自动化] 自动确认步骤1。'),o=!0):o=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0});const a=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!o)return I('info','自动化流程已由用户在步骤1取消。'),!1;I('info','正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',i=await e.optimizeText(a,l,r);if(null===i)return I('info','优化被用户取消。'),!1;if(!i)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=i;const s=`\n                  <p><b>原始句子:</b></p>\n                  <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${a}</textarea>\n                  <p><b>优化后句子 (可编辑):</b></p>\n                  <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${i}</textarea>\n              `;let c;E?(I('info','[真·自动化] 自动确认步骤2。'),c=!0):c=await window.parent.SillyTavern.getContext().callGenericPopup(s,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0});const d=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return I('info','替换操作已由用户取消。'),!1;I('info','正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(a,d,e=>{e&&I('success','SSC 替换完成！'),t()})})}else I('info','在最后一条角色消息中未找到可优化的内容，跳过SSC优化。');return I('info','等待2秒以确保系统稳定...'),await R(2e3),await async function(){I('info','正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:o}=t,a=/<\/?br\b[^>]*>/gi;if(a.test(o)){const e=o.replace(a,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),I('success','“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),I('error','执行“一键处理”时发生错误。',!0)}}(),await R(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),I('error',e.message,!0),!1}}async function M(e=!1){if(g!==v.RUNNING||h.value.executedCount>=h.value.totalReplies&&(I('info','已达到总回复次数，全自动运行结束。',!0),1))return void j();e||await U();const t=(getChatMessages(-1)||[])[0];if(!t)return I('error','无法获取最后一条消息，自动化暂停。',!0),void(g=v.PAUSED);try{if('user'===t.role)I('info','检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{I('info','检测到AI消息，开始完整循环...');if(!await T())return void j({skipFinalProcessing:!0,userCancelled:!0});let e=null,t=0;for(;t<=h.value.maxRetries;){const n=await D();if(n===p)return void j({skipFinalProcessing:!0,userCancelled:!0});if(n){e=n;break}if(t++,t>h.value.maxRetries)return I('error',`调用副AI已达到最大重试次数 (${h.value.maxRetries})，自动化已停止。`,!0),void j({skipFinalProcessing:!0});I('warning',`调用副AI失败，将在5秒后重试 (${t}/${h.value.maxRetries})`),await R(5e3)}if(!e)return;const n=A(e,h.value.subAiRegexRules);console.log('处理后的回复:',n),I('info','以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}await async function(){h.value.executedCount++}()}catch(e){console.error('自动化循环出错:',e),I('error',`自动化循环发生意外错误: ${e.message}，流程已终止。`,!0),g=v.ERROR,j({skipFinalProcessing:!0})}}function B(){g===v.RUNNING&&setTimeout(()=>M(!1),1e3)}function O(){g===v.RUNNING&&(h.value.conciseNotifications||I('warning','来自系统的停止信号，全自动运行已终止。'),j({skipFinalProcessing:!0}))}function L(){g===v.RUNNING?j():async function(){if(g===v.RUNNING)return;if(!h.value.enabled)return void I('warning','脚本未启用，请先勾选“启用脚本”。',!0);await R(1e3),await U(),I('success','全自动运行已启动！',!0),g=v.RUNNING,b=0,x=0,h.value.executedCount=0,eventOn(tavern_events.MESSAGE_RECEIVED,B),eventOn(tavern_events.GENERATION_STOPPED,O),M(!0)}()}async function j(e={}){if(g===v.IDLE)return;let t;if(t=e.userCancelled?'用户取消了操作，全自动运行已停止。':e.skipFinalProcessing?'全自动运行已因错误而终止。':'全自动运行已停止。',I('info',t,!0),g=v.IDLE,eventRemoveListener(tavern_events.MESSAGE_RECEIVED,B),eventRemoveListener(tavern_events.GENERATION_STOPPED,O),G(),triggerSlash('/stop'),e.skipFinalProcessing)return h.value.conciseNotifications||I('warning','因发生错误而跳过最终处理，脚本已彻底结束。'),void(E&&(E=!1,I('info','“真·自动化”模式已随运行停止而关闭。')));I('info','正在对最后生成的消息执行最终处理...'),await R(1e3);const n=(getChatMessages(-1)||[])[0];if(n&&'assistant'===n.role){h.value.exemptionCount>0&&(x=h.value.exemptionCount);await T()?I('success','最终处理完成，脚本已彻底结束。',!0):I('warning','最终处理被用户取消，脚本已彻底结束。',!0)}else I('info','没有需要最终处理的AI消息，脚本已结束。');E&&(E=!1,I('info','“真·自动化”模式已随运行停止而关闭。'))}function G(){f&&(f.abort(),console.log('[AutoRunner] Abort signal sent to sub AI call.'))}const F={class:'flex-container flexFlowColumn'},J=['onDragstart','onDrop'],K={class:'rule-header'},H=['onUpdate:modelValue'],q=['onUpdate:modelValue','readonly'],W={class:'buttons'},Q=['onClick'],X=['onClick'],Y={key:0,class:'rule-body'},Z=['onUpdate:modelValue'],ee=['onUpdate:modelValue'],te=(0,u.defineComponent)({__name:'PromptEditor',props:{entries:{}},emits:['update:entries'],setup(e,{emit:t}){const n=e,o=t,a=(0,u.computed)(()=>n.entries.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function r(){o('update:entries',n.entries)}function l(){const e=s.parse({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'}),t=[...n.entries,e];o('update:entries',t)}let i=-1;return(t,s)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',F,[(0,u.createElementVNode)('div',null,[s[1]||(s[1]=(0,u.createElementVNode)('strong',null,'提示词设置',-1)),(0,u.createTextVNode)(' (总词符数: '+(0,u.toDisplayString)(a.value)+')',1)]),((0,u.openBlock)(!0),(0,u.createElementBlock)(u.Fragment,null,(0,u.renderList)(e.entries,(e,t)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',{key:e.id,class:(0,u.normalizeClass)(['rule-item',{'chat-history-placeholder':e.is_chat_history}]),draggable:'true',onDragstart:e=>function(e){i=e}(t),onDragover:s[0]||(s[0]=(0,u.withModifiers)(()=>{},['prevent'])),onDrop:e=>function(e){if(-1===i||i===e)return;const t=[...n.entries],[a]=t.splice(i,1);t.splice(e,0,a),i=-1,o('update:entries',t)}(t)},[(0,u.createElementVNode)('div',K,[s[3]||(s[3]=(0,u.createElementVNode)('span',{class:'drag-handle'},'☰',-1)),e.is_chat_history?(0,u.createCommentVNode)('v-if',!0):(0,u.withDirectives)(((0,u.openBlock)(),(0,u.createElementBlock)('input',{key:0,'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle',onChange:r},null,40,H)),[[u.vModelCheckbox,e.enabled]]),(0,u.withDirectives)((0,u.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',readonly:e.is_chat_history,placeholder:'条目名称',onInput:r},null,40,q),[[u.vModelText,e.name]]),(0,u.createElementVNode)('div',W,[e.is_chat_history?(0,u.createCommentVNode)('v-if',!0):((0,u.openBlock)(),(0,u.createElementBlock)('button',{key:0,class:'menu_button icon-button',onClick:t=>function(e){e.editing=!e.editing,r()}(e)},[(0,u.createElementVNode)('i',{class:(0,u.normalizeClass)(['fa-solid',e.editing?'fa-folder-open':'fa-folder'])},null,2)],8,Q)),e.is_chat_history?(0,u.createCommentVNode)('v-if',!0):((0,u.openBlock)(),(0,u.createElementBlock)('button',{key:1,class:'menu_button icon-button',onClick:e=>function(e){const t=[...n.entries];t.splice(e,1),o('update:entries',t)}(t)},[...s[2]||(s[2]=[(0,u.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])],8,X))])]),e.editing&&!e.is_chat_history?((0,u.openBlock)(),(0,u.createElementBlock)('div',Y,[(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.content=t,class:'text_pole',placeholder:'提示词内容...',onInput:r},null,40,Z),[[u.vModelText,e.content]]),(0,u.withDirectives)((0,u.createElementVNode)('select',{'onUpdate:modelValue':t=>e.role=t,class:'text_pole',onChange:r},[...s[4]||(s[4]=[(0,u.createElementVNode)('option',null,'user',-1),(0,u.createElementVNode)('option',null,'system',-1),(0,u.createElementVNode)('option',null,'assistant',-1)])],40,ee),[[u.vModelSelect,e.role]])])):(0,u.createCommentVNode)('v-if',!0)],42,J))),128)),(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:l},'添加提示词条目')]))}});o(359);var ne=o(441);const oe=(0,ne.A)(te,[['__scopeId','data-v-cdccef4e']]),ae={class:'inline-drawer'},re={class:'inline-drawer-content'},le={class:'flex-container flexFlowColumn',style:{'padding-bottom':'0.5em'}},ie={class:'checkbox_label',for:'auto_runner_enabled'},se={class:'section-wrapper'},ce={class:'section-content'},de={class:'set-manager'},ue=['value'],pe={class:'set-buttons'},me={class:'set-manager',style:{'margin-top':'10px'}},fe={class:'section-wrapper'},ve={class:'section-content'},ge={class:'rule-header'},he=['onUpdate:modelValue'],be=['onUpdate:modelValue'],xe=['onClick'],_e={class:'rule-body'},Ee=['onUpdate:modelValue'],ye=['onUpdate:modelValue'],Ne={class:'section-wrapper'},we={class:'section-content'},Ve={class:'rule-header'},ke=['onUpdate:modelValue'],Se=['onUpdate:modelValue'],Ce=['onClick'],Ie={class:'rule-body'},Ae=['onUpdate:modelValue'],Re=['onUpdate:modelValue'],Ue={class:'section-wrapper'},De={class:'section-content flex-container flexFlowColumn'},Pe={key:0,value:''},Te=['value'],ze={for:'auto_runner_temperature'},Me={for:'auto_runner_top_p'},Be={for:'auto_runner_top_k'},$e={for:'auto_runner_max_tokens'},Oe={class:'section-wrapper'},Le={class:'section-content flex-container flexFlowColumn'},je={class:'checkbox_label',for:'auto_runner_concise_notifications'},Ge={id:'auto_runner_executed_count',class:'text_pole'},Fe=['disabled','title'],Je=(0,u.defineComponent)({__name:'app',setup(e){const t=(0,u.ref)([]);(0,u.watch)(()=>h.value.enabled,(e,t)=>{!1===e&&!0===t&&j()}),(0,u.onMounted)(()=>{h.value.model&&!t.value.includes(h.value.model)&&t.value.push(h.value.model)});const n=e=>{if(y.value){const t=h.value.promptSets.find(e=>e.id===y.value.id);t&&(t.promptEntries=e)}},o=e=>{const t=i.parse({});'context'===e?h.value.contextRegexRules.push(t):h.value.subAiRegexRules.push(t)},a=(e,t)=>{'context'===e?h.value.contextRegexRules.splice(t,1):h.value.subAiRegexRules.splice(t,1)},l=async()=>{if(h.value.apiUrl)try{const e=await fetch(`${h.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=(await e.json()).data.map(e=>e.id);t.value=r().union(t.value,n),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',ae,[r[47]||(r[47]=(0,u.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,u.createElementVNode)('b',null,'自动化运行脚本设置'),(0,u.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,u.createElementVNode)('div',re,[(0,u.createElementVNode)('div',le,[(0,u.createElementVNode)('label',ie,[(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>(0,u.unref)(h).enabled=e),type:'checkbox'},null,512),[[u.vModelCheckbox,(0,u.unref)(h).enabled]]),r[21]||(r[21]=(0,u.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),(0,u.createElementVNode)('div',se,[r[26]||(r[26]=(0,u.createElementVNode)('input',{type:'checkbox',id:'section-toggle-prompts',class:'section-toggle-checkbox'},null,-1)),r[27]||(r[27]=(0,u.createElementVNode)('label',{for:'section-toggle-prompts',class:'section-header'},[(0,u.createElementVNode)('strong',null,'提示词配置集'),(0,u.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,u.createElementVNode)('div',ce,[(0,u.createElementVNode)('div',de,[(0,u.withDirectives)((0,u.createElementVNode)('select',{'onUpdate:modelValue':r[1]||(r[1]=e=>(0,u.unref)(h).activePromptSetId=e),class:'text_pole set-select'},[((0,u.openBlock)(!0),(0,u.createElementBlock)(u.Fragment,null,(0,u.renderList)((0,u.unref)(h).promptSets,e=>((0,u.openBlock)(),(0,u.createElementBlock)('option',{key:e.id,value:e.id},(0,u.toDisplayString)(e.name),9,ue))),128))],512),[[u.vModelSelect,(0,u.unref)(h).activePromptSetId]]),(0,u.createElementVNode)('div',pe,[(0,u.createElementVNode)('button',{class:'menu_button icon-button',title:'新建配置',onClick:r[2]||(r[2]=(...e)=>(0,u.unref)(N)&&(0,u.unref)(N)(...e))},[...r[22]||(r[22]=[(0,u.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])]),(0,u.createElementVNode)('button',{class:'menu_button icon-button',title:'重命名当前配置',onClick:r[3]||(r[3]=(...e)=>(0,u.unref)(w)&&(0,u.unref)(w)(...e))},[...r[23]||(r[23]=[(0,u.createElementVNode)('i',{class:'fa-solid fa-pen-to-square'},null,-1)])]),(0,u.createElementVNode)('button',{class:'menu_button icon-button danger',title:'删除当前配置',onClick:r[4]||(r[4]=(...e)=>(0,u.unref)(V)&&(0,u.unref)(V)(...e))},[...r[24]||(r[24]=[(0,u.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])])])]),(0,u.createElementVNode)('div',me,[(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[5]||(r[5]=(...e)=>(0,u.unref)(S)&&(0,u.unref)(S)(...e))},'导入配置'),(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[6]||(r[6]=(...e)=>(0,u.unref)(k)&&(0,u.unref)(k)(...e))},'导出当前配置')]),r[25]||(r[25]=(0,u.createElementVNode)('hr',{style:{margin:'15px 0'}},null,-1)),(0,u.createVNode)(oe,{entries:(0,u.unref)(y).promptEntries,'onUpdate:entries':n},null,8,['entries'])])]),(0,u.createElementVNode)('div',fe,[r[29]||(r[29]=(0,u.createElementVNode)('input',{type:'checkbox',id:'section-toggle-context-regex',class:'section-toggle-checkbox'},null,-1)),r[30]||(r[30]=(0,u.createElementVNode)('label',{for:'section-toggle-context-regex',class:'section-header'},[(0,u.createElementVNode)('strong',null,'上下文正则处理'),(0,u.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,u.createElementVNode)('div',ve,[r[28]||(r[28]=(0,u.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,u.openBlock)(!0),(0,u.createElementBlock)(u.Fragment,null,(0,u.renderList)((0,u.unref)(h).contextRegexRules,(e,t)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,u.createElementVNode)('div',ge,[(0,u.withDirectives)((0,u.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,he),[[u.vModelCheckbox,e.enabled]]),(0,u.withDirectives)((0,u.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,be),[[u.vModelText,e.name]]),(0,u.createElementVNode)('button',{class:'menu_button',onClick:e=>a('context',t)},'删除',8,xe)]),(0,u.createElementVNode)('div',_e,[(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Ee),[[u.vModelText,e.find]]),(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,ye),[[u.vModelText,e.replace]])])]))),128)),(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[7]||(r[7]=e=>o('context'))},'添加上下文规则')])]),(0,u.createElementVNode)('div',Ne,[r[32]||(r[32]=(0,u.createElementVNode)('input',{type:'checkbox',id:'section-toggle-subai-regex',class:'section-toggle-checkbox'},null,-1)),r[33]||(r[33]=(0,u.createElementVNode)('label',{for:'section-toggle-subai-regex',class:'section-header'},[(0,u.createElementVNode)('strong',null,'副AI输出正则处理'),(0,u.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,u.createElementVNode)('div',we,[r[31]||(r[31]=(0,u.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,u.openBlock)(!0),(0,u.createElementBlock)(u.Fragment,null,(0,u.renderList)((0,u.unref)(h).subAiRegexRules,(e,t)=>((0,u.openBlock)(),(0,u.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,u.createElementVNode)('div',Ve,[(0,u.withDirectives)((0,u.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,ke),[[u.vModelCheckbox,e.enabled]]),(0,u.withDirectives)((0,u.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,Se),[[u.vModelText,e.name]]),(0,u.createElementVNode)('button',{class:'menu_button',onClick:e=>a('subAi',t)},'删除',8,Ce)]),(0,u.createElementVNode)('div',Ie,[(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Ae),[[u.vModelText,e.find]]),(0,u.withDirectives)((0,u.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,Re),[[u.vModelText,e.replace]])])]))),128)),(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[8]||(r[8]=e=>o('subAi'))},'添加副AI输出规则')])]),(0,u.createElementVNode)('div',Ue,[r[37]||(r[37]=(0,u.createElementVNode)('input',{type:'checkbox',id:'section-toggle-api',class:'section-toggle-checkbox'},null,-1)),r[38]||(r[38]=(0,u.createElementVNode)('label',{for:'section-toggle-api',class:'section-header'},[(0,u.createElementVNode)('strong',null,'API 调用设置'),(0,u.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,u.createElementVNode)('div',De,[r[34]||(r[34]=(0,u.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[9]||(r[9]=e=>(0,u.unref)(h).apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[u.vModelText,(0,u.unref)(h).apiUrl]]),r[35]||(r[35]=(0,u.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[10]||(r[10]=e=>(0,u.unref)(h).apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[u.vModelText,(0,u.unref)(h).apiKey]]),(0,u.createElementVNode)('div',{class:'flex-container'},[(0,u.createElementVNode)('button',{class:'menu_button wide-button',onClick:l},'获取模型')]),r[36]||(r[36]=(0,u.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,u.withDirectives)((0,u.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[11]||(r[11]=e=>(0,u.unref)(h).model=e),class:'text_pole'},[(0,u.unref)(h).model?(0,u.createCommentVNode)('v-if',!0):((0,u.openBlock)(),(0,u.createElementBlock)('option',Pe,'请先获取模型')),((0,u.openBlock)(!0),(0,u.createElementBlock)(u.Fragment,null,(0,u.renderList)(t.value,e=>((0,u.openBlock)(),(0,u.createElementBlock)('option',{key:e,value:e},(0,u.toDisplayString)(e),9,Te))),128))],512),[[u.vModelSelect,(0,u.unref)(h).model]]),(0,u.createElementVNode)('label',ze,'Temperature: '+(0,u.toDisplayString)((0,u.unref)(h).temperature),1),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[12]||(r[12]=e=>(0,u.unref)(h).temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[u.vModelText,(0,u.unref)(h).temperature,void 0,{number:!0}]]),(0,u.createElementVNode)('label',Me,'Top P: '+(0,u.toDisplayString)((0,u.unref)(h).top_p),1),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[13]||(r[13]=e=>(0,u.unref)(h).top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[u.vModelText,(0,u.unref)(h).top_p,void 0,{number:!0}]]),(0,u.createElementVNode)('label',Be,'Top K: '+(0,u.toDisplayString)((0,u.unref)(h).top_k),1),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[14]||(r[14]=e=>(0,u.unref)(h).top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[u.vModelText,(0,u.unref)(h).top_k,void 0,{number:!0}]]),(0,u.createElementVNode)('label',$e,'Max Tokens: '+(0,u.toDisplayString)((0,u.unref)(h).max_tokens),1),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[15]||(r[15]=e=>(0,u.unref)(h).max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[u.vModelText,(0,u.unref)(h).max_tokens,void 0,{number:!0}]])])]),(0,u.createElementVNode)('div',Oe,[r[45]||(r[45]=(0,u.createElementVNode)('input',{type:'checkbox',id:'section-toggle-automation',class:'section-toggle-checkbox'},null,-1)),r[46]||(r[46]=(0,u.createElementVNode)('label',{for:'section-toggle-automation',class:'section-header'},[(0,u.createElementVNode)('strong',null,'自动化设置'),(0,u.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,u.createElementVNode)('div',Le,[r[41]||(r[41]=(0,u.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[16]||(r[16]=e=>(0,u.unref)(h).totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[u.vModelText,(0,u.unref)(h).totalReplies,void 0,{number:!0}]]),r[42]||(r[42]=(0,u.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':r[17]||(r[17]=e=>(0,u.unref)(h).maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[u.vModelText,(0,u.unref)(h).maxRetries,void 0,{number:!0}]]),r[43]||(r[43]=(0,u.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':r[18]||(r[18]=e=>(0,u.unref)(h).exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[u.vModelText,(0,u.unref)(h).exemptionCount,void 0,{number:!0}]]),(0,u.createElementVNode)('label',je,[(0,u.withDirectives)((0,u.createElementVNode)('input',{id:'auto_runner_concise_notifications','onUpdate:modelValue':r[19]||(r[19]=e=>(0,u.unref)(h).conciseNotifications=e),type:'checkbox'},null,512),[[u.vModelCheckbox,(0,u.unref)(h).conciseNotifications]]),r[39]||(r[39]=(0,u.createElementVNode)('span',null,'简洁通知模式',-1))]),r[44]||(r[44]=(0,u.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,u.createElementVNode)('div',Ge,(0,u.toDisplayString)((0,u.unref)(h).executedCount),1),(0,u.createElementVNode)('button',{disabled:!(0,u.unref)(m),class:(0,u.normalizeClass)(['menu_button','wide-button',{danger:(0,u.unref)(m)}]),style:{'margin-top':'15px'},onClick:r[20]||(r[20]=(...e)=>(0,u.unref)(G)&&(0,u.unref)(G)(...e)),title:(0,u.unref)(m)?'点击以中止请求':'（无正在进行的请求）'},[r[40]||(r[40]=(0,u.createElementVNode)('i',{class:'fa-solid fa-stop'},null,-1)),(0,u.createTextVNode)(' '+(0,u.toDisplayString)(((0,u.unref)(m),'中断副 AI')),1)],10,Fe)])])])]))}});o(37);const Ke=(0,ne.A)(Je,[['__scopeId','data-v-c8611f1c']]),He=(0,u.createApp)(Ke);function qe(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),He.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function We(){He.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(async()=>{await U(),qe(),eventOn(getButtonEvent('全自动运行'),L),initializeGlobal('AutoRunnerCore',{toggleTrulyAutomatedMode:P,abortSubAICall:G})}),$(window).on('pagehide',()=>{We(),j(),eventRemoveListener(getButtonEvent('全自动运行'),L)});