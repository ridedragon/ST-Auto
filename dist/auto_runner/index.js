import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&l[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),a&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=a):d[4]=''.concat(a)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},344:(e,t,n)=>{var o=n(978);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('7d7f0d04',o,!1,{ssrId:!0})},424:(e,t,n)=>{function o(e,t){for(var n=[],o={},a=0;a<t.length;a++){var r=t[a],l=r[0],i={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(i):n.push(o[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>f});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=a&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,a){c=n,u=a||{};var l=o(e,t);return v(l),function(t){for(var n=[],a=0;a<l.length;a++){var i=l[a];(s=r[i.id]).refs--,n.push(s)}t?v(l=o(e,t)):l=[];for(a=0;a<n.length;a++){var s;if(0===(s=n[a]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete r[s.id]}}}}function v(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var a=0;a<o.parts.length;a++)o.parts[a](n.parts[a]);for(;a<n.parts.length;a++)o.parts.push(x(n.parts[a]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var l=[];for(a=0;a<n.parts.length;a++)l.push(x(n.parts[a]));r[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function x(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return d;o.parentNode.removeChild(o)}if(m){var a=s++;o=i||(i=g()),t=w.bind(null,o,a,!1),n=w.bind(null,o,a,!0)}else o=g(),t=E.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var h,b=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join('\n')});function w(e,t,n,o){var a=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=b(t,a);else{var r=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function E(e,t){var n=t.css,o=t.media,a=t.sourceMap;if(o&&e.setAttribute('media',o),u.ssrId&&e.setAttribute(p,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},673:(e,t,n)=>{var o=n(811);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('5d3f188e',o,!1,{ssrId:!0})},811:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.switch[data-v-cff7671a]{position:relative;display:inline-block;width:34px;height:20px}.switch input[data-v-cff7671a]{opacity:0;width:0;height:0}.slider[data-v-cff7671a]{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s}.slider[data-v-cff7671a]:before{position:absolute;content:"";height:12px;width:12px;left:4px;bottom:4px;background-color:#fff;transition:.4s}input:checked+.slider[data-v-cff7671a]{background-color:#2196f3}input:focus+.slider[data-v-cff7671a]{box-shadow:0 0 1px #2196f3}input:checked+.slider[data-v-cff7671a]:before{transform:translateX(14px)}.slider.round[data-v-cff7671a]{border-radius:20px}.slider.round[data-v-cff7671a]:before{border-radius:50%}','']);const i=l},978:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.wide-button[data-v-205d3df0]{width:100%;margin-top:10px}label[data-v-205d3df0]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-205d3df0]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-205d3df0]{width:100%}.description[data-v-205d3df0]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-205d3df0]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-205d3df0]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-205d3df0]{transform:scale(1.2)}.rule-name[data-v-205d3df0]{flex-grow:1}.rule-body[data-v-205d3df0]{display:flex;flex-direction:column;gap:5px}','']);const i=l}},n={};function o(e){var a=n[e];if(void 0!==a)return a.exports;var r=n[e]={id:e,exports:{}};return t[e](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const a=_;var r=o.n(a);const l=z,i=l.z.object({id:l.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:l.z.string().default(''),find:l.z.string().default(''),replace:l.z.string().default(''),enabled:l.z.boolean().default(!0)}),s=l.z.object({enabled:l.z.boolean().default(!1),apiUrl:l.z.preprocess(e=>e??'',l.z.string()),apiKey:l.z.preprocess(e=>e??'',l.z.string()),model:l.z.preprocess(e=>e??'',l.z.string()),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(40),max_tokens:l.z.coerce.number().min(1).default(1024),totalReplies:l.z.coerce.number().min(1).default(10),executedCount:l.z.coerce.number().min(0).default(0),contextRegexRules:l.z.array(i).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:l.z.array(i).default([]),maxRetries:l.z.coerce.number().min(0).default(3),exemptionCount:l.z.coerce.number().min(0).default(0)}),c=l.z.object({name:l.z.string(),content:l.z.string(),enabled:l.z.boolean(),editing:l.z.boolean(),role:l.z.enum(['user','system','assistant'])}),d=l.z.array(c);var u;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(u||(u={}));let p=u.IDLE,m=s.parse({}),f=0,v=0;function g(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let o;if(t){const e=t[1],n=t[2];o=new RegExp(e,n)}else o=new RegExp(e.find,'g');n=n.replace(o,e.replace)}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}const x=e=>new Promise(t=>setTimeout(t,e));async function h(){try{const e=getVariables({type:'script',script_id:getScriptId()})||{};m=s.parse(r().merge(s.parse({}),e))}catch(e){console.error('[AutoRunner] 加载设置失败:',e),toastr.error('加载设置失败，将使用默认设置。'),m=s.parse({})}}async function b(){toastr.info('正在调用副AI...');const e=await getLastMessageId(),t=getChatMessages(`0-${e}`);if(!t||0===t.length)return toastr.error('无法获取聊天记录'),null;const n=[...(await async function(){try{const e=getVariables({type:'script',script_id:'auto_runner_prompts'})||[];return d.parse(e)}catch(e){return console.error('[AutoRunner] 加载提示词失败:',e),toastr.error('加载提示词失败，将使用空提示词。'),[]}}()).filter(e=>e.enabled&&e.content).map(e=>({role:e.role,content:e.content})),...t.filter(e=>'system'!==e.role).map(e=>{const t=g(e.message,m.contextRegexRules);return{role:e.role,content:t}})],o={model:m.model,messages:n,temperature:m.temperature,top_p:m.top_p,top_k:m.top_k,max_tokens:m.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',o),toastr.info('完整的请求信息已打印到控制台 (F12)。');try{const e=await fetch(`${m.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${m.apiKey}`},body:JSON.stringify(o)});if(!e.ok)throw new Error(`副AI API 请求失败: ${e.statusText}`);const t=await e.json(),n=t.choices[0]?.message?.content;if(!n)throw new Error('副AI未返回有效内容');return toastr.success('副AI响应成功'),n}catch(e){return console.error('调用副AI时出错:',e),toastr.error(`调用副AI失败: ${e.message}`),null}}async function w(){if(v<m.exemptionCount)return toastr.info(`豁免计数 (${v}) 小于豁免次数 (${m.exemptionCount})，跳过SSC和一键处理。`),v++,!0;const e=window.parent.aiOptimizer;if(!e||'function'!=typeof e.manualOptimize||'function'!=typeof e.optimizeText)return toastr.warning('未找到 AI Optimizer API，跳过优化步骤。'),toastr.info('执行“一键处理”...'),await eventEmit(getButtonEvent('一键处理')),await x(5e3),!0;try{toastr.info('自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`,o=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0}),a=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!o)return toastr.info('自动化流程已由用户在步骤1取消。'),!1;toastr.info('正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',i=await e.optimizeText(a,l,r);if(null===i)return toastr.info('优化被用户取消。'),!1;if(!i)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=i;const s=`\n                  <p><b>原始句子:</b></p>\n                  <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${a}</textarea>\n                  <p><b>优化后句子 (可编辑):</b></p>\n                  <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${i}</textarea>\n              `,c=await window.parent.SillyTavern.getContext().callGenericPopup(s,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0}),d=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return toastr.info('替换操作已由用户取消。'),!1;toastr.info('正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(a,d,e=>{e&&toastr.success('SSC 替换完成！'),t()})})}else toastr.info('在最后一条角色消息中未找到可优化的内容，跳过SSC优化。');return toastr.info('等待2秒以确保系统稳定...'),await x(2e3),await async function(){toastr.info('正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:o}=t,a=/<\/?br\b[^>]*>/gi;if(a.test(o)){const e=o.replace(a,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),toastr.success('“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),toastr.error('执行“一键处理”时发生错误。')}}(),await x(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),toastr.error(e.message,'自动化优化流程失败'),!1}}async function E(e=!1){if(p!==u.RUNNING||m.executedCount>=m.totalReplies&&(toastr.info('已达到总回复次数，全自动运行结束。'),1))return void k();e||await h();const t=(getChatMessages(-1)||[])[0];if(!t)return toastr.error('无法获取最后一条消息，自动化暂停。'),void(p=u.PAUSED);try{if('user'===t.role)toastr.info('检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{toastr.info('检测到AI消息，开始完整循环...');if(!await w())return toastr.warning('用户取消了操作，全自动运行已停止。'),void k();let e=null,t=0;for(;t<=m.maxRetries&&(e=await b(),!e);){if(t++,t>m.maxRetries)return toastr.error(`调用副AI已达到最大重试次数 (${m.maxRetries})，自动化已停止。`),void k();toastr.warning(`调用副AI失败，将在5秒后重试 (${t}/${m.maxRetries})`),await x(5e3)}if(!e)return toastr.error('未能从副AI获取回复，自动化已停止。'),void k();const n=g(e,m.subAiRegexRules);console.log('处理后的回复:',n),toastr.info('以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}await async function(){m.executedCount++,await replaceVariables(r().cloneDeep(m),{type:'script',script_id:getScriptId()})}()}catch(e){console.error('自动化循环出错:',e),toastr.error(`自动化循环发生意外错误: ${e.message}，流程已终止。`),p=u.ERROR,k()}}function V(){p===u.RUNNING&&setTimeout(()=>E(!1),1e3)}function y(){p===u.RUNNING&&(toastr.warning('来自系统的停止信号，全自动运行已终止。'),k())}async function N(){p!==u.RUNNING&&(await x(1e3),await h(),toastr.success('全自动运行已启动！'),p=u.RUNNING,f=0,v=0,m.executedCount=0,replaceVariables(r().cloneDeep(m),{type:'script',script_id:getScriptId()}),eventOn(tavern_events.MESSAGE_RECEIVED,V),eventOn(tavern_events.GENERATION_STOPPED,y),E(!0))}function k(){p!==u.IDLE&&(toastr.info('全自动运行已停止。'),p=u.IDLE,eventRemoveListener(tavern_events.MESSAGE_RECEIVED,V),eventRemoveListener(tavern_events.GENERATION_STOPPED,y),triggerSlash('/stop'))}function C(){k(),eventRemoveListener(getButtonEvent('全自动运行'),N)}const R=Vue,S={class:'p-4 font-sans'},I={class:'mb-4 flex items-center justify-between'},A={class:'flex items-center space-x-2'},U={class:'space-y-2'},M={class:'flex items-center justify-between'},T={class:'flex items-center space-x-2'},D=['onUpdate:modelValue'],B={class:'flex items-center space-x-2'},P={key:0},O=['onClick'],L={class:'switch'},j=['onUpdate:modelValue'],G=['onClick'],F={key:0,class:'mt-2'},H=['onUpdate:modelValue'],K={class:'mt-2 flex items-center justify-end space-x-2'},J=['onUpdate:modelValue'],q='auto_runner_prompts',W=(0,R.defineComponent)({__name:'PromptEditor',setup(e){const t=l.z.object({name:l.z.string(),content:l.z.string(),enabled:l.z.boolean(),editing:l.z.boolean(),role:l.z.enum(['user','system','assistant'])}),n=l.z.array(t),o=(0,R.ref)([]);(0,R.onMounted)(()=>{try{const e=getVariables({type:'script',script_id:q})||[];o.value=n.parse(e)}catch(e){console.error('加载提示词条目失败:',e),o.value=[]}}),(0,R.watch)(o,r().debounce(async e=>{try{const t=n.parse(e);await replaceVariables(r().cloneDeep(t),{type:'script',script_id:q})}catch(e){console.error('自动保存提示词条目失败:',e)}},500),{deep:!0});const a=(0,R.computed)(()=>o.value.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function i(){o.value.push({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'})}return(e,t)=>((0,R.openBlock)(),(0,R.createElementBlock)('div',S,[(0,R.createElementVNode)('div',I,[t[1]||(t[1]=(0,R.createElementVNode)('h1',{class:'text-xl font-bold'},'提示词',-1)),(0,R.createElementVNode)('div',A,[(0,R.createElementVNode)('span',null,'总词符数: '+(0,R.toDisplayString)(a.value),1),(0,R.createElementVNode)('button',{onClick:i,class:'rounded p-1 hover:bg-gray-200'},[...t[0]||(t[0]=[(0,R.createElementVNode)('svg',{xmlns:'http://www.w3.org/2000/svg',class:'h-6 w-6',fill:'none',viewBox:'0 0 24 24',stroke:'currentColor'},[(0,R.createElementVNode)('path',{'stroke-linecap':'round','stroke-linejoin':'round','stroke-width':'2',d:'M12 4v16m8-8H4'})],-1)])])])]),(0,R.createElementVNode)('div',U,[((0,R.openBlock)(!0),(0,R.createElementBlock)(R.Fragment,null,(0,R.renderList)(o.value,(e,n)=>((0,R.openBlock)(),(0,R.createElementBlock)('div',{key:n,class:'rounded-lg border p-2'},[(0,R.createElementVNode)('div',M,[(0,R.createElementVNode)('div',T,[t[2]||(t[2]=(0,R.createElementVNode)('span',{class:'cursor-pointer'},'☰',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{type:'text','onUpdate:modelValue':t=>e.name=t,class:'bg-transparent focus:outline-none'},null,8,D),[[R.vModelText,e.name]])]),(0,R.createElementVNode)('div',B,[e.editing?(0,R.createCommentVNode)('v-if',!0):((0,R.openBlock)(),(0,R.createElementBlock)('span',P,(0,R.toDisplayString)(e.content.length),1)),(0,R.createElementVNode)('button',{onClick:t=>function(e){e.editing=!e.editing}(e),class:'rounded p-1 hover:bg-gray-200'},[...t[3]||(t[3]=[(0,R.createElementVNode)('svg',{xmlns:'http://www.w3.org/2000/svg',class:'h-5 w-5',viewBox:'0 0 20 20',fill:'currentColor'},[(0,R.createElementVNode)('path',{d:'M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.829-2.828z'})],-1)])],8,O),(0,R.createElementVNode)('label',L,[(0,R.withDirectives)((0,R.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t},null,8,j),[[R.vModelCheckbox,e.enabled]]),t[4]||(t[4]=(0,R.createElementVNode)('span',{class:'slider round'},null,-1))]),(0,R.createElementVNode)('button',{onClick:e=>function(e){o.value.splice(e,1)}(n),class:'rounded p-1 hover:bg-gray-200'},[...t[5]||(t[5]=[(0,R.createElementVNode)('svg',{xmlns:'http://www.w3.org/2000/svg',class:'h-5 w-5',viewBox:'0 0 20 20',fill:'currentColor'},[(0,R.createElementVNode)('path',{'fill-rule':'evenodd',d:'M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z','clip-rule':'evenodd'})],-1)])],8,G)])]),e.editing?((0,R.openBlock)(),(0,R.createElementBlock)('div',F,[(0,R.withDirectives)((0,R.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.content=t,class:'w-full rounded-md border p-2',rows:'4'},null,8,H),[[R.vModelText,e.content]]),(0,R.createElementVNode)('div',K,[(0,R.withDirectives)((0,R.createElementVNode)('select',{'onUpdate:modelValue':t=>e.role=t,class:'rounded-md border p-1'},[...t[6]||(t[6]=[(0,R.createElementVNode)('option',null,'user',-1),(0,R.createElementVNode)('option',null,'system',-1),(0,R.createElementVNode)('option',null,'assistant',-1)])],8,J),[[R.vModelSelect,e.role]])])])):(0,R.createCommentVNode)('v-if',!0)]))),128))])]))}});o(673);var X=o(42);const Q=(0,X.A)(W,[['__scopeId','data-v-cff7671a']]),Y={class:'inline-drawer'},Z={class:'inline-drawer-content'},ee={class:'flex-container flexFlowColumn'},te={class:'checkbox_label',for:'auto_runner_enabled'},ne={class:'flex-container flexFlowColumn'},oe={class:'rule-header'},ae=['onUpdate:modelValue'],re=['onUpdate:modelValue'],le=['onClick'],ie={class:'rule-body'},se=['onUpdate:modelValue'],ce=['onUpdate:modelValue'],de={class:'flex-container flexFlowColumn'},ue={class:'rule-header'},pe=['onUpdate:modelValue'],me=['onUpdate:modelValue'],fe=['onClick'],ve={class:'rule-body'},ge=['onUpdate:modelValue'],xe=['onUpdate:modelValue'],he={class:'flex-container flexFlowColumn'},be={key:0,value:''},we=['value'],_e={for:'auto_runner_temperature'},Ee={for:'auto_runner_top_p'},Ve={for:'auto_runner_top_k'},ye={for:'auto_runner_max_tokens'},Ne={class:'flex-container flexFlowColumn'},ke={id:'auto_runner_executed_count',class:'text_pole'},Ce=(0,R.defineComponent)({__name:'app',setup(e){const t=(0,R.ref)(s.parse({})),n=(0,R.ref)([]);(0,R.onMounted)(async()=>{try{const e=getVariables({type:'script',script_id:getScriptId()})||{},o=s.parse({}),a=r().merge(o,e);t.value=s.parse(a),t.value.model&&n.value.push(t.value.model)}catch(e){console.error('加载设置失败:',e),t.value=s.parse({})}}),(0,R.watch)(t,r().debounce(async e=>{try{const t=s.parse(e);await replaceVariables(r().cloneDeep(t),{type:'script',script_id:getScriptId()})}catch(e){console.error('自动保存设置失败:',e)}},500),{deep:!0}),(0,R.watch)(()=>t.value.enabled,(e,n)=>{!0===e&&!1===n?(t.value.executedCount=0,eventOn(getButtonEvent('全自动运行'),()=>{p===u.RUNNING?k():N()}),h()):!1===e&&!0===n&&C()});const o=e=>{const n=i.parse({});'context'===e?t.value.contextRegexRules.push(n):t.value.subAiRegexRules.push(n)},a=(e,n)=>{'context'===e?t.value.contextRegexRules.splice(n,1):t.value.subAiRegexRules.splice(n,1)},l=async()=>{if(t.value.apiUrl)try{const e=await fetch(`${t.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const o=(await e.json()).data.map(e=>e.id);n.value=r().union(n.value,o),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,R.openBlock)(),(0,R.createElementBlock)('div',Y,[r[32]||(r[32]=(0,R.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,R.createElementVNode)('b',null,'自动化运行脚本设置'),(0,R.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,R.createElementVNode)('div',Z,[(0,R.createElementVNode)('div',ee,[(0,R.createElementVNode)('label',te,[(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>t.value.enabled=e),type:'checkbox'},null,512),[[R.vModelCheckbox,t.value.enabled]]),r[13]||(r[13]=(0,R.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),r[27]||(r[27]=(0,R.createElementVNode)('hr',null,null,-1)),(0,R.createVNode)(Q),r[28]||(r[28]=(0,R.createElementVNode)('hr',null,null,-1)),(0,R.createCommentVNode)(' 新的上下文正则编辑器 '),(0,R.createElementVNode)('div',ne,[r[14]||(r[14]=(0,R.createElementVNode)('div',null,[(0,R.createElementVNode)('strong',null,'上下文正则处理')],-1)),r[15]||(r[15]=(0,R.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,R.openBlock)(!0),(0,R.createElementBlock)(R.Fragment,null,(0,R.renderList)(t.value.contextRegexRules,(e,t)=>((0,R.openBlock)(),(0,R.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,R.createElementVNode)('div',oe,[(0,R.withDirectives)((0,R.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,ae),[[R.vModelCheckbox,e.enabled]]),(0,R.withDirectives)((0,R.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,re),[[R.vModelText,e.name]]),(0,R.createElementVNode)('button',{class:'menu_button',onClick:e=>a('context',t)},'删除',8,le)]),(0,R.createElementVNode)('div',ie,[(0,R.withDirectives)((0,R.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,se),[[R.vModelText,e.find]]),(0,R.withDirectives)((0,R.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,ce),[[R.vModelText,e.replace]])])]))),128)),(0,R.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[1]||(r[1]=e=>o('context'))},'添加上下文规则')]),r[29]||(r[29]=(0,R.createElementVNode)('hr',null,null,-1)),(0,R.createCommentVNode)(' 新的副AI输出正则编辑器 '),(0,R.createElementVNode)('div',de,[r[16]||(r[16]=(0,R.createElementVNode)('div',null,[(0,R.createElementVNode)('strong',null,'副AI输出正则处理')],-1)),r[17]||(r[17]=(0,R.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,R.openBlock)(!0),(0,R.createElementBlock)(R.Fragment,null,(0,R.renderList)(t.value.subAiRegexRules,(e,t)=>((0,R.openBlock)(),(0,R.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,R.createElementVNode)('div',ue,[(0,R.withDirectives)((0,R.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,pe),[[R.vModelCheckbox,e.enabled]]),(0,R.withDirectives)((0,R.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,me),[[R.vModelText,e.name]]),(0,R.createElementVNode)('button',{class:'menu_button',onClick:e=>a('subAi',t)},'删除',8,fe)]),(0,R.createElementVNode)('div',ve,[(0,R.withDirectives)((0,R.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,ge),[[R.vModelText,e.find]]),(0,R.withDirectives)((0,R.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,xe),[[R.vModelText,e.replace]])])]))),128)),(0,R.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[2]||(r[2]=e=>o('subAi'))},'添加副AI输出规则')]),r[30]||(r[30]=(0,R.createElementVNode)('hr',null,null,-1)),(0,R.createElementVNode)('div',he,[r[18]||(r[18]=(0,R.createElementVNode)('div',null,[(0,R.createElementVNode)('strong',null,'API 调用设置')],-1)),r[19]||(r[19]=(0,R.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[3]||(r[3]=e=>t.value.apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[R.vModelText,t.value.apiUrl]]),r[20]||(r[20]=(0,R.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[4]||(r[4]=e=>t.value.apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[R.vModelText,t.value.apiKey]]),(0,R.createElementVNode)('div',{class:'flex-container'},[(0,R.createElementVNode)('button',{class:'menu_button wide-button',onClick:l},'获取模型')]),r[21]||(r[21]=(0,R.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,R.withDirectives)((0,R.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[5]||(r[5]=e=>t.value.model=e),class:'text_pole'},[t.value.model?(0,R.createCommentVNode)('v-if',!0):((0,R.openBlock)(),(0,R.createElementBlock)('option',be,'请先获取模型')),((0,R.openBlock)(!0),(0,R.createElementBlock)(R.Fragment,null,(0,R.renderList)(n.value,e=>((0,R.openBlock)(),(0,R.createElementBlock)('option',{key:e,value:e},(0,R.toDisplayString)(e),9,we))),128))],512),[[R.vModelSelect,t.value.model]]),(0,R.createElementVNode)('label',_e,'Temperature: '+(0,R.toDisplayString)(t.value.temperature),1),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[6]||(r[6]=e=>t.value.temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[R.vModelText,t.value.temperature,void 0,{number:!0}]]),(0,R.createElementVNode)('label',Ee,'Top P: '+(0,R.toDisplayString)(t.value.top_p),1),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[7]||(r[7]=e=>t.value.top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[R.vModelText,t.value.top_p,void 0,{number:!0}]]),(0,R.createElementVNode)('label',Ve,'Top K: '+(0,R.toDisplayString)(t.value.top_k),1),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[8]||(r[8]=e=>t.value.top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[R.vModelText,t.value.top_k,void 0,{number:!0}]]),(0,R.createElementVNode)('label',ye,'Max Tokens: '+(0,R.toDisplayString)(t.value.max_tokens),1),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[9]||(r[9]=e=>t.value.max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[R.vModelText,t.value.max_tokens,void 0,{number:!0}]])]),r[31]||(r[31]=(0,R.createElementVNode)('hr',null,null,-1)),(0,R.createElementVNode)('div',Ne,[r[22]||(r[22]=(0,R.createElementVNode)('div',null,[(0,R.createElementVNode)('strong',null,'自动化设置')],-1)),r[23]||(r[23]=(0,R.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[10]||(r[10]=e=>t.value.totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[R.vModelText,t.value.totalReplies,void 0,{number:!0}]]),r[24]||(r[24]=(0,R.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':r[11]||(r[11]=e=>t.value.maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[R.vModelText,t.value.maxRetries,void 0,{number:!0}]]),r[25]||(r[25]=(0,R.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,R.withDirectives)((0,R.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':r[12]||(r[12]=e=>t.value.exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[R.vModelText,t.value.exemptionCount,void 0,{number:!0}]]),r[26]||(r[26]=(0,R.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,R.createElementVNode)('div',ke,(0,R.toDisplayString)(t.value.executedCount),1)])])]))}});o(344);const Re=(0,X.A)(Ce,[['__scopeId','data-v-205d3df0']]),Se=(0,R.createApp)(Re);function Ie(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),Se.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function Ae(){Se.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{Ie()}),$(window).on('pagehide',()=>{Ae(),C()});