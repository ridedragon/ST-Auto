import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const r=e.__vccOpts||e;for(const[e,n]of t)r[e]=n;return r}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var r='',n=void 0!==t[5];return t[4]&&(r+='@supports ('.concat(t[4],') {')),t[2]&&(r+='@media '.concat(t[2],' {')),n&&(r+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),r+=e(t),n&&(r+='}'),t[2]&&(r+='}'),t[4]&&(r+='}'),r}).join('')},t.i=function(e,r,n,a,o){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(n)for(var s=0;s<this.length;s++){var i=this[s][0];null!=i&&(l[i]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&l[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=o),r&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=r):d[2]=r),a&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=a):d[4]=''.concat(a)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},424:(e,t,r)=>{function n(e,t){for(var r=[],n={},a=0;a<t.length;a++){var o=t[a],l=o[0],s={id:e+':'+a,css:o[1],media:o[2],sourceMap:o[3]};n[l]?n[l].parts.push(s):r.push(n[l]={id:l,parts:[s]})}return r}r.d(t,{A:()=>v});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var o={},l=a&&(document.head||document.getElementsByTagName('head')[0]),s=null,i=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,r,a){c=r,u=a||{};var l=n(e,t);return f(l),function(t){for(var r=[],a=0;a<l.length;a++){var s=l[a];(i=o[s.id]).refs--,r.push(i)}t?f(l=n(e,t)):l=[];for(a=0;a<r.length;a++){var i;if(0===(i=r[a]).refs){for(var c=0;c<i.parts.length;c++)i.parts[c]();delete o[i.id]}}}}function f(e){for(var t=0;t<e.length;t++){var r=e[t],n=o[r.id];if(n){n.refs++;for(var a=0;a<n.parts.length;a++)n.parts[a](r.parts[a]);for(;a<r.parts.length;a++)n.parts.push(g(r.parts[a]));n.parts.length>r.parts.length&&(n.parts.length=r.parts.length)}else{var l=[];for(a=0;a<r.parts.length;a++)l.push(g(r.parts[a]));o[r.id]={id:r.id,refs:1,parts:l}}}}function h(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function g(e){var t,r,n=document.querySelector('style['+p+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(m){var a=i++;n=s||(s=h()),t=V.bind(null,n,a,!1),r=V.bind(null,n,a,!0)}else n=h(),t=x.bind(null,n),r=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else r()}}var b,y=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function V(e,t,r,n){var a=r?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,a);else{var o=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(o,l[t]):e.appendChild(o)}}function x(e,t){var r=t.css,n=t.media,a=t.sourceMap;if(n&&e.setAttribute('media',n),u.ssrId&&e.setAttribute(p,t.id),a&&(r+='\n/*# sourceURL='+a.sources[0]+' */',r+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}},729:(e,t,r)=>{var n=r(799);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,r(424).A)('03d7db19',n,!1,{ssrId:!0})},799:(e,t,r)=>{r.r(t),r.d(t,{default:()=>s});var n=r(93),a=r.n(n),o=r(54),l=r.n(o)()(a());l.push([e.id,'.inline-drawer-content[data-v-1b582a1a]{display:flex;flex-direction:column;gap:8px}input[data-v-1b582a1a],textarea[data-v-1b582a1a],select[data-v-1b582a1a],button[data-v-1b582a1a]{width:100%;box-sizing:border-box}textarea[data-v-1b582a1a]{min-height:80px}','']);const s=l}},r={};function n(e){var a=r[e];if(void 0!==a)return a.exports;var o=r[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const a=_;var o=n.n(a);const l=z,s=l.z.object({enabled:l.z.boolean().default(!1),prompt:l.z.string().default(''),apiUrl:l.z.string().default(''),apiKey:l.z.string().default(''),model:l.z.string().default(''),models:l.z.array(l.z.string()).default([]),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(50),maxReplies:l.z.number().min(1).default(10)});let i=0,c=!1;async function d(e){if(c)return void console.log('自动化脚本正在运行中，跳过本次触发。');const t=s.parse(getVariables({type:'script',script_id:getScriptId()})||{}),r=getChatMessages(-1)[0];if(t.enabled&&r&&'assistant'===r.role&&!(i<=0)){c=!0,toastr.info(`自动化脚本介入，剩余 ${i} 次回复。`);try{const r=getChatMessages(`0-${e}`).map(e=>`${e.name}: ${e.message}`).join('\n'),n=await generate({user_input:`${r}\n\n${t.prompt}`,custom_api:{apiurl:t.apiUrl,key:t.apiKey,model:t.model,temperature:t.temperature,top_p:t.top_p,top_k:t.top_k},should_stream:!1});if(!n||''===n.trim())throw new Error('副AI没有返回有效指令。');await createChatMessages([{role:'user',name:SillyTavern.name1,message:n}]),i--,toastr.success(`指令已发送，剩余 ${i} 次。`)}catch(e){const t=e;console.error('自动化脚本运行出错:',t),toastr.error(`脚本错误: ${t.message}`)}finally{if(c=!1,i<=0){toastr.info('自动化任务完成。');const e=s.parse(getVariables({type:'script',script_id:getScriptId()})||{});e.enabled&&(e.enabled=!1,replaceVariables(o().cloneDeep(e),{type:'script',script_id:getScriptId()}))}}}}function u(e){const t=s.parse(getVariables({type:'script',script_id:getScriptId()})||{}),r=getChatMessages('0-{{lastMessageId}}');t.enabled&&1===r.length&&'user'===r[0].role&&(i=t.maxReplies,toastr.info(`自动化脚本已启动，将代替用户回复 ${i} 次。`))}const p=Vue,m={class:'inline-drawer'},v={class:'inline-drawer-content'},f=['value'],h=(0,p.defineComponent)({__name:'app',setup(e){const t=(0,p.ref)(s.parse({})),r=async()=>{if(t.value.apiUrl)try{const e=await fetch(`${t.value.apiUrl}/v1/models`,{headers:{Authorization:`Bearer ${t.value.apiKey}`}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=(await e.json()).data.map(e=>e.id);t.value.models=r,r.length>0&&!t.value.model&&(t.value.model=r[0]),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写 API URL')};(0,p.onMounted)(()=>{try{const e=getVariables({type:'script',script_id:getScriptId()});t.value=s.parse(e),toastr.info('设置已加载。'),t.value.apiUrl&&0===t.value.models.length&&r()}catch(e){console.error('加载设置失败:',e),t.value=s.parse({}),toastr.warning('无法加载保存的设置，已使用默认设置。')}});const n=()=>{try{const e=s.parse(t.value);replaceVariables(o().cloneDeep(e),{type:'script',script_id:getScriptId()}),toastr.success('设置已成功保存！')}catch(e){const t=e;console.error('保存设置失败:',t),toastr.error(`保存失败: ${t.message}`)}};return(e,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',m,[a[22]||(a[22]=(0,p.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,p.createElementVNode)('b',null,'Auto Runner'),(0,p.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,p.createElementVNode)('div',v,[(0,p.createElementVNode)('label',null,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[0]||(a[0]=e=>t.value.enabled=e),type:'checkbox'},null,512),[[p.vModelCheckbox,t.value.enabled]]),a[9]||(a[9]=(0,p.createTextVNode)(' 启用脚本 ',-1))]),a[14]||(a[14]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':a[1]||(a[1]=e=>t.value.prompt=e),placeholder:'输入给副AI的指令...'},null,512),[[p.vModelText,t.value.prompt]]),a[15]||(a[15]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>t.value.apiUrl=e),type:'text',placeholder:'API URL'},null,512),[[p.vModelText,t.value.apiUrl]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>t.value.apiKey=e),type:'password',placeholder:'API 密钥'},null,512),[[p.vModelText,t.value.apiKey]]),a[16]||(a[16]=(0,p.createElementVNode)('br',null,null,-1)),(0,p.createElementVNode)('button',{onClick:r},'获取模型'),(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[4]||(a[4]=e=>t.value.model=e)},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(t.value.models,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,f))),128))],512),[[p.vModelSelect,t.value.model]]),a[17]||(a[17]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('label',null,[a[10]||(a[10]=(0,p.createTextVNode)(' Temperature: ',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>t.value.temperature=e),type:'number',step:'0.1',min:'0',max:'2'},null,512),[[p.vModelText,t.value.temperature]])]),a[18]||(a[18]=(0,p.createElementVNode)('br',null,null,-1)),(0,p.createElementVNode)('label',null,[a[11]||(a[11]=(0,p.createTextVNode)(' Top P: ',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>t.value.top_p=e),type:'number',step:'0.1',min:'0',max:'1'},null,512),[[p.vModelText,t.value.top_p]])]),a[19]||(a[19]=(0,p.createElementVNode)('br',null,null,-1)),(0,p.createElementVNode)('label',null,[a[12]||(a[12]=(0,p.createTextVNode)(' Top K: ',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[7]||(a[7]=e=>t.value.top_k=e),type:'number',min:'0'},null,512),[[p.vModelText,t.value.top_k]])]),a[20]||(a[20]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('label',null,[a[13]||(a[13]=(0,p.createTextVNode)(' 最大回复次数: ',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[8]||(a[8]=e=>t.value.maxReplies=e),type:'number',min:'1'},null,512),[[p.vModelText,t.value.maxReplies]])]),a[21]||(a[21]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('button',{onClick:n},'保存设置')])]))}});n(729);const g=(0,n(42).A)(h,[['__scopeId','data-v-1b582a1a']]),b=(0,p.createApp)(g);function y(){try{toastr.info('[AutoRunner] 开始初始化面板...'),function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');toastr.success('成功找到注入点 #extensions_settings2。','[AutoRunner]');const r=$('<div>').attr('script_id',getScriptId());t.append(r),toastr.info('Vue 容器已注入页面。','[AutoRunner]'),b.use(e()).mount(r[0]),toastr.success('Vue 应用已成功挂载！','[AutoRunner]')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function V(){b.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{y(),eventOn(tavern_events.MESSAGE_RECEIVED,d),eventOn(tavern_events.MESSAGE_SENT,u),console.log('自动化运行脚本已启动并监听事件。')}),$(window).on('pagehide',()=>{V()});