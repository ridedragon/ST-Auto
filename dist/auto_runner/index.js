import{default as e}from'https://testingcf.jsdelivr.net/npm/mammoth/+esm';import{createPinia as t}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var n={54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&l[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),a&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=a):d[4]=''.concat(a)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},424:(e,t,n)=>{function o(e,t){for(var n=[],o={},a=0;a<t.length;a++){var r=t[a],l=r[0],i={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(i):n.push(o[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>f});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=a&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,a){c=n,u=a||{};var l=o(e,t);return g(l),function(t){for(var n=[],a=0;a<l.length;a++){var i=l[a];(s=r[i.id]).refs--,n.push(s)}t?g(l=o(e,t)):l=[];for(a=0;a<n.length;a++){var s;if(0===(s=n[a]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete r[s.id]}}}}function g(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var a=0;a<o.parts.length;a++)o.parts[a](n.parts[a]);for(;a<n.parts.length;a++)o.parts.push(h(n.parts[a]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var l=[];for(a=0;a<n.parts.length;a++)l.push(h(n.parts[a]));r[n.id]={id:n.id,refs:1,parts:l}}}}function v(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function h(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return d;o.parentNode.removeChild(o)}if(m){var a=s++;o=i||(i=v()),t=y.bind(null,o,a,!1),n=y.bind(null,o,a,!0)}else o=v(),t=w.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function y(e,t,n,o){var a=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,a);else{var r=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function w(e,t){var n=t.css,o=t.media,a=t.sourceMap;if(o&&e.setAttribute('media',o),u.ssrId&&e.setAttribute(p,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},441:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},530:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.rule-header[data-v-75809739]{display:flex;align-items:center;gap:10px}.drag-handle[data-v-75809739]{cursor:grab}.rule-name[data-v-75809739]{flex-grow:1;min-width:50px}.buttons[data-v-75809739]{display:flex;flex-shrink:0;gap:5px}.icon-button[data-v-75809739]{padding:4px 8px;line-height:1}.rule-body select[data-v-75809739]{margin-top:5px}.attachments-section[data-v-75809739]{margin-top:10px}.attachment-list[data-v-75809739]{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px}.attachment-item[data-v-75809739]{background-color:var(--bg2);padding:2px 8px;border-radius:12px;display:flex;align-items:center;gap:5px;font-size:.9em;max-width:100%;overflow:hidden;cursor:pointer;transition:background-color .2s}.attachment-item[data-v-75809739]:hover{background-color:var(--bg3)}.attachment-name[data-v-75809739]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-grow:1;min-width:0}.delete-attachment-btn[data-v-75809739]{flex-shrink:0}.attachment-button[data-v-75809739]{white-space:nowrap}.delete-attachment-btn i[data-v-75809739]{color:#f55}.delete-attachment-btn:hover i[data-v-75809739]{color:#f88}.wide-button[data-v-75809739]{width:100%;margin-top:10px}.chat-history-placeholder[data-v-75809739]{background-color:var(--bg3) !important}','']);const i=l},966:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.section-wrapper[data-v-598ca2f0]{border-top:1px solid var(--bg2)}.section-wrapper[data-v-598ca2f0]:first-of-type{border-top:none}.section-wrapper[data-v-598ca2f0]:last-of-type{border-bottom:1px solid var(--bg2);margin-bottom:1em}.section-toggle-checkbox[data-v-598ca2f0]{display:none}.section-header[data-v-598ca2f0]{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:.25em 4px;border-radius:4px;transition:background-color .2s ease}.section-header[data-v-598ca2f0]:hover{background-color:var(--bg2-trans)}.section-header strong[data-v-598ca2f0]{font-size:1.1em}.section-header i[data-v-598ca2f0]{transition:transform .3s ease}.section-content[data-v-598ca2f0]{display:none;padding:10px 4px 0}.section-toggle-checkbox:checked+.section-header i[data-v-598ca2f0]{transform:rotate(90deg)}.section-toggle-checkbox:checked~.section-content[data-v-598ca2f0]{display:block}.wide-button[data-v-598ca2f0]{width:100%;margin-top:10px}label[data-v-598ca2f0]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-598ca2f0]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-598ca2f0]{width:100%}.description[data-v-598ca2f0]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-598ca2f0]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-598ca2f0]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-598ca2f0]{transform:scale(1.2)}.rule-name[data-v-598ca2f0]{flex-grow:1}.rule-body[data-v-598ca2f0]{display:flex;flex-direction:column;gap:5px}.set-manager[data-v-598ca2f0]{display:flex;gap:10px;align-items:center}.set-select[data-v-598ca2f0]{flex-grow:1}.set-buttons[data-v-598ca2f0]{display:flex;gap:5px}.icon-button[data-v-598ca2f0]{padding:6px 10px;line-height:1;flex-shrink:0}','']);const i=l},972:(e,t,n)=>{var o=n(966);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('1b892f60',o,!1,{ssrId:!0})},988:(e,t,n)=>{var o=n(530);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('2e36fa7c',o,!1,{ssrId:!0})}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var r=o[e]={id:e,exports:{}};return n[e](r,r.exports,a),r.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const r=_;var l=a.n(r);const i=Vue,s=z,c=s.z.object({id:s.z.string().default(()=>`attachment_${Date.now()}_${Math.random()}`),name:s.z.string(),type:s.z.string(),content:s.z.string()}),d=s.z.object({id:s.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:s.z.string().default(''),find:s.z.string().default(''),replace:s.z.string().default(''),enabled:s.z.boolean().default(!0)}),u=s.z.object({id:s.z.string().default(()=>`prompt_${Date.now()}_${Math.random()}`),name:s.z.string(),content:s.z.string(),attachments:s.z.array(c).optional().default([]),enabled:s.z.boolean(),editing:s.z.boolean(),role:s.z.enum(['user','system','assistant']),is_chat_history:s.z.boolean().optional().default(!1)}),p=s.z.object({id:s.z.string().default(()=>`set_${Date.now()}_${Math.random()}`),name:s.z.string(),promptEntries:s.z.array(u)}),m=s.z.object({enabled:s.z.boolean().default(!0),promptSets:s.z.array(p).default([]),activePromptSetId:s.z.string().nullable().default(null),apiUrl:s.z.preprocess(e=>e??'',s.z.string()),apiKey:s.z.preprocess(e=>e??'',s.z.string()),model:s.z.preprocess(e=>e??'',s.z.string()),temperature:s.z.number().min(0).max(2).default(.7),top_p:s.z.number().min(0).max(1).default(1),top_k:s.z.number().min(0).default(40),max_tokens:s.z.coerce.number().min(1).default(1024),totalReplies:s.z.coerce.number().min(1).default(10),executedCount:s.z.coerce.number().min(0).default(0),contextRegexRules:s.z.array(d).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:s.z.array(d).default([]),maxRetries:s.z.coerce.number().min(0).default(3),exemptionCount:s.z.coerce.number().min(0).default(0),conciseNotifications:s.z.boolean().default(!1)}),f=Symbol('ABORT_SIGNAL'),g=(0,i.ref)(!1);let v=null;var h;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(h||(h={}));let b=h.IDLE,x=!1,y=!1;const w=(0,i.ref)(m.parse({}));let E=0,N=0,V=0,k=!1;const S=(0,i.computed)(()=>{const e=w.value.promptSets.find(e=>e.id===w.value.activePromptSetId);return e||p.parse({name:'（无有效配置）',promptEntries:[]})});function R(){const e=window.prompt('请输入新配置的名称：',`新配置 ${w.value.promptSets.length+1}`);if(!e)return;const t=u.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=p.parse({name:e,promptEntries:[t]});w.value.promptSets.push(n),w.value.activePromptSetId=n.id,D('success',`已创建新配置 "${e}"`)}function A(){const e=S.value;if(!e||'（无有效配置）'===e.name)return;const t=window.prompt('请输入新的名称：',e.name);if(t&&t!==e.name){const n=w.value.promptSets.find(t=>t.id===e.id);n&&(n.name=t,D('success','配置已重命名'))}}function I(){if(w.value.promptSets.length<=1)return void D('error','无法删除最后一个配置集',!0);const e=S.value;if(!e||!window.confirm(`确定要删除配置 "${e.name}" 吗？此操作不可撤销。`))return;const t=w.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(w.value.promptSets.splice(t,1),w.value.activePromptSetId=w.value.promptSets[Math.max(0,t-1)]?.id||null,D('success',`配置 "${e.name}" 已删除`))}function C(){const e=S.value;if(!e||'（无有效配置）'===e.name)return void D('error','没有可导出的有效配置。');const t={version:2,promptSet:e,contextRegexRules:w.value.contextRegexRules,subAiRegexRules:w.value.subAiRegexRules},n=JSON.stringify(t,null,2),o=new Blob([n],{type:'application/json'}),a=URL.createObjectURL(o),r=document.createElement('a');r.href=a,r.download=`[AutoRunner] ${e.name}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),D('success','当前完整预设（提示词+正则）已导出')}function U(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n);if(2===e.version&&e.promptSet){const{promptSet:t,contextRegexRules:n,subAiRegexRules:o}=e,a=p.safeParse(t);if(!a.success)return void D('error','导入的提示词配置部分格式无效。',!0);{let e=w.value.promptSets.find(e=>e.name===a.data.name);if(e){if(window.confirm(`已存在名为 "${a.data.name}" 的提示词配置。要覆盖它吗？`)){const t=w.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(a.data.id=e.id,w.value.promptSets[t]=a.data)}}else a.data.id=`set_${Date.now()}_${Math.random()}`,w.value.promptSets.push(a.data);w.value.activePromptSetId=a.data.id,D('success',`提示词配置 "${a.data.name}" 已导入并激活。`)}if(n&&o&&window.confirm('文件包含正则规则。要用导入的规则覆盖当前的上下文和副AI正则规则吗？')){const e=s.z.array(d).safeParse(n),t=s.z.array(d).safeParse(o);e.success&&t.success?(w.value.contextRegexRules=e.data,w.value.subAiRegexRules=t.data,D('success','上下文和副AI正则规则已成功导入。')):D('error','导入的正则规则部分格式无效。',!0)}}else{const t=Array.isArray(e)?e:[e];let n=0;for(const e of t){const t=p.safeParse(e);if(t.success){if(w.value.promptSets.some(e=>e.name===t.data.name)){if(!window.confirm(`已存在名为 "${t.data.name}" 的配置。要覆盖它吗？`))continue;const e=w.value.promptSets.findIndex(e=>e.name===t.data.name);e>-1&&w.value.promptSets.splice(e,1)}t.data.id=`set_${Date.now()}_${Math.random()}`,w.value.promptSets.push(t.data),n++}else console.error('导入的数据格式无效:',t.error),D('error','一个或多个导入的配置格式无效，详情请查看控制台。',!0)}n>0&&D('success',`成功导入 ${n} 个旧格式的配置。`)}}catch(e){console.error('导入失败:',e),D('error','导入文件失败，请确保是有效的JSON文件。',!0)}},e.click()}const P=l().debounce(e=>{const t=JSON.parse(JSON.stringify(e));replaceVariables(t,{type:'script',script_id:getScriptId()}),console.log('[AutoRunner] Settings saved.')},500);function D(e,t,n=!1){w.value.conciseNotifications&&!n||toastr[e](t)}function T(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let o,a;if(t?(o=t[1],a=t[2]):(o=e.find,a='g'),o.startsWith('^')&&a.includes('g')){const t=a.replace('g',''),r=new RegExp(o,t);for(;r.test(n);)n=n.replace(r,e.replace)}else{const t=new RegExp(o,a);n=n.replace(t,e.replace)}}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}(0,i.watch)(w,e=>{P(e)},{deep:!0});const B=e=>new Promise(t=>setTimeout(t,e));async function M(){const e=getVariables({type:'script',script_id:getScriptId()})||{},t=JSON.parse(JSON.stringify(e)),n=m.safeParse(t);if(n.success){const e=n.data;let t=!1;if(0===e.promptSets.length){const n=u.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),o=p.parse({name:'默认配置',promptEntries:[n]});e.promptSets.push(o),e.activePromptSetId=o.id,t=!0,D('info','未找到任何配置，已创建默认配置。')}else for(const n of e.promptSets)if(!n.promptEntries.some(e=>e.is_chat_history)){const e=u.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});n.promptEntries.unshift(e),t=!0,D('info',`为配置 "${n.name}" 补全了缺失的“聊天记录”条目。`)}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,t=!0),w.value=e,t&&(P.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}))}else{console.error('[AutoRunner] 加载或解析设置失败:',n.error),D('error','加载设置时发现不兼容的数据，将尝试迁移。您的部分设置可能已重置。',!0);const e=m.parse({});for(const n in e)if(Object.prototype.hasOwnProperty.call(t,n)){const o=n,a=m.shape[o].safeParse(t[o]);a.success?e[o]=a.data:console.warn(`[AutoRunner] 无法迁移字段 "${o}"，将使用默认值。错误:`,a.error)}let o=!1;if(0===e.promptSets.length){const t=u.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=p.parse({name:'默认配置',promptEntries:[t]});e.promptSets.push(n),e.activePromptSetId=n.id,o=!0}else for(const t of e.promptSets)if(!t.promptEntries.some(e=>e.is_chat_history)){const e=u.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});t.promptEntries.unshift(e),o=!0}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,o=!0),w.value=e,P.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}),D('success','数据迁移完成。请检查您的设置。',!0)}}async function O(){toastr.info('正在向副AI发送消息...',void 0,{timeOut:0,extendedTimeOut:0,closeButton:!1,tapToDismiss:!1});g.value=!0,v=new AbortController;try{const t=await getLastMessageId(),n=getChatMessages(`0-${t}`);if(!n||0===n.length)return D('error','无法获取聊天记录',!0),null;const o=[],a=n.filter(e=>'system'!==e.role).map(e=>{const t=T(e.message,w.value.contextRegexRules);return{role:e.role,content:[t]}});for(const t of S.value.promptEntries)if(t.is_chat_history)o.push(...a);else if(t.enabled){const n=[];if(t.content&&n.push(t.content),t.attachments&&t.attachments.length>0)for(const o of t.attachments){const t=atob(o.content),a=t.length,r=new Uint8Array(a);for(let e=0;e<a;e++)r[e]=t.charCodeAt(e);const l=r.buffer;if(o.type.startsWith('image/'))n.push({type:'image_url',image_url:{url:`data:${o.type};base64,${o.content}`}});else if('application/vnd.openxmlformats-officedocument.wordprocessingml.document'===o.type)try{const t=await e.extractRawText({arrayBuffer:l});n.push(`\n\n--- Attachment: ${o.name} ---\n${t.value}\n--- End Attachment ---`)}catch(e){console.error(`Error extracting text from docx ${o.name}:`,e)}else try{const e=new Blob([l],{type:o.type}),t=await new Response(e).text();n.push(`\n\n--- Attachment: ${o.name} ---\n${t}\n--- End Attachment ---`)}catch(e){console.error(`Error decoding attachment ${o.name}:`,e)}}n.length>0&&o.push({role:t.role,content:n})}const r=o.map(e=>{if(Array.isArray(e.content)&&e.content.length>1){const t=e.content.map(e=>'string'==typeof e?{type:'text',text:e}:e).filter(Boolean);return{...e,content:t}}return{...e,content:Array.isArray(e.content)?e.content.join('\n'):e.content}}),l={model:w.value.model,messages:r,temperature:w.value.temperature,top_p:w.value.top_p,top_k:w.value.top_k,max_tokens:w.value.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',l),w.value.conciseNotifications||D('info','完整的请求信息已打印到控制台 (F12)。');const i=await fetch(`${w.value.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${w.value.apiKey}`},body:JSON.stringify(l),signal:v.signal});if(!i.ok)throw new Error(`副AI API 请求失败: ${i.statusText}`);const s=await i.json(),c=s.choices[0]?.message?.content;if(!c)throw new Error('副AI未返回有效内容');return D('success','副AI响应成功'),c}catch(e){return'AbortError'===e.name?(D('warning','已中止向副AI发送消息。',!0),f):(console.error('调用副AI时出错:',e),D('error',`调用副AI失败: ${e.message}`,!0),null)}finally{toastr.clear(),g.value=!1,v=null}}function L(e){return T(e,w.value.subAiRegexRules)}function j(){k=!k,D('info','“真·自动化”模式已'+(k?'开启':'关闭'),!0)}async function G(e=!1){if(!e&&V<w.value.exemptionCount)return D('info',`豁免计数 (${V+1}/${w.value.exemptionCount})，跳过SSC和一键处理。`),V++,!0;try{const e=window.parent.aiOptimizer;if(e&&'function'==typeof e.manualOptimize&&'function'==typeof e.optimizeText){D('info','自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`;let o;k?(D('info','[真·自动化] 自动确认步骤1。'),o=!0):o=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0});const a=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!o)return D('info','自动化流程已由用户在步骤1取消。'),!1;if(b!==h.RUNNING)return!1;D('info','正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',i=await e.optimizeText(a,l,r);if(null===i)return D('info','优化被用户取消。'),!1;if(!i)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=i;const s=`\n                    <p><b>原始句子:</b></p>\n                    <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${a}</textarea>\n                    <p><b>优化后句子 (可编辑):</b></p>\n                    <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${i}</textarea>\n                `;let c;k?(D('info','[真·自动化] 自动确认步骤2。'),c=!0):c=await window.parent.SillyTavern.getContext().callGenericPopup(s,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0});const d=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return D('info','替换操作已由用户取消。'),!1;if(b!==h.RUNNING)return!1;D('info','正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(a,d,e=>{e&&D('success','SSC 替换完成！'),t()})})}else D('info','在最后一条角色消息中未找到可优化的内容，跳过SSC优化。')}else D('warning','未找到 AI Optimizer API，跳过优化步骤。');return D('info','等待2秒以确保系统稳定...'),await B(2e3),await async function(){D('info','正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:o}=t,a=/<\/?br\b[^>]*>/gi;if(a.test(o)){const e=o.replace(a,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),D('success','“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),D('error','执行“一键处理”时发生错误。',!0)}}(),await B(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),D('error',e.message,!0),!1}}async function F(e=!1){if(x)return console.log('[AutoRunner] Automation is already running. Setting pending flag.'),void(y=!0);if(b!==h.RUNNING||!(w.value.totalReplies<=0)&&w.value.executedCount>=w.value.totalReplies&&(D('info','已达到总回复次数，全自动运行结束。',!0),1))W();else try{x=!0,e||await M();const t=(getChatMessages(-1)||[])[0];if(!t)return D('error','无法获取最后一条消息，自动化暂停。',!0),void(b=h.PAUSED);if('user'===t.role)N=0,D('info','检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{if(!t.message||''===t.message.trim())return N>=w.value.maxRetries?(D('error',`主AI多次返回空消息，已达到最大重试次数 (${w.value.maxRetries})，自动化已停止。`,!0),void W({skipFinalProcessing:!0})):(N++,D('warning',`主AI返回空消息，将自动重新生成 (尝试 ${N}/${w.value.maxRetries})。`,!0),void await triggerSlash('/regenerate await=true'));N=0,D('info','检测到AI消息，开始完整循环...');if(!await G())return void W({skipFinalProcessing:!0,userCancelled:!0});if(b!==h.RUNNING)return void console.log('[AutoRunner] Automation was stopped during SSC/process phase. Aborting sub AI call.');let e=0,n=null;for(;e<=w.value.maxRetries;){if(b!==h.RUNNING)return void console.log('[AutoRunner] 自动化已停止，跳过副AI调用。');const t=await O();if(t===f)return void W({skipFinalProcessing:!0,userCancelled:!0});if(t){const e=L(t);if(console.log('处理后的回复:',e),e&&''!==e.trim()){n=e;break}D('warning','副AI返回的消息处理后为空，将重试...')}if(e++,e>w.value.maxRetries)return D('error',`调用副AI并获得有效回复已达到最大重试次数 (${w.value.maxRetries})，自动化已停止。`,!0),void W({skipFinalProcessing:!0});if(D('warning',`调用副AI失败或回复无效，将在5秒后重试 (${e}/${w.value.maxRetries})`),await B(5e3),b!==h.RUNNING)return void console.log('[AutoRunner] 自动化已停止，重试循环终止。')}if(!n)return;D('info','以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}'user'!==t.role&&await async function(){w.value.executedCount++,P.cancel();const e=JSON.parse(JSON.stringify(w.value));replaceVariables(e,{type:'script',script_id:getScriptId()})}()}catch(e){console.error('自动化循环出错:',e),D('error',`自动化循环发生意外错误: ${e.message}，流程已终止。`,!0),b=h.ERROR,W({skipFinalProcessing:!0})}finally{x=!1,y&&(console.log('[AutoRunner] Processing pending automation run.'),y=!1,setTimeout(()=>F(!1),100))}}function J(){b===h.RUNNING&&setTimeout(()=>F(!1),500)}function H(){b===h.RUNNING&&(w.value.conciseNotifications||D('warning','来自系统的停止信号，全自动运行已终止。'),W({skipFinalProcessing:!0}))}function K(){b===h.RUNNING?W():async function(){if(b===h.RUNNING)return;if(x=!1,!w.value.enabled)return void D('warning','脚本未启用，请先勾选“启用脚本”。',!0);await B(1e3),await M(),D('success','全自动运行已启动！',!0),b=h.RUNNING,E=0,N=0,V=0,w.value.executedCount=0,eventOn(tavern_events.MESSAGE_RECEIVED,J),eventOn(tavern_events.GENERATION_STOPPED,H),F(!0)}()}async function W(e={}){if(b===h.IDLE)return;let t;t=e.userCancelled?'用户取消了操作，全自动运行已停止。':e.skipFinalProcessing?'全自动运行已因错误而终止。':'全自动运行已停止。',D('info',t,!0),b=h.IDLE,x=!1,eventRemoveListener(tavern_events.MESSAGE_RECEIVED,J),eventRemoveListener(tavern_events.GENERATION_STOPPED,H),q(),triggerSlash('/stop');const n=window.parent.aiOptimizer;if(n&&'function'==typeof n.abortOptimization&&n.abortOptimization(),e.skipFinalProcessing)return w.value.conciseNotifications||D('warning','因发生错误而跳过最终处理，脚本已彻底结束。'),void(k&&(k=!1,D('info','“真·自动化”模式已随运行停止而关闭。')));D('info','正在对最后生成的消息执行最终处理...'),await B(1e3);const o=(getChatMessages(-1)||[])[0];if(o&&'assistant'===o.role){b=h.RUNNING;try{await G(!0)?D('success','最终处理完成，脚本已彻底结束。',!0):D('warning','最终处理被用户取消，脚本已彻底结束。',!0)}finally{b=h.IDLE}}else D('info','没有需要最终处理的AI消息，脚本已结束。');k&&(k=!1,D('info','“真·自动化”模式已随运行停止而关闭。'))}function q(){v&&(v.abort(),console.log('[AutoRunner] Abort signal sent to sub AI call.'))}function X(){q();const e=window.parent.aiOptimizer;e&&'function'==typeof e.abortOptimization&&e.abortOptimization(),W({skipFinalProcessing:!0,userCancelled:!0})}const Q={class:'flex-container flexFlowColumn'},Y=['onDragstart','onDrop'],Z={class:'rule-header'},ee=['onUpdate:modelValue'],te=['onUpdate:modelValue','readonly'],ne={class:'buttons'},oe=['onClick'],ae=['onClick'],re={key:0,class:'rule-body'},le=['onUpdate:modelValue'],ie={class:'attachments-section'},se={class:'attachment-list'},ce=['onClick'],de={class:'attachment-name'},ue=['onClick'],pe=['onClick'],me=['onUpdate:modelValue'],fe=(0,i.defineComponent)({__name:'PromptEditor',props:{entries:{}},emits:['update:entries'],setup(t,{emit:n}){const o=t,a=n,r=(0,i.ref)(null),l=(0,i.computed)(()=>o.entries.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function s(){a('update:entries',o.entries)}function d(){const e=u.parse({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'}),t=[...o.entries,e];a('update:entries',t)}let p=null;let m=-1;return(n,u)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',Q,[(0,i.createElementVNode)('div',null,[u[2]||(u[2]=(0,i.createElementVNode)('strong',null,'提示词设置',-1)),(0,i.createTextVNode)(' (总词符数: '+(0,i.toDisplayString)(l.value)+')',1)]),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(t.entries,(t,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:t.id,class:(0,i.normalizeClass)(['rule-item',{'chat-history-placeholder':t.is_chat_history}]),draggable:'true',onDragstart:e=>function(e){m=e}(n),onDragover:u[0]||(u[0]=(0,i.withModifiers)(()=>{},['prevent'])),onDrop:e=>function(e){if(-1===m||m===e)return;const t=[...o.entries],[n]=t.splice(m,1);t.splice(e,0,n),m=-1,a('update:entries',t)}(n)},[(0,i.createElementVNode)('div',Z,[u[4]||(u[4]=(0,i.createElementVNode)('span',{class:'drag-handle'},'☰',-1)),t.is_chat_history?(0,i.createCommentVNode)('v-if',!0):(0,i.withDirectives)(((0,i.openBlock)(),(0,i.createElementBlock)('input',{key:0,'onUpdate:modelValue':e=>t.enabled=e,type:'checkbox',class:'rule-toggle',onChange:s},null,40,ee)),[[i.vModelCheckbox,t.enabled]]),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':e=>t.name=e,type:'text',class:'text_pole rule-name',readonly:t.is_chat_history,placeholder:'条目名称',onInput:s},null,40,te),[[i.vModelText,t.name]]),(0,i.createElementVNode)('div',ne,[t.is_chat_history?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('button',{key:0,class:'menu_button icon-button',onClick:e=>function(e){e.editing=!e.editing,s()}(t)},[(0,i.createElementVNode)('i',{class:(0,i.normalizeClass)(['fa-solid',t.editing?'fa-folder-open':'fa-folder'])},null,2)],8,oe)),t.is_chat_history?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('button',{key:1,class:'menu_button icon-button',onClick:e=>function(e){const t=[...o.entries];t.splice(e,1),a('update:entries',t)}(n)},[...u[3]||(u[3]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])],8,ae))])]),t.editing&&!t.is_chat_history?((0,i.openBlock)(),(0,i.createElementBlock)('div',re,[(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':e=>t.content=e,class:'text_pole',placeholder:'提示词内容...',onInput:s},null,40,le),[[i.vModelText,t.content]]),(0,i.createElementVNode)('div',ie,[(0,i.createElementVNode)('div',se,[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(t.attachments,(n,o)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:n.id,class:'attachment-item',title:'点击查看附件',onClick:(0,i.withModifiers)(t=>async function(t){const{name:n,type:o,content:a}=t,r=window.parent.SillyTavern.getContext(),l=atob(a),i=l.length,s=new Uint8Array(i);for(let e=0;e<i;e++)s[e]=l.charCodeAt(e);const c=s.buffer,d=new Blob([c],{type:o}),u=URL.createObjectURL(d);if(o.startsWith('image/')){const e=`<div style="text-align: center;"><img src="${u}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;"></div>`;r.callGenericPopup(e,'查看图片',n,{okButton:'关闭',wide:!0}),setTimeout(()=>URL.revokeObjectURL(u),500)}else if(o.startsWith('text/')||'application/json'===o){const e=new FileReader;e.onload=e=>{const t=e.target?.result,o=`<textarea class="text_pole" rows="20" style="width: 100%;" readonly>${t}</textarea>`;r.callGenericPopup(o,'查看文本',n,{okButton:'关闭',wide:!0}),URL.revokeObjectURL(u)},e.onerror=()=>{toastr.error('读取文件内容失败。'),URL.revokeObjectURL(u)},e.readAsText(d,'UTF-8')}else if('application/pdf'===o){const e=`<iframe src="${u}" style="width: 100%; height: 80vh;" frameborder="0"></iframe>`;r.callGenericPopup(e,'查看PDF',n,{okButton:'关闭',wide:!0})}else if('application/vnd.openxmlformats-officedocument.wordprocessingml.document'===o)try{const t=`<div class="prose" style="padding: 10px; background: var(--bg1); border-radius: 8px; max-height: 70vh; overflow-y: auto;">${(await e.convertToHtml({arrayBuffer:c})).value}</div>`;r.callGenericPopup(t,'查看DOCX',n,{okButton:'关闭',wide:!0})}catch(e){console.error('转换DOCX到HTML时出错:',e),toastr.error('预览 .docx 文件失败。')}finally{URL.revokeObjectURL(u)}else toastr.info(`不支持预览文件类型 "${o}"。`),URL.revokeObjectURL(u)}(n),['stop'])},[(0,i.createElementVNode)('span',de,(0,i.toDisplayString)(n.name),1),(0,i.createElementVNode)('button',{class:'menu_button icon-button delete-attachment-btn',title:'删除附件',onClick:(0,i.withModifiers)(e=>function(e,t){e.attachments&&(e.attachments.splice(t,1),s())}(t,o),['stop'])},[...u[5]||(u[5]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-times'},null,-1)])],8,ue)],8,ce))),128))]),(0,i.createElementVNode)('button',{class:'menu_button attachment-button',onClick:e=>function(e){p=e,r.value?.click()}(t)},'添加附件',8,pe)]),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':e=>t.role=e,class:'text_pole',onChange:s},[...u[6]||(u[6]=[(0,i.createElementVNode)('option',null,'user',-1),(0,i.createElementVNode)('option',null,'system',-1),(0,i.createElementVNode)('option',null,'assistant',-1)])],40,me),[[i.vModelSelect,t.role]])])):(0,i.createCommentVNode)('v-if',!0)],42,Y))),128)),(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:d},'添加提示词条目'),(0,i.createElementVNode)('input',{ref_key:'fileInputRef',ref:r,type:'file',multiple:'',style:{display:'none'},onChange:u[1]||(u[1]=e=>async function(e){if(!p)return;const t=p,n=e.target;if(!n.files)return;const o=Array.from(n.files);for(const e of o){const n=new FileReader;n.onload=n=>{const o=(n.target?.result).split(',')[1];if(o){const n=c.parse({name:e.name,type:e.type,content:o});t.attachments||(t.attachments=[]),t.attachments.push(n),s()}},n.readAsDataURL(e)}n.value=''}(e))},null,544)]))}});a(988);var ge=a(441);const ve=(0,ge.A)(fe,[['__scopeId','data-v-75809739']]),he={class:'inline-drawer'},be={class:'inline-drawer-content'},xe={class:'flex-container flexFlowColumn',style:{'padding-bottom':'0.5em'}},ye={class:'checkbox_label',for:'auto_runner_enabled'},we={class:'section-wrapper'},_e={class:'section-content'},Ee={class:'set-manager'},Ne=['value'],Ve={class:'set-buttons'},ke={class:'set-manager',style:{'margin-top':'10px'}},Se={class:'section-wrapper'},Re={class:'section-content'},Ae={class:'rule-header'},Ie=['onUpdate:modelValue'],Ce=['onUpdate:modelValue'],Ue=['onClick'],Pe={class:'rule-body'},$e=['onUpdate:modelValue'],ze=['onUpdate:modelValue'],De={class:'section-wrapper'},Te={class:'section-content'},Be={class:'rule-header'},Me=['onUpdate:modelValue'],Oe=['onUpdate:modelValue'],Le=['onClick'],je={class:'rule-body'},Ge=['onUpdate:modelValue'],Fe=['onUpdate:modelValue'],Je={class:'section-wrapper'},He={class:'section-content flex-container flexFlowColumn'},Ke={key:0,value:''},We=['value'],qe={for:'auto_runner_temperature'},Xe={for:'auto_runner_top_p'},Qe={for:'auto_runner_top_k'},Ye={for:'auto_runner_max_tokens'},Ze={class:'section-wrapper'},et={class:'section-content flex-container flexFlowColumn'},tt={class:'checkbox_label',for:'auto_runner_concise_notifications'},nt={id:'auto_runner_executed_count',class:'text_pole'},ot=['disabled','title'],at=(0,i.defineComponent)({__name:'app',setup(e){const t=(0,i.ref)([]);(0,i.watch)(()=>w.value.enabled,(e,t)=>{!1===e&&!0===t&&W()}),(0,i.onMounted)(()=>{w.value.model&&!t.value.includes(w.value.model)&&t.value.push(w.value.model)});const n=e=>{if(S.value){const t=w.value.promptSets.find(e=>e.id===S.value.id);t&&(t.promptEntries=e)}},o=e=>{const t=d.parse({});'context'===e?w.value.contextRegexRules.push(t):w.value.subAiRegexRules.push(t)},a=(e,t)=>{'context'===e?w.value.contextRegexRules.splice(t,1):w.value.subAiRegexRules.splice(t,1)},r=async()=>{if(w.value.apiUrl)try{const e=await fetch(`${w.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=(await e.json()).data.map(e=>e.id);t.value=l().union(t.value,n),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,l)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',he,[l[47]||(l[47]=(0,i.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,i.createElementVNode)('b',null,'自动化运行脚本设置'),(0,i.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,i.createElementVNode)('div',be,[(0,i.createElementVNode)('div',xe,[(0,i.createElementVNode)('label',ye,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':l[0]||(l[0]=e=>(0,i.unref)(w).enabled=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(w).enabled]]),l[21]||(l[21]=(0,i.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),(0,i.createElementVNode)('div',we,[l[26]||(l[26]=(0,i.createElementVNode)('input',{type:'checkbox',id:'section-toggle-prompts',class:'section-toggle-checkbox'},null,-1)),l[27]||(l[27]=(0,i.createElementVNode)('label',{for:'section-toggle-prompts',class:'section-header'},[(0,i.createElementVNode)('strong',null,'提示词配置集'),(0,i.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,i.createElementVNode)('div',_e,[(0,i.createElementVNode)('div',Ee,[(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':l[1]||(l[1]=e=>(0,i.unref)(w).activePromptSetId=e),class:'text_pole set-select'},[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)((0,i.unref)(w).promptSets,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e.id,value:e.id},(0,i.toDisplayString)(e.name),9,Ne))),128))],512),[[i.vModelSelect,(0,i.unref)(w).activePromptSetId]]),(0,i.createElementVNode)('div',Ve,[(0,i.createElementVNode)('button',{class:'menu_button icon-button',title:'新建配置',onClick:l[2]||(l[2]=(...e)=>(0,i.unref)(R)&&(0,i.unref)(R)(...e))},[...l[22]||(l[22]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])]),(0,i.createElementVNode)('button',{class:'menu_button icon-button',title:'重命名当前配置',onClick:l[3]||(l[3]=(...e)=>(0,i.unref)(A)&&(0,i.unref)(A)(...e))},[...l[23]||(l[23]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-pen-to-square'},null,-1)])]),(0,i.createElementVNode)('button',{class:'menu_button icon-button danger',title:'删除当前配置',onClick:l[4]||(l[4]=(...e)=>(0,i.unref)(I)&&(0,i.unref)(I)(...e))},[...l[24]||(l[24]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])])])]),(0,i.createElementVNode)('div',ke,[(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:l[5]||(l[5]=(...e)=>(0,i.unref)(U)&&(0,i.unref)(U)(...e))},'导入配置'),(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:l[6]||(l[6]=(...e)=>(0,i.unref)(C)&&(0,i.unref)(C)(...e))},'导出当前配置')]),l[25]||(l[25]=(0,i.createElementVNode)('hr',{style:{margin:'15px 0'}},null,-1)),(0,i.createVNode)(ve,{entries:(0,i.unref)(S).promptEntries,'onUpdate:entries':n},null,8,['entries'])])]),(0,i.createElementVNode)('div',Se,[l[29]||(l[29]=(0,i.createElementVNode)('input',{type:'checkbox',id:'section-toggle-context-regex',class:'section-toggle-checkbox'},null,-1)),l[30]||(l[30]=(0,i.createElementVNode)('label',{for:'section-toggle-context-regex',class:'section-header'},[(0,i.createElementVNode)('strong',null,'上下文正则处理'),(0,i.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,i.createElementVNode)('div',Re,[l[28]||(l[28]=(0,i.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)((0,i.unref)(w).contextRegexRules,(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,i.createElementVNode)('div',Ae,[(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,Ie),[[i.vModelCheckbox,e.enabled]]),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,Ce),[[i.vModelText,e.name]]),(0,i.createElementVNode)('button',{class:'menu_button',onClick:e=>a('context',t)},'删除',8,Ue)]),(0,i.createElementVNode)('div',Pe,[(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,$e),[[i.vModelText,e.find]]),(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,ze),[[i.vModelText,e.replace]])])]))),128)),(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:l[7]||(l[7]=e=>o('context'))},'添加上下文规则')])]),(0,i.createElementVNode)('div',De,[l[32]||(l[32]=(0,i.createElementVNode)('input',{type:'checkbox',id:'section-toggle-subai-regex',class:'section-toggle-checkbox'},null,-1)),l[33]||(l[33]=(0,i.createElementVNode)('label',{for:'section-toggle-subai-regex',class:'section-header'},[(0,i.createElementVNode)('strong',null,'副AI输出正则处理'),(0,i.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,i.createElementVNode)('div',Te,[l[31]||(l[31]=(0,i.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)((0,i.unref)(w).subAiRegexRules,(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,i.createElementVNode)('div',Be,[(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,Me),[[i.vModelCheckbox,e.enabled]]),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,Oe),[[i.vModelText,e.name]]),(0,i.createElementVNode)('button',{class:'menu_button',onClick:e=>a('subAi',t)},'删除',8,Le)]),(0,i.createElementVNode)('div',je,[(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Ge),[[i.vModelText,e.find]]),(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,Fe),[[i.vModelText,e.replace]])])]))),128)),(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:l[8]||(l[8]=e=>o('subAi'))},'添加副AI输出规则')])]),(0,i.createElementVNode)('div',Je,[l[37]||(l[37]=(0,i.createElementVNode)('input',{type:'checkbox',id:'section-toggle-api',class:'section-toggle-checkbox'},null,-1)),l[38]||(l[38]=(0,i.createElementVNode)('label',{for:'section-toggle-api',class:'section-header'},[(0,i.createElementVNode)('strong',null,'API 调用设置'),(0,i.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,i.createElementVNode)('div',He,[l[34]||(l[34]=(0,i.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':l[9]||(l[9]=e=>(0,i.unref)(w).apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[i.vModelText,(0,i.unref)(w).apiUrl]]),l[35]||(l[35]=(0,i.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':l[10]||(l[10]=e=>(0,i.unref)(w).apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[i.vModelText,(0,i.unref)(w).apiKey]]),(0,i.createElementVNode)('div',{class:'flex-container'},[(0,i.createElementVNode)('button',{class:'menu_button wide-button',onClick:r},'获取模型')]),l[36]||(l[36]=(0,i.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':l[11]||(l[11]=e=>(0,i.unref)(w).model=e),class:'text_pole'},[(0,i.unref)(w).model?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('option',Ke,'请先获取模型')),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(t.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e,value:e},(0,i.toDisplayString)(e),9,We))),128))],512),[[i.vModelSelect,(0,i.unref)(w).model]]),(0,i.createElementVNode)('label',qe,'Temperature: '+(0,i.toDisplayString)((0,i.unref)(w).temperature),1),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':l[12]||(l[12]=e=>(0,i.unref)(w).temperature=e),type:'range',step:'0.01',min:'0',max:'2'},null,512),[[i.vModelText,(0,i.unref)(w).temperature,void 0,{number:!0}]]),(0,i.createElementVNode)('label',Xe,'Top P: '+(0,i.toDisplayString)((0,i.unref)(w).top_p),1),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':l[13]||(l[13]=e=>(0,i.unref)(w).top_p=e),type:'range',step:'0.01',min:'0',max:'1'},null,512),[[i.vModelText,(0,i.unref)(w).top_p,void 0,{number:!0}]]),(0,i.createElementVNode)('label',Qe,'Top K: '+(0,i.toDisplayString)((0,i.unref)(w).top_k),1),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':l[14]||(l[14]=e=>(0,i.unref)(w).top_k=e),type:'range',step:'1',min:'0',max:'500'},null,512),[[i.vModelText,(0,i.unref)(w).top_k,void 0,{number:!0}]]),(0,i.createElementVNode)('label',Ye,'Max Tokens: '+(0,i.toDisplayString)((0,i.unref)(w).max_tokens),1),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':l[15]||(l[15]=e=>(0,i.unref)(w).max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[i.vModelText,(0,i.unref)(w).max_tokens,void 0,{number:!0}]])])]),(0,i.createElementVNode)('div',Ze,[l[45]||(l[45]=(0,i.createElementVNode)('input',{type:'checkbox',id:'section-toggle-automation',class:'section-toggle-checkbox'},null,-1)),l[46]||(l[46]=(0,i.createElementVNode)('label',{for:'section-toggle-automation',class:'section-header'},[(0,i.createElementVNode)('strong',null,'自动化设置'),(0,i.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,i.createElementVNode)('div',et,[l[41]||(l[41]=(0,i.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':l[16]||(l[16]=e=>(0,i.unref)(w).totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[i.vModelText,(0,i.unref)(w).totalReplies,void 0,{number:!0}]]),l[42]||(l[42]=(0,i.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':l[17]||(l[17]=e=>(0,i.unref)(w).maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[i.vModelText,(0,i.unref)(w).maxRetries,void 0,{number:!0}]]),l[43]||(l[43]=(0,i.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':l[18]||(l[18]=e=>(0,i.unref)(w).exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[i.vModelText,(0,i.unref)(w).exemptionCount,void 0,{number:!0}]]),(0,i.createElementVNode)('label',tt,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto_runner_concise_notifications','onUpdate:modelValue':l[19]||(l[19]=e=>(0,i.unref)(w).conciseNotifications=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(w).conciseNotifications]]),l[39]||(l[39]=(0,i.createElementVNode)('span',null,'简洁通知模式',-1))]),l[44]||(l[44]=(0,i.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,i.createElementVNode)('div',nt,(0,i.toDisplayString)((0,i.unref)(w).executedCount),1),(0,i.createElementVNode)('button',{disabled:!(0,i.unref)(g),class:(0,i.normalizeClass)(['menu_button','wide-button',{danger:(0,i.unref)(g)}]),style:{'margin-top':'15px'},onClick:l[20]||(l[20]=(...e)=>(0,i.unref)(q)&&(0,i.unref)(q)(...e)),title:(0,i.unref)(g)?'点击以中止请求':'（无正在进行的请求）'},[l[40]||(l[40]=(0,i.createElementVNode)('i',{class:'fa-solid fa-stop'},null,-1)),(0,i.createTextVNode)(' '+(0,i.toDisplayString)(((0,i.unref)(g),'中断副 AI')),1)],10,ot)])])])]))}});a(972);const rt=(0,ge.A)(at,[['__scopeId','data-v-598ca2f0']]),lt=(0,i.createApp)(rt);function it(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const e=$('#extensions_settings2');if(0===e.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());e.append(n),lt.use(t()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function st(){lt.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(async()=>{await M(),it(),eventOn(getButtonEvent('全自动运行'),K),initializeGlobal('AutoRunnerCore',{toggleTrulyAutomatedMode:j,abortSubAICall:q,abortAll:X})}),$(window).on('pagehide',()=>{st(),W(),eventRemoveListener(getButtonEvent('全自动运行'),K)});