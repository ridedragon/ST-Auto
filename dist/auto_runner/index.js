import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',a=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),a&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),a&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,a,o,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(a)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);a&&l[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),o&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=o):d[4]=''.concat(o)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},254:(e,t,n)=>{var a=n(464);a.__esModule&&(a=a.default),'string'==typeof a&&(a=[[e.id,a,'']]),a.locals&&(e.exports=a.locals);(0,n(424).A)('35138d8e',a,!1,{ssrId:!0})},424:(e,t,n)=>{function a(e,t){for(var n=[],a={},o=0;o<t.length;o++){var r=t[o],l=r[0],i={id:e+':'+o,css:r[1],media:r[2],sourceMap:r[3]};a[l]?a[l].parts.push(i):n.push(a[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>f});var o='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!o)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=o&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,o){c=n,u=o||{};var l=a(e,t);return g(l),function(t){for(var n=[],o=0;o<l.length;o++){var i=l[o];(s=r[i.id]).refs--,n.push(s)}t?g(l=a(e,t)):l=[];for(o=0;o<n.length;o++){var s;if(0===(s=n[o]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete r[s.id]}}}}function g(e){for(var t=0;t<e.length;t++){var n=e[t],a=r[n.id];if(a){a.refs++;for(var o=0;o<a.parts.length;o++)a.parts[o](n.parts[o]);for(;o<n.parts.length;o++)a.parts.push(h(n.parts[o]));a.parts.length>n.parts.length&&(a.parts.length=n.parts.length)}else{var l=[];for(o=0;o<n.parts.length;o++)l.push(h(n.parts[o]));r[n.id]={id:n.id,refs:1,parts:l}}}}function v(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function h(e){var t,n,a=document.querySelector('style['+p+'~="'+e.id+'"]');if(a){if(c)return d;a.parentNode.removeChild(a)}if(m){var o=s++;a=i||(i=v()),t=y.bind(null,a,o,!1),n=y.bind(null,a,o,!0)}else a=v(),t=E.bind(null,a),n=function(){a.parentNode.removeChild(a)};return t(e),function(a){if(a){if(a.css===e.css&&a.media===e.media&&a.sourceMap===e.sourceMap)return;t(e=a)}else n()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function y(e,t,n,a){var o=n?'':a.css;if(e.styleSheet)e.styleSheet.cssText=x(t,o);else{var r=document.createTextNode(o),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function E(e,t){var n=t.css,a=t.media,o=t.sourceMap;if(a&&e.setAttribute('media',a),u.ssrId&&e.setAttribute(p,t.id),o&&(n+='\n/*# sourceURL='+o.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},441:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,a]of t)n[e]=a;return n}},464:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var a=n(93),o=n.n(a),r=n(54),l=n.n(r)()(o());l.push([e.id,'.rule-header[data-v-22dbfac6]{display:flex;align-items:center;gap:10px}.drag-handle[data-v-22dbfac6]{cursor:grab}.rule-name[data-v-22dbfac6]{flex-grow:1;min-width:50px}.buttons[data-v-22dbfac6]{display:flex;flex-shrink:0;gap:5px}.icon-button[data-v-22dbfac6]{padding:4px 8px;line-height:1}.rule-body select[data-v-22dbfac6]{margin-top:5px}.attachments-section[data-v-22dbfac6]{margin-top:10px}.attachment-list[data-v-22dbfac6]{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px}.attachment-item[data-v-22dbfac6]{background-color:var(--bg2);padding:2px 8px;border-radius:12px;display:flex;align-items:center;gap:5px;font-size:.9em;max-width:100%;overflow:hidden}.attachment-name[data-v-22dbfac6]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-grow:1;min-width:0}.delete-attachment-btn[data-v-22dbfac6]{flex-shrink:0}.attachment-button[data-v-22dbfac6]{white-space:nowrap}.delete-attachment-btn i[data-v-22dbfac6]{color:#f55}.delete-attachment-btn:hover i[data-v-22dbfac6]{color:#f88}.wide-button[data-v-22dbfac6]{width:100%;margin-top:10px}.chat-history-placeholder[data-v-22dbfac6]{background-color:var(--bg3) !important}','']);const i=l},966:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var a=n(93),o=n.n(a),r=n(54),l=n.n(r)()(o());l.push([e.id,'.section-wrapper[data-v-598ca2f0]{border-top:1px solid var(--bg2)}.section-wrapper[data-v-598ca2f0]:first-of-type{border-top:none}.section-wrapper[data-v-598ca2f0]:last-of-type{border-bottom:1px solid var(--bg2);margin-bottom:1em}.section-toggle-checkbox[data-v-598ca2f0]{display:none}.section-header[data-v-598ca2f0]{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:.25em 4px;border-radius:4px;transition:background-color .2s ease}.section-header[data-v-598ca2f0]:hover{background-color:var(--bg2-trans)}.section-header strong[data-v-598ca2f0]{font-size:1.1em}.section-header i[data-v-598ca2f0]{transition:transform .3s ease}.section-content[data-v-598ca2f0]{display:none;padding:10px 4px 0}.section-toggle-checkbox:checked+.section-header i[data-v-598ca2f0]{transform:rotate(90deg)}.section-toggle-checkbox:checked~.section-content[data-v-598ca2f0]{display:block}.wide-button[data-v-598ca2f0]{width:100%;margin-top:10px}label[data-v-598ca2f0]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-598ca2f0]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-598ca2f0]{width:100%}.description[data-v-598ca2f0]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-598ca2f0]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-598ca2f0]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-598ca2f0]{transform:scale(1.2)}.rule-name[data-v-598ca2f0]{flex-grow:1}.rule-body[data-v-598ca2f0]{display:flex;flex-direction:column;gap:5px}.set-manager[data-v-598ca2f0]{display:flex;gap:10px;align-items:center}.set-select[data-v-598ca2f0]{flex-grow:1}.set-buttons[data-v-598ca2f0]{display:flex;gap:5px}.icon-button[data-v-598ca2f0]{padding:6px 10px;line-height:1;flex-shrink:0}','']);const i=l},972:(e,t,n)=>{var a=n(966);a.__esModule&&(a=a.default),'string'==typeof a&&(a=[[e.id,a,'']]),a.locals&&(e.exports=a.locals);(0,n(424).A)('1b892f60',a,!1,{ssrId:!0})}},n={};function a(e){var o=n[e];if(void 0!==o)return o.exports;var r=n[e]={id:e,exports:{}};return t[e](r,r.exports,a),r.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const o=_;var r=a.n(o);const l=Vue,i=z,s=i.z.object({id:i.z.string().default(()=>`attachment_${Date.now()}_${Math.random()}`),name:i.z.string(),type:i.z.string(),content:i.z.string()}),c=i.z.object({id:i.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:i.z.string().default(''),find:i.z.string().default(''),replace:i.z.string().default(''),enabled:i.z.boolean().default(!0)}),d=i.z.object({id:i.z.string().default(()=>`prompt_${Date.now()}_${Math.random()}`),name:i.z.string(),content:i.z.string(),attachments:i.z.array(s).optional().default([]),enabled:i.z.boolean(),editing:i.z.boolean(),role:i.z.enum(['user','system','assistant']),is_chat_history:i.z.boolean().optional().default(!1)}),u=i.z.object({id:i.z.string().default(()=>`set_${Date.now()}_${Math.random()}`),name:i.z.string(),promptEntries:i.z.array(d)}),p=i.z.object({enabled:i.z.boolean().default(!0),promptSets:i.z.array(u).default([]),activePromptSetId:i.z.string().nullable().default(null),apiUrl:i.z.preprocess(e=>e??'',i.z.string()),apiKey:i.z.preprocess(e=>e??'',i.z.string()),model:i.z.preprocess(e=>e??'',i.z.string()),temperature:i.z.number().min(0).max(2).default(.7),top_p:i.z.number().min(0).max(1).default(1),top_k:i.z.number().min(0).default(40),max_tokens:i.z.coerce.number().min(1).default(1024),totalReplies:i.z.coerce.number().min(1).default(10),executedCount:i.z.coerce.number().min(0).default(0),contextRegexRules:i.z.array(c).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:i.z.array(c).default([]),maxRetries:i.z.coerce.number().min(0).default(3),exemptionCount:i.z.coerce.number().min(0).default(0),conciseNotifications:i.z.boolean().default(!1)}),m=Symbol('ABORT_SIGNAL'),f=(0,l.ref)(!1);let g=null;var v;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(v||(v={}));let h=v.IDLE,b=!1,x=!1;const y=(0,l.ref)(p.parse({}));let E=0,N=0,w=!1;const V=(0,l.computed)(()=>{const e=y.value.promptSets.find(e=>e.id===y.value.activePromptSetId);return e||u.parse({name:'（无有效配置）',promptEntries:[]})});function k(){const e=window.prompt('请输入新配置的名称：',`新配置 ${y.value.promptSets.length+1}`);if(!e)return;const t=d.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=u.parse({name:e,promptEntries:[t]});y.value.promptSets.push(n),y.value.activePromptSetId=n.id,U('success',`已创建新配置 "${e}"`)}function S(){const e=V.value;if(!e||'（无有效配置）'===e.name)return;const t=window.prompt('请输入新的名称：',e.name);if(t&&t!==e.name){const n=y.value.promptSets.find(t=>t.id===e.id);n&&(n.name=t,U('success','配置已重命名'))}}function R(){if(y.value.promptSets.length<=1)return void U('error','无法删除最后一个配置集',!0);const e=V.value;if(!e||!window.confirm(`确定要删除配置 "${e.name}" 吗？此操作不可撤销。`))return;const t=y.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(y.value.promptSets.splice(t,1),y.value.activePromptSetId=y.value.promptSets[Math.max(0,t-1)]?.id||null,U('success',`配置 "${e.name}" 已删除`))}function A(){const e=V.value;if(!e||'（无有效配置）'===e.name)return void U('error','没有可导出的有效配置。');const t={version:2,promptSet:e,contextRegexRules:y.value.contextRegexRules,subAiRegexRules:y.value.subAiRegexRules},n=JSON.stringify(t,null,2),a=new Blob([n],{type:'application/json'}),o=URL.createObjectURL(a),r=document.createElement('a');r.href=o,r.download=`[AutoRunner] ${e.name}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),U('success','当前完整预设（提示词+正则）已导出')}function I(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n);if(2===e.version&&e.promptSet){const{promptSet:t,contextRegexRules:n,subAiRegexRules:a}=e,o=u.safeParse(t);if(!o.success)return void U('error','导入的提示词配置部分格式无效。',!0);{let e=y.value.promptSets.find(e=>e.name===o.data.name);if(e){if(window.confirm(`已存在名为 "${o.data.name}" 的提示词配置。要覆盖它吗？`)){const t=y.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(o.data.id=e.id,y.value.promptSets[t]=o.data)}}else o.data.id=`set_${Date.now()}_${Math.random()}`,y.value.promptSets.push(o.data);y.value.activePromptSetId=o.data.id,U('success',`提示词配置 "${o.data.name}" 已导入并激活。`)}if(n&&a&&window.confirm('文件包含正则规则。要用导入的规则覆盖当前的上下文和副AI正则规则吗？')){const e=i.z.array(c).safeParse(n),t=i.z.array(c).safeParse(a);e.success&&t.success?(y.value.contextRegexRules=e.data,y.value.subAiRegexRules=t.data,U('success','上下文和副AI正则规则已成功导入。')):U('error','导入的正则规则部分格式无效。',!0)}}else{const t=Array.isArray(e)?e:[e];let n=0;for(const e of t){const t=u.safeParse(e);if(t.success){if(y.value.promptSets.some(e=>e.name===t.data.name)){if(!window.confirm(`已存在名为 "${t.data.name}" 的配置。要覆盖它吗？`))continue;const e=y.value.promptSets.findIndex(e=>e.name===t.data.name);e>-1&&y.value.promptSets.splice(e,1)}t.data.id=`set_${Date.now()}_${Math.random()}`,y.value.promptSets.push(t.data),n++}else console.error('导入的数据格式无效:',t.error),U('error','一个或多个导入的配置格式无效，详情请查看控制台。',!0)}n>0&&U('success',`成功导入 ${n} 个旧格式的配置。`)}}catch(e){console.error('导入失败:',e),U('error','导入文件失败，请确保是有效的JSON文件。',!0)}},e.click()}const C=r().debounce(e=>{const t=JSON.parse(JSON.stringify(e));replaceVariables(t,{type:'script',script_id:getScriptId()}),console.log('[AutoRunner] Settings saved.')},500);function U(e,t,n=!1){y.value.conciseNotifications&&!n||toastr[e](t)}function P(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let a,o;if(t?(a=t[1],o=t[2]):(a=e.find,o='g'),a.startsWith('^')&&o.includes('g')){const t=o.replace('g',''),r=new RegExp(a,t);for(;r.test(n);)n=n.replace(r,e.replace)}else{const t=new RegExp(a,o);n=n.replace(t,e.replace)}}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}(0,l.watch)(y,e=>{C(e)},{deep:!0});const D=e=>new Promise(t=>setTimeout(t,e));async function M(){const e=getVariables({type:'script',script_id:getScriptId()})||{},t=JSON.parse(JSON.stringify(e)),n=p.safeParse(t);if(n.success){const e=n.data;let t=!1;if(0===e.promptSets.length){const n=d.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),a=u.parse({name:'默认配置',promptEntries:[n]});e.promptSets.push(a),e.activePromptSetId=a.id,t=!0,U('info','未找到任何配置，已创建默认配置。')}else for(const n of e.promptSets)if(!n.promptEntries.some(e=>e.is_chat_history)){const e=d.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});n.promptEntries.unshift(e),t=!0,U('info',`为配置 "${n.name}" 补全了缺失的“聊天记录”条目。`)}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,t=!0),y.value=e,t&&(C.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}))}else{console.error('[AutoRunner] 加载或解析设置失败:',n.error),U('error','加载设置时发现不兼容的数据，将尝试迁移。您的部分设置可能已重置。',!0);const e=p.parse({});for(const n in e)if(Object.prototype.hasOwnProperty.call(t,n)){const a=n,o=p.shape[a].safeParse(t[a]);o.success?e[a]=o.data:console.warn(`[AutoRunner] 无法迁移字段 "${a}"，将使用默认值。错误:`,o.error)}let a=!1;if(0===e.promptSets.length){const t=d.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=u.parse({name:'默认配置',promptEntries:[t]});e.promptSets.push(n),e.activePromptSetId=n.id,a=!0}else for(const t of e.promptSets)if(!t.promptEntries.some(e=>e.is_chat_history)){const e=d.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});t.promptEntries.unshift(e),a=!0}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,a=!0),y.value=e,C.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}),U('success','数据迁移完成。请检查您的设置。',!0)}}async function T(){toastr.info('正在向副AI发送消息...',void 0,{timeOut:0,extendedTimeOut:0,closeButton:!1,tapToDismiss:!1});f.value=!0,g=new AbortController;try{const e=await getLastMessageId(),t=getChatMessages(`0-${e}`);if(!t||0===t.length)return U('error','无法获取聊天记录',!0),null;const n=[],a=t.filter(e=>'system'!==e.role).map(e=>{const t=P(e.message,y.value.contextRegexRules);return{role:e.role,content:[t]}});for(const e of V.value.promptEntries)if(e.is_chat_history)n.push(...a);else if(e.enabled){const t=[];if(e.content&&t.push(e.content),e.attachments&&e.attachments.length>0)for(const n of e.attachments)if(n.type.startsWith('image/'))t.push({type:'image_url',image_url:{url:`data:${n.type};base64,${n.content}`}});else try{const e=atob(n.content);t.push(`\n\n--- Attachment: ${n.name} ---\n${e}\n--- End Attachment ---`)}catch(e){console.error(`Error decoding attachment ${n.name}:`,e)}t.length>0&&n.push({role:e.role,content:t})}const o=n.map(e=>{if(Array.isArray(e.content)&&e.content.length>1){const t=e.content.map(e=>'string'==typeof e?{type:'text',text:e}:e).filter(Boolean);return{...e,content:t}}return{...e,content:Array.isArray(e.content)?e.content.join('\n'):e.content}}),r={model:y.value.model,messages:o,temperature:y.value.temperature,top_p:y.value.top_p,top_k:y.value.top_k,max_tokens:y.value.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',r),y.value.conciseNotifications||U('info','完整的请求信息已打印到控制台 (F12)。');const l=await fetch(`${y.value.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${y.value.apiKey}`},body:JSON.stringify(r),signal:g.signal});if(!l.ok)throw new Error(`副AI API 请求失败: ${l.statusText}`);const i=await l.json(),s=i.choices[0]?.message?.content;if(!s)throw new Error('副AI未返回有效内容');return U('success','副AI响应成功'),s}catch(e){return'AbortError'===e.name?(U('warning','已中止向副AI发送消息。',!0),m):(console.error('调用副AI时出错:',e),U('error',`调用副AI失败: ${e.message}`,!0),null)}finally{toastr.clear(),f.value=!1,g=null}}function B(){w=!w,U('info','“真·自动化”模式已'+(w?'开启':'关闭'),!0)}async function O(e=!1){if(!e&&N<y.value.exemptionCount)return U('info',`豁免计数 (${N+1}/${y.value.exemptionCount})，跳过SSC和一键处理。`),N++,!0;try{const e=window.parent.aiOptimizer;if(e&&'function'==typeof e.manualOptimize&&'function'==typeof e.optimizeText){U('info','自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`;let a;w?(U('info','[真·自动化] 自动确认步骤1。'),a=!0):a=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0});const o=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!a)return U('info','自动化流程已由用户在步骤1取消。'),!1;if(h!==v.RUNNING)return!1;U('info','正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',i=await e.optimizeText(o,l,r);if(null===i)return U('info','优化被用户取消。'),!1;if(!i)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=i;const s=`\n                    <p><b>原始句子:</b></p>\n                    <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${o}</textarea>\n                    <p><b>优化后句子 (可编辑):</b></p>\n                    <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${i}</textarea>\n                `;let c;w?(U('info','[真·自动化] 自动确认步骤2。'),c=!0):c=await window.parent.SillyTavern.getContext().callGenericPopup(s,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0});const d=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return U('info','替换操作已由用户取消。'),!1;if(h!==v.RUNNING)return!1;U('info','正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(o,d,e=>{e&&U('success','SSC 替换完成！'),t()})})}else U('info','在最后一条角色消息中未找到可优化的内容，跳过SSC优化。')}else U('warning','未找到 AI Optimizer API，跳过优化步骤。');return U('info','等待2秒以确保系统稳定...'),await D(2e3),await async function(){U('info','正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:a}=t,o=/<\/?br\b[^>]*>/gi;if(o.test(a)){const e=a.replace(o,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),U('success','“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),U('error','执行“一键处理”时发生错误。',!0)}}(),await D(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),U('error',e.message,!0),!1}}async function L(e=!1){if(b)return console.log('[AutoRunner] Automation is already running. Setting pending flag.'),void(x=!0);if(h!==v.RUNNING||!(y.value.totalReplies<=0)&&y.value.executedCount>=y.value.totalReplies&&(U('info','已达到总回复次数，全自动运行结束。',!0),1))J();else try{b=!0,e||await M();const t=(getChatMessages(-1)||[])[0];if(!t)return U('error','无法获取最后一条消息，自动化暂停。',!0),void(h=v.PAUSED);if('user'===t.role)U('info','检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{U('info','检测到AI消息，开始完整循环...');if(!await O())return void J({skipFinalProcessing:!0,userCancelled:!0});if(h!==v.RUNNING)return void console.log('[AutoRunner] Automation was stopped during SSC/process phase. Aborting sub AI call.');let e=null,t=0;for(;t<=y.value.maxRetries;){const n=await T();if(n===m)return void J({skipFinalProcessing:!0,userCancelled:!0});if(n){e=n;break}if(t++,t>y.value.maxRetries)return U('error',`调用副AI已达到最大重试次数 (${y.value.maxRetries})，自动化已停止。`,!0),void J({skipFinalProcessing:!0});U('warning',`调用副AI失败，将在5秒后重试 (${t}/${y.value.maxRetries})`),await D(5e3)}if(!e)return;const n=P(e,y.value.subAiRegexRules);console.log('处理后的回复:',n),U('info','以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}'user'!==t.role&&await async function(){y.value.executedCount++,C.cancel();const e=JSON.parse(JSON.stringify(y.value));replaceVariables(e,{type:'script',script_id:getScriptId()})}()}catch(e){console.error('自动化循环出错:',e),U('error',`自动化循环发生意外错误: ${e.message}，流程已终止。`,!0),h=v.ERROR,J({skipFinalProcessing:!0})}finally{b=!1,x&&(console.log('[AutoRunner] Processing pending automation run.'),x=!1,setTimeout(()=>L(!1),100))}}function j(){h===v.RUNNING&&setTimeout(()=>L(!1),500)}function G(){h===v.RUNNING&&(y.value.conciseNotifications||U('warning','来自系统的停止信号，全自动运行已终止。'),J({skipFinalProcessing:!0}))}function F(){h===v.RUNNING?J():async function(){if(h===v.RUNNING)return;if(b=!1,!y.value.enabled)return void U('warning','脚本未启用，请先勾选“启用脚本”。',!0);await D(1e3),await M(),U('success','全自动运行已启动！',!0),h=v.RUNNING,E=0,N=0,y.value.executedCount=0,eventOn(tavern_events.MESSAGE_RECEIVED,j),eventOn(tavern_events.GENERATION_STOPPED,G),L(!0)}()}async function J(e={}){if(h===v.IDLE)return;let t;if(t=e.userCancelled?'用户取消了操作，全自动运行已停止。':e.skipFinalProcessing?'全自动运行已因错误而终止。':'全自动运行已停止。',U('info',t,!0),h=v.IDLE,b=!1,eventRemoveListener(tavern_events.MESSAGE_RECEIVED,j),eventRemoveListener(tavern_events.GENERATION_STOPPED,G),K(),triggerSlash('/stop'),e.skipFinalProcessing)return y.value.conciseNotifications||U('warning','因发生错误而跳过最终处理，脚本已彻底结束。'),void(w&&(w=!1,U('info','“真·自动化”模式已随运行停止而关闭。')));U('info','正在对最后生成的消息执行最终处理...'),await D(1e3);const n=(getChatMessages(-1)||[])[0];if(n&&'assistant'===n.role){h=v.RUNNING;try{await O(!0)?U('success','最终处理完成，脚本已彻底结束。',!0):U('warning','最终处理被用户取消，脚本已彻底结束。',!0)}finally{h=v.IDLE}}else U('info','没有需要最终处理的AI消息，脚本已结束。');w&&(w=!1,U('info','“真·自动化”模式已随运行停止而关闭。'))}function K(){g&&(g.abort(),console.log('[AutoRunner] Abort signal sent to sub AI call.'))}function H(){J({skipFinalProcessing:!0,userCancelled:!0})}const W={class:'flex-container flexFlowColumn'},q=['onDragstart','onDrop'],Q={class:'rule-header'},X=['onUpdate:modelValue'],Y=['onUpdate:modelValue','readonly'],Z={class:'buttons'},ee=['onClick'],te=['onClick'],ne={key:0,class:'rule-body'},ae=['onUpdate:modelValue'],oe={class:'attachments-section'},re={class:'attachment-list'},le={class:'attachment-name'},ie=['onClick'],se=['onClick'],ce=['onUpdate:modelValue'],de=(0,l.defineComponent)({__name:'PromptEditor',props:{entries:{}},emits:['update:entries'],setup(e,{emit:t}){const n=e,a=t,o=(0,l.ref)(null),r=(0,l.computed)(()=>n.entries.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function i(){a('update:entries',n.entries)}function c(){const e=d.parse({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'}),t=[...n.entries,e];a('update:entries',t)}let u=null;let p=-1;return(t,d)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',W,[(0,l.createElementVNode)('div',null,[d[2]||(d[2]=(0,l.createElementVNode)('strong',null,'提示词设置',-1)),(0,l.createTextVNode)(' (总词符数: '+(0,l.toDisplayString)(r.value)+')',1)]),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(e.entries,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:(0,l.normalizeClass)(['rule-item',{'chat-history-placeholder':e.is_chat_history}]),draggable:'true',onDragstart:e=>function(e){p=e}(t),onDragover:d[0]||(d[0]=(0,l.withModifiers)(()=>{},['prevent'])),onDrop:e=>function(e){if(-1===p||p===e)return;const t=[...n.entries],[o]=t.splice(p,1);t.splice(e,0,o),p=-1,a('update:entries',t)}(t)},[(0,l.createElementVNode)('div',Q,[d[4]||(d[4]=(0,l.createElementVNode)('span',{class:'drag-handle'},'☰',-1)),e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):(0,l.withDirectives)(((0,l.openBlock)(),(0,l.createElementBlock)('input',{key:0,'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle',onChange:i},null,40,X)),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',readonly:e.is_chat_history,placeholder:'条目名称',onInput:i},null,40,Y),[[l.vModelText,e.name]]),(0,l.createElementVNode)('div',Z,[e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('button',{key:0,class:'menu_button icon-button',onClick:t=>function(e){e.editing=!e.editing,i()}(e)},[(0,l.createElementVNode)('i',{class:(0,l.normalizeClass)(['fa-solid',e.editing?'fa-folder-open':'fa-folder'])},null,2)],8,ee)),e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('button',{key:1,class:'menu_button icon-button',onClick:e=>function(e){const t=[...n.entries];t.splice(e,1),a('update:entries',t)}(t)},[...d[3]||(d[3]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])],8,te))])]),e.editing&&!e.is_chat_history?((0,l.openBlock)(),(0,l.createElementBlock)('div',ne,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.content=t,class:'text_pole',placeholder:'提示词内容...',onInput:i},null,40,ae),[[l.vModelText,e.content]]),(0,l.createElementVNode)('div',oe,[(0,l.createElementVNode)('div',re,[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(e.attachments,(t,n)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:t.id,class:'attachment-item'},[(0,l.createElementVNode)('span',le,(0,l.toDisplayString)(t.name),1),(0,l.createElementVNode)('button',{class:'menu_button icon-button delete-attachment-btn',title:'删除附件',onClick:t=>function(e,t){e.attachments&&(e.attachments.splice(t,1),i())}(e,n)},[...d[5]||(d[5]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-times'},null,-1)])],8,ie)]))),128))]),(0,l.createElementVNode)('button',{class:'menu_button attachment-button',onClick:t=>function(e){u=e,o.value?.click()}(e)},'添加附件',8,se)]),(0,l.withDirectives)((0,l.createElementVNode)('select',{'onUpdate:modelValue':t=>e.role=t,class:'text_pole',onChange:i},[...d[6]||(d[6]=[(0,l.createElementVNode)('option',null,'user',-1),(0,l.createElementVNode)('option',null,'system',-1),(0,l.createElementVNode)('option',null,'assistant',-1)])],40,ce),[[l.vModelSelect,e.role]])])):(0,l.createCommentVNode)('v-if',!0)],42,q))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:c},'添加提示词条目'),(0,l.createElementVNode)('input',{ref_key:'fileInputRef',ref:o,type:'file',multiple:'',style:{display:'none'},onChange:d[1]||(d[1]=e=>async function(e){if(!u)return;const t=u,n=e.target;if(!n.files)return;const a=Array.from(n.files);for(const e of a){const n=new FileReader;n.onload=n=>{const a=(n.target?.result).split(',')[1];if(a){const n=s.parse({name:e.name,type:e.type,content:a});t.attachments||(t.attachments=[]),t.attachments.push(n),i()}},n.readAsDataURL(e)}n.value=''}(e))},null,544)]))}});a(254);var ue=a(441);const pe=(0,ue.A)(de,[['__scopeId','data-v-22dbfac6']]),me={class:'inline-drawer'},fe={class:'inline-drawer-content'},ge={class:'flex-container flexFlowColumn',style:{'padding-bottom':'0.5em'}},ve={class:'checkbox_label',for:'auto_runner_enabled'},he={class:'section-wrapper'},be={class:'section-content'},xe={class:'set-manager'},_e=['value'],ye={class:'set-buttons'},Ee={class:'set-manager',style:{'margin-top':'10px'}},Ne={class:'section-wrapper'},we={class:'section-content'},Ve={class:'rule-header'},ke=['onUpdate:modelValue'],Se=['onUpdate:modelValue'],Re=['onClick'],Ae={class:'rule-body'},Ie=['onUpdate:modelValue'],Ce=['onUpdate:modelValue'],Ue={class:'section-wrapper'},Pe={class:'section-content'},ze={class:'rule-header'},De=['onUpdate:modelValue'],$e=['onUpdate:modelValue'],Me=['onClick'],Te={class:'rule-body'},Be=['onUpdate:modelValue'],Oe=['onUpdate:modelValue'],Le={class:'section-wrapper'},je={class:'section-content flex-container flexFlowColumn'},Ge={key:0,value:''},Fe=['value'],Je={for:'auto_runner_temperature'},Ke={for:'auto_runner_top_p'},He={for:'auto_runner_top_k'},We={for:'auto_runner_max_tokens'},qe={class:'section-wrapper'},Qe={class:'section-content flex-container flexFlowColumn'},Xe={class:'checkbox_label',for:'auto_runner_concise_notifications'},Ye={id:'auto_runner_executed_count',class:'text_pole'},Ze=['disabled','title'],et=(0,l.defineComponent)({__name:'app',setup(e){const t=(0,l.ref)([]);(0,l.watch)(()=>y.value.enabled,(e,t)=>{!1===e&&!0===t&&J()}),(0,l.onMounted)(()=>{y.value.model&&!t.value.includes(y.value.model)&&t.value.push(y.value.model)});const n=e=>{if(V.value){const t=y.value.promptSets.find(e=>e.id===V.value.id);t&&(t.promptEntries=e)}},a=e=>{const t=c.parse({});'context'===e?y.value.contextRegexRules.push(t):y.value.subAiRegexRules.push(t)},o=(e,t)=>{'context'===e?y.value.contextRegexRules.splice(t,1):y.value.subAiRegexRules.splice(t,1)},i=async()=>{if(y.value.apiUrl)try{const e=await fetch(`${y.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=(await e.json()).data.map(e=>e.id);t.value=r().union(t.value,n),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',me,[r[47]||(r[47]=(0,l.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,l.createElementVNode)('b',null,'自动化运行脚本设置'),(0,l.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,l.createElementVNode)('div',fe,[(0,l.createElementVNode)('div',ge,[(0,l.createElementVNode)('label',ve,[(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>(0,l.unref)(y).enabled=e),type:'checkbox'},null,512),[[l.vModelCheckbox,(0,l.unref)(y).enabled]]),r[21]||(r[21]=(0,l.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),(0,l.createElementVNode)('div',he,[r[26]||(r[26]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-prompts',class:'section-toggle-checkbox'},null,-1)),r[27]||(r[27]=(0,l.createElementVNode)('label',{for:'section-toggle-prompts',class:'section-header'},[(0,l.createElementVNode)('strong',null,'提示词配置集'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',be,[(0,l.createElementVNode)('div',xe,[(0,l.withDirectives)((0,l.createElementVNode)('select',{'onUpdate:modelValue':r[1]||(r[1]=e=>(0,l.unref)(y).activePromptSetId=e),class:'text_pole set-select'},[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(y).promptSets,e=>((0,l.openBlock)(),(0,l.createElementBlock)('option',{key:e.id,value:e.id},(0,l.toDisplayString)(e.name),9,_e))),128))],512),[[l.vModelSelect,(0,l.unref)(y).activePromptSetId]]),(0,l.createElementVNode)('div',ye,[(0,l.createElementVNode)('button',{class:'menu_button icon-button',title:'新建配置',onClick:r[2]||(r[2]=(...e)=>(0,l.unref)(k)&&(0,l.unref)(k)(...e))},[...r[22]||(r[22]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])]),(0,l.createElementVNode)('button',{class:'menu_button icon-button',title:'重命名当前配置',onClick:r[3]||(r[3]=(...e)=>(0,l.unref)(S)&&(0,l.unref)(S)(...e))},[...r[23]||(r[23]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-pen-to-square'},null,-1)])]),(0,l.createElementVNode)('button',{class:'menu_button icon-button danger',title:'删除当前配置',onClick:r[4]||(r[4]=(...e)=>(0,l.unref)(R)&&(0,l.unref)(R)(...e))},[...r[24]||(r[24]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])])])]),(0,l.createElementVNode)('div',Ee,[(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[5]||(r[5]=(...e)=>(0,l.unref)(I)&&(0,l.unref)(I)(...e))},'导入配置'),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[6]||(r[6]=(...e)=>(0,l.unref)(A)&&(0,l.unref)(A)(...e))},'导出当前配置')]),r[25]||(r[25]=(0,l.createElementVNode)('hr',{style:{margin:'15px 0'}},null,-1)),(0,l.createVNode)(pe,{entries:(0,l.unref)(V).promptEntries,'onUpdate:entries':n},null,8,['entries'])])]),(0,l.createElementVNode)('div',Ne,[r[29]||(r[29]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-context-regex',class:'section-toggle-checkbox'},null,-1)),r[30]||(r[30]=(0,l.createElementVNode)('label',{for:'section-toggle-context-regex',class:'section-header'},[(0,l.createElementVNode)('strong',null,'上下文正则处理'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',we,[r[28]||(r[28]=(0,l.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(y).contextRegexRules,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,l.createElementVNode)('div',Ve,[(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,ke),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,Se),[[l.vModelText,e.name]]),(0,l.createElementVNode)('button',{class:'menu_button',onClick:e=>o('context',t)},'删除',8,Re)]),(0,l.createElementVNode)('div',Ae,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Ie),[[l.vModelText,e.find]]),(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,Ce),[[l.vModelText,e.replace]])])]))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[7]||(r[7]=e=>a('context'))},'添加上下文规则')])]),(0,l.createElementVNode)('div',Ue,[r[32]||(r[32]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-subai-regex',class:'section-toggle-checkbox'},null,-1)),r[33]||(r[33]=(0,l.createElementVNode)('label',{for:'section-toggle-subai-regex',class:'section-header'},[(0,l.createElementVNode)('strong',null,'副AI输出正则处理'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',Pe,[r[31]||(r[31]=(0,l.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(y).subAiRegexRules,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,l.createElementVNode)('div',ze,[(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,De),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,$e),[[l.vModelText,e.name]]),(0,l.createElementVNode)('button',{class:'menu_button',onClick:e=>o('subAi',t)},'删除',8,Me)]),(0,l.createElementVNode)('div',Te,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Be),[[l.vModelText,e.find]]),(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,Oe),[[l.vModelText,e.replace]])])]))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[8]||(r[8]=e=>a('subAi'))},'添加副AI输出规则')])]),(0,l.createElementVNode)('div',Le,[r[37]||(r[37]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-api',class:'section-toggle-checkbox'},null,-1)),r[38]||(r[38]=(0,l.createElementVNode)('label',{for:'section-toggle-api',class:'section-header'},[(0,l.createElementVNode)('strong',null,'API 调用设置'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',je,[r[34]||(r[34]=(0,l.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[9]||(r[9]=e=>(0,l.unref)(y).apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[l.vModelText,(0,l.unref)(y).apiUrl]]),r[35]||(r[35]=(0,l.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[10]||(r[10]=e=>(0,l.unref)(y).apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[l.vModelText,(0,l.unref)(y).apiKey]]),(0,l.createElementVNode)('div',{class:'flex-container'},[(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:i},'获取模型')]),r[36]||(r[36]=(0,l.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,l.withDirectives)((0,l.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[11]||(r[11]=e=>(0,l.unref)(y).model=e),class:'text_pole'},[(0,l.unref)(y).model?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('option',Ge,'请先获取模型')),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(t.value,e=>((0,l.openBlock)(),(0,l.createElementBlock)('option',{key:e,value:e},(0,l.toDisplayString)(e),9,Fe))),128))],512),[[l.vModelSelect,(0,l.unref)(y).model]]),(0,l.createElementVNode)('label',Je,'Temperature: '+(0,l.toDisplayString)((0,l.unref)(y).temperature),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[12]||(r[12]=e=>(0,l.unref)(y).temperature=e),type:'range',step:'0.01',min:'0',max:'2'},null,512),[[l.vModelText,(0,l.unref)(y).temperature,void 0,{number:!0}]]),(0,l.createElementVNode)('label',Ke,'Top P: '+(0,l.toDisplayString)((0,l.unref)(y).top_p),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[13]||(r[13]=e=>(0,l.unref)(y).top_p=e),type:'range',step:'0.01',min:'0',max:'1'},null,512),[[l.vModelText,(0,l.unref)(y).top_p,void 0,{number:!0}]]),(0,l.createElementVNode)('label',He,'Top K: '+(0,l.toDisplayString)((0,l.unref)(y).top_k),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[14]||(r[14]=e=>(0,l.unref)(y).top_k=e),type:'range',step:'1',min:'0',max:'500'},null,512),[[l.vModelText,(0,l.unref)(y).top_k,void 0,{number:!0}]]),(0,l.createElementVNode)('label',We,'Max Tokens: '+(0,l.toDisplayString)((0,l.unref)(y).max_tokens),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[15]||(r[15]=e=>(0,l.unref)(y).max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[l.vModelText,(0,l.unref)(y).max_tokens,void 0,{number:!0}]])])]),(0,l.createElementVNode)('div',qe,[r[45]||(r[45]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-automation',class:'section-toggle-checkbox'},null,-1)),r[46]||(r[46]=(0,l.createElementVNode)('label',{for:'section-toggle-automation',class:'section-header'},[(0,l.createElementVNode)('strong',null,'自动化设置'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',Qe,[r[41]||(r[41]=(0,l.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[16]||(r[16]=e=>(0,l.unref)(y).totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[l.vModelText,(0,l.unref)(y).totalReplies,void 0,{number:!0}]]),r[42]||(r[42]=(0,l.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':r[17]||(r[17]=e=>(0,l.unref)(y).maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[l.vModelText,(0,l.unref)(y).maxRetries,void 0,{number:!0}]]),r[43]||(r[43]=(0,l.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':r[18]||(r[18]=e=>(0,l.unref)(y).exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[l.vModelText,(0,l.unref)(y).exemptionCount,void 0,{number:!0}]]),(0,l.createElementVNode)('label',Xe,[(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_concise_notifications','onUpdate:modelValue':r[19]||(r[19]=e=>(0,l.unref)(y).conciseNotifications=e),type:'checkbox'},null,512),[[l.vModelCheckbox,(0,l.unref)(y).conciseNotifications]]),r[39]||(r[39]=(0,l.createElementVNode)('span',null,'简洁通知模式',-1))]),r[44]||(r[44]=(0,l.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,l.createElementVNode)('div',Ye,(0,l.toDisplayString)((0,l.unref)(y).executedCount),1),(0,l.createElementVNode)('button',{disabled:!(0,l.unref)(f),class:(0,l.normalizeClass)(['menu_button','wide-button',{danger:(0,l.unref)(f)}]),style:{'margin-top':'15px'},onClick:r[20]||(r[20]=(...e)=>(0,l.unref)(K)&&(0,l.unref)(K)(...e)),title:(0,l.unref)(f)?'点击以中止请求':'（无正在进行的请求）'},[r[40]||(r[40]=(0,l.createElementVNode)('i',{class:'fa-solid fa-stop'},null,-1)),(0,l.createTextVNode)(' '+(0,l.toDisplayString)(((0,l.unref)(f),'中断副 AI')),1)],10,Ze)])])])]))}});a(972);const tt=(0,ue.A)(et,[['__scopeId','data-v-598ca2f0']]),nt=(0,l.createApp)(tt);function at(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),nt.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function ot(){nt.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(async()=>{await M(),at(),eventOn(getButtonEvent('全自动运行'),F),initializeGlobal('AutoRunnerCore',{toggleTrulyAutomatedMode:B,abortSubAICall:K,abortAll:H})}),$(window).on('pagehide',()=>{ot(),J(),eventRemoveListener(getButtonEvent('全自动运行'),F)});