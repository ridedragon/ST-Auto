import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,a,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&l[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),a&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=a):d[4]=''.concat(a)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},223:(e,t,n)=>{var o=n(797);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('cfe186be',o,!1,{ssrId:!0})},424:(e,t,n)=>{function o(e,t){for(var n=[],o={},a=0;a<t.length;a++){var r=t[a],l=r[0],i={id:e+':'+a,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(i):n.push(o[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>f});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=a&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,n,a){c=n,u=a||{};var l=o(e,t);return v(l),function(t){for(var n=[],a=0;a<l.length;a++){var i=l[a];(s=r[i.id]).refs--,n.push(s)}t?v(l=o(e,t)):l=[];for(a=0;a<n.length;a++){var s;if(0===(s=n[a]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete r[s.id]}}}}function v(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var a=0;a<o.parts.length;a++)o.parts[a](n.parts[a]);for(;a<n.parts.length;a++)o.parts.push(b(n.parts[a]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var l=[];for(a=0;a<n.parts.length;a++)l.push(b(n.parts[a]));r[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function b(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return d;o.parentNode.removeChild(o)}if(m){var a=s++;o=i||(i=g()),t=E.bind(null,o,a,!1),n=E.bind(null,o,a,!0)}else o=g(),t=y.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var h,x=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join('\n')});function E(e,t,n,o){var a=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,a);else{var r=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function y(e,t){var n=t.css,o=t.media,a=t.sourceMap;if(o&&e.setAttribute('media',o),u.ssrId&&e.setAttribute(p,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},427:(e,t,n)=>{var o=n(689);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('3f6cbc0e',o,!1,{ssrId:!0})},689:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.rule-header[data-v-1bbbb5ab]{display:flex;align-items:center;gap:10px}.drag-handle[data-v-1bbbb5ab]{cursor:grab}.rule-name[data-v-1bbbb5ab]{flex-grow:1;min-width:50px}.buttons[data-v-1bbbb5ab]{display:flex;flex-shrink:0;gap:5px}.icon-button[data-v-1bbbb5ab]{padding:4px 8px;line-height:1}.rule-body select[data-v-1bbbb5ab]{margin-top:5px}.wide-button[data-v-1bbbb5ab]{width:100%;margin-top:10px}.chat-history-placeholder[data-v-1bbbb5ab]{background-color:var(--bg3) !important}','']);const i=l},797:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var o=n(93),a=n.n(o),r=n(54),l=n.n(r)()(a());l.push([e.id,'.section-wrapper[data-v-2b3034fc]{border-top:1px solid var(--bg2)}.section-wrapper[data-v-2b3034fc]:first-of-type{border-top:none}.section-wrapper[data-v-2b3034fc]:last-of-type{border-bottom:1px solid var(--bg2);margin-bottom:1em}.section-toggle-checkbox[data-v-2b3034fc]{display:none}.section-header[data-v-2b3034fc]{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:.25em 4px;border-radius:4px;transition:background-color .2s ease}.section-header[data-v-2b3034fc]:hover{background-color:var(--bg2-trans)}.section-header strong[data-v-2b3034fc]{font-size:1.1em}.section-header i[data-v-2b3034fc]{transition:transform .3s ease}.section-content[data-v-2b3034fc]{display:none;padding:10px 4px 0}.section-toggle-checkbox:checked+.section-header i[data-v-2b3034fc]{transform:rotate(90deg)}.section-toggle-checkbox:checked~.section-content[data-v-2b3034fc]{display:block}.wide-button[data-v-2b3034fc]{width:100%;margin-top:10px}label[data-v-2b3034fc]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-2b3034fc]{border:none;border-top:1px solid var(--bg2);margin:20px 0}input[type=range][data-v-2b3034fc]{width:100%}.description[data-v-2b3034fc]{font-size:.8em;color:#aaa;margin-bottom:10px}.rule-item[data-v-2b3034fc]{border:1px solid var(--bg2);border-radius:5px;padding:10px;margin-bottom:10px;background-color:var(--bg1-trans)}.rule-header[data-v-2b3034fc]{display:flex;align-items:center;gap:10px;margin-bottom:10px}.rule-toggle[data-v-2b3034fc]{transform:scale(1.2)}.rule-name[data-v-2b3034fc]{flex-grow:1}.rule-body[data-v-2b3034fc]{display:flex;flex-direction:column;gap:5px}.set-manager[data-v-2b3034fc]{display:flex;gap:10px;align-items:center}.set-select[data-v-2b3034fc]{flex-grow:1}.set-buttons[data-v-2b3034fc]{display:flex;gap:5px}.icon-button[data-v-2b3034fc]{padding:6px 10px;line-height:1;flex-shrink:0}','']);const i=l}},n={};function o(e){var a=n[e];if(void 0!==a)return a.exports;var r=n[e]={id:e,exports:{}};return t[e](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const a=_;var r=o.n(a);const l=Vue,i=z,s=i.z.object({id:i.z.string().default(()=>`rule_${Date.now()}_${Math.random()}`),name:i.z.string().default(''),find:i.z.string().default(''),replace:i.z.string().default(''),enabled:i.z.boolean().default(!0)}),c=i.z.object({id:i.z.string().default(()=>`prompt_${Date.now()}_${Math.random()}`),name:i.z.string(),content:i.z.string(),enabled:i.z.boolean(),editing:i.z.boolean(),role:i.z.enum(['user','system','assistant']),is_chat_history:i.z.boolean().optional().default(!1)}),d=i.z.object({id:i.z.string().default(()=>`set_${Date.now()}_${Math.random()}`),name:i.z.string(),promptEntries:i.z.array(c)}),u=i.z.object({enabled:i.z.boolean().default(!0),promptSets:i.z.array(d).default([]),activePromptSetId:i.z.string().nullable().default(null),apiUrl:i.z.preprocess(e=>e??'',i.z.string()),apiKey:i.z.preprocess(e=>e??'',i.z.string()),model:i.z.preprocess(e=>e??'',i.z.string()),temperature:i.z.number().min(0).max(2).default(.7),top_p:i.z.number().min(0).max(1).default(1),top_k:i.z.number().min(0).default(40),max_tokens:i.z.coerce.number().min(1).default(1024),totalReplies:i.z.coerce.number().min(1).default(10),executedCount:i.z.coerce.number().min(0).default(0),contextRegexRules:i.z.array(s).default([{id:'default_1',name:'移除 StatusPlaceHolderImpl',find:'/<StatusPlaceHolderImpl\\/>/g',replace:'',enabled:!0},{id:'default_2',name:'移除 HTML 注释',find:'/\\s*\x3c!--[\\s\\S]*?--\x3e\\s*/g',replace:'',enabled:!0},{id:'default_3',name:'移除 think 标签之前的内容',find:'/^[\\s\\S]*?<\\/think(ing)?>\\n?/',replace:'',enabled:!0},{id:'default_4',name:'移除 UpdateVariable 标签',find:'/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm',replace:'',enabled:!0}]),subAiRegexRules:i.z.array(s).default([]),maxRetries:i.z.coerce.number().min(0).default(3),exemptionCount:i.z.coerce.number().min(0).default(0),conciseNotifications:i.z.boolean().default(!1)}),p=Symbol('ABORT_SIGNAL'),m=(0,l.ref)(!1);let f=null;var v;!function(e){e[e.IDLE=0]='IDLE',e[e.RUNNING=1]='RUNNING',e[e.PAUSED=2]='PAUSED',e[e.ERROR=3]='ERROR'}(v||(v={}));let g=v.IDLE,b=!1;const h=(0,l.ref)(u.parse({}));let x=0,E=0,y=!1;const w=(0,l.computed)(()=>{const e=h.value.promptSets.find(e=>e.id===h.value.activePromptSetId);return e||d.parse({name:'（无有效配置）',promptEntries:[]})});function N(){const e=window.prompt('请输入新配置的名称：',`新配置 ${h.value.promptSets.length+1}`);if(!e)return;const t=c.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=d.parse({name:e,promptEntries:[t]});h.value.promptSets.push(n),h.value.activePromptSetId=n.id,C('success',`已创建新配置 "${e}"`)}function V(){const e=w.value;if(!e||'（无有效配置）'===e.name)return;const t=window.prompt('请输入新的名称：',e.name);if(t&&t!==e.name){const n=h.value.promptSets.find(t=>t.id===e.id);n&&(n.name=t,C('success','配置已重命名'))}}function k(){if(h.value.promptSets.length<=1)return void C('error','无法删除最后一个配置集',!0);const e=w.value;if(!e||!window.confirm(`确定要删除配置 "${e.name}" 吗？此操作不可撤销。`))return;const t=h.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(h.value.promptSets.splice(t,1),h.value.activePromptSetId=h.value.promptSets[Math.max(0,t-1)]?.id||null,C('success',`配置 "${e.name}" 已删除`))}function S(){const e=w.value;if(!e||'（无有效配置）'===e.name)return void C('error','没有可导出的有效配置。');const t={version:2,promptSet:e,contextRegexRules:h.value.contextRegexRules,subAiRegexRules:h.value.subAiRegexRules},n=JSON.stringify(t,null,2),o=new Blob([n],{type:'application/json'}),a=URL.createObjectURL(o),r=document.createElement('a');r.href=a,r.download=`[AutoRunner] ${e.name}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),C('success','当前完整预设（提示词+正则）已导出')}function R(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n);if(2===e.version&&e.promptSet){const{promptSet:t,contextRegexRules:n,subAiRegexRules:o}=e,a=d.safeParse(t);if(!a.success)return void C('error','导入的提示词配置部分格式无效。',!0);{let e=h.value.promptSets.find(e=>e.name===a.data.name);if(e){if(window.confirm(`已存在名为 "${a.data.name}" 的提示词配置。要覆盖它吗？`)){const t=h.value.promptSets.findIndex(t=>t.id===e.id);t>-1&&(a.data.id=e.id,h.value.promptSets[t]=a.data)}}else a.data.id=`set_${Date.now()}_${Math.random()}`,h.value.promptSets.push(a.data);h.value.activePromptSetId=a.data.id,C('success',`提示词配置 "${a.data.name}" 已导入并激活。`)}if(n&&o&&window.confirm('文件包含正则规则。要用导入的规则覆盖当前的上下文和副AI正则规则吗？')){const e=i.z.array(s).safeParse(n),t=i.z.array(s).safeParse(o);e.success&&t.success?(h.value.contextRegexRules=e.data,h.value.subAiRegexRules=t.data,C('success','上下文和副AI正则规则已成功导入。')):C('error','导入的正则规则部分格式无效。',!0)}}else{const t=Array.isArray(e)?e:[e];let n=0;for(const e of t){const t=d.safeParse(e);if(t.success){if(h.value.promptSets.some(e=>e.name===t.data.name)){if(!window.confirm(`已存在名为 "${t.data.name}" 的配置。要覆盖它吗？`))continue;const e=h.value.promptSets.findIndex(e=>e.name===t.data.name);e>-1&&h.value.promptSets.splice(e,1)}t.data.id=`set_${Date.now()}_${Math.random()}`,h.value.promptSets.push(t.data),n++}else console.error('导入的数据格式无效:',t.error),C('error','一个或多个导入的配置格式无效，详情请查看控制台。',!0)}n>0&&C('success',`成功导入 ${n} 个旧格式的配置。`)}}catch(e){console.error('导入失败:',e),C('error','导入文件失败，请确保是有效的JSON文件。',!0)}},e.click()}const I=r().debounce(e=>{const t=JSON.parse(JSON.stringify(e));replaceVariables(t,{type:'script',script_id:getScriptId()}),console.log('[AutoRunner] Settings saved.')},500);function C(e,t,n=!1){h.value.conciseNotifications&&!n||toastr[e](t)}function A(e,t){let n=e;for(const e of t)if(e.enabled&&e.find)try{const t=e.find.match(/^\/(.*)\/([gimsuy]*)$/s);let o;if(t){const e=t[1],n=t[2];o=new RegExp(e,n)}else o=new RegExp(e.find,'g');n=n.replace(o,e.replace)}catch(t){console.error(`正则表达式规则 "${e.name||e.id}" 无效:`,t)}return n}(0,l.watch)(h,e=>{I(e)},{deep:!0});const U=e=>new Promise(t=>setTimeout(t,e));async function P(){const e=getVariables({type:'script',script_id:getScriptId()})||{},t=JSON.parse(JSON.stringify(e)),n=u.safeParse(t);if(n.success){const e=n.data;let t=!1;if(0===e.promptSets.length){const n=c.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),o=d.parse({name:'默认配置',promptEntries:[n]});e.promptSets.push(o),e.activePromptSetId=o.id,t=!0,C('info','未找到任何配置，已创建默认配置。')}else for(const n of e.promptSets)if(!n.promptEntries.some(e=>e.is_chat_history)){const e=c.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});n.promptEntries.unshift(e),t=!0,C('info',`为配置 "${n.name}" 补全了缺失的“聊天记录”条目。`)}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,t=!0),h.value=e,t&&(I.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}))}else{console.error('[AutoRunner] 加载或解析设置失败:',n.error),C('error','加载设置时发现不兼容的数据，将尝试迁移。您的部分设置可能已重置。',!0);const e=u.parse({});for(const n in e)if(Object.prototype.hasOwnProperty.call(t,n)){const o=n,a=u.shape[o].safeParse(t[o]);a.success?e[o]=a.data:console.warn(`[AutoRunner] 无法迁移字段 "${o}"，将使用默认值。错误:`,a.error)}let o=!1;if(0===e.promptSets.length){const t=c.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0}),n=d.parse({name:'默认配置',promptEntries:[t]});e.promptSets.push(n),e.activePromptSetId=n.id,o=!0}else for(const t of e.promptSets)if(!t.promptEntries.some(e=>e.is_chat_history)){const e=c.parse({name:'聊天记录',content:'此条目是聊天记录的占位符',enabled:!0,editing:!1,role:'user',is_chat_history:!0});t.promptEntries.unshift(e),o=!0}e.promptSets.some(t=>t.id===e.activePromptSetId)||(e.activePromptSetId=e.promptSets[0]?.id||null,o=!0),h.value=e,I.cancel(),replaceVariables(JSON.parse(JSON.stringify(e)),{type:'script',script_id:getScriptId()}),C('success','数据迁移完成。请检查您的设置。',!0)}}async function D(){toastr.info('正在向副AI发送消息...',void 0,{timeOut:0,extendedTimeOut:0,closeButton:!1,tapToDismiss:!1});m.value=!0,f=new AbortController;try{const e=await getLastMessageId(),t=getChatMessages(`0-${e}`);if(!t||0===t.length)return C('error','无法获取聊天记录',!0),null;const n=[],o=t.filter(e=>'system'!==e.role).map(e=>{const t=A(e.message,h.value.contextRegexRules);return{role:e.role,content:t}});for(const e of w.value.promptEntries)e.is_chat_history?n.push(...o):e.enabled&&e.content&&n.push({role:e.role,content:e.content});const a={model:h.value.model,messages:n,temperature:h.value.temperature,top_p:h.value.top_p,top_k:h.value.top_k,max_tokens:h.value.max_tokens};console.log('[AutoRunner] 发送给副AI的完整信息:',a),h.value.conciseNotifications||C('info','完整的请求信息已打印到控制台 (F12)。');const r=await fetch(`${h.value.apiUrl}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${h.value.apiKey}`},body:JSON.stringify(a),signal:f.signal});if(!r.ok)throw new Error(`副AI API 请求失败: ${r.statusText}`);const l=await r.json(),i=l.choices[0]?.message?.content;if(!i)throw new Error('副AI未返回有效内容');return C('success','副AI响应成功'),i}catch(e){return'AbortError'===e.name?(C('warning','已中止向副AI发送消息。',!0),p):(console.error('调用副AI时出错:',e),C('error',`调用副AI失败: ${e.message}`,!0),null)}finally{toastr.clear(),m.value=!1,f=null}}function M(){y=!y,C('info','“真·自动化”模式已'+(y?'开启':'关闭'),!0)}async function T(){if(E<h.value.exemptionCount)return C('info',`豁免计数 (${E}) 小于豁免次数 (${h.value.exemptionCount})，跳过SSC和一键处理。`),E++,!0;const e=window.parent.aiOptimizer;if(!e||'function'!=typeof e.manualOptimize||'function'!=typeof e.optimizeText)return C('warning','未找到 AI Optimizer API，跳过优化步骤。'),C('info','执行“一键处理”...'),await eventEmit(getButtonEvent('一键处理')),await U(5e3),!0;try{C('info','自动化优化流程已启动...');const t=await new Promise(t=>{e.manualOptimize(e=>t(e))});if(t){window.parent.tempPopupText=t;const n=`<p>已提取以下内容（可编辑），点击“继续”发送给AI优化：</p><textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-source" class="text_pole" rows="10" style="width: 100%;">${t}</textarea>`;let o;y?(C('info','[真·自动化] 自动确认步骤1。'),o=!0):o=await window.parent.SillyTavern.getContext().callGenericPopup(n,'步骤1: 提取并编辑','',{okButton:'继续',cancelButton:'取消',wide:!0});const a=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!o)return C('info','自动化流程已由用户在步骤1取消。'),!1;C('info','正在发送给AI优化...');const r=await async function(){try{const e=await getLastMessageId();if(e<0)return'';const t=Math.max(0,e-9),n=[...getChatMessages(`${t}-${e}`)].reverse().find(e=>'assistant'===e.role);return n?n.message:''}catch(e){return console.error('获取最后一条角色消息时出错:',e),''}}(),l='function'==typeof e.getSystemPrompt?e.getSystemPrompt():'',i=await e.optimizeText(a,l,r);if(null===i)return C('info','优化被用户取消。'),!1;if(!i)throw new Error('AI 未能返回优化后的文本。');window.parent.tempPopupText=i;const s=`\n                  <p><b>原始句子:</b></p>\n                  <textarea class="text_pole" rows="5" style="width: 100%;" readonly>${a}</textarea>\n                  <p><b>优化后句子 (可编辑):</b></p>\n                  <textarea oninput="window.parent.tempPopupText = this.value" id="auto-optimizer-result" class="text_pole" rows="5" style="width: 100%;">${i}</textarea>\n              `;let c;y?(C('info','[真·自动化] 自动确认步骤2。'),c=!0):c=await window.parent.SillyTavern.getContext().callGenericPopup(s,'步骤2: 对比并确认替换','',{okButton:'替换',cancelButton:'取消',wide:!0});const d=window.parent.tempPopupText;if(delete window.parent.tempPopupText,!c)return C('info','替换操作已由用户取消。'),!1;C('info','正在执行SSC替换...'),await new Promise(t=>{e.replaceMessage(a,d,e=>{e&&C('success','SSC 替换完成！'),t()})})}else C('info','在最后一条角色消息中未找到可优化的内容，跳过SSC优化。');return C('info','等待2秒以确保系统稳定...'),await U(2e3),await async function(){C('info','正在执行“一键处理”...');try{const e=getChatMessages(-1);if(e&&e.length>0){const t=e[0],{message_id:n,message:o}=t,a=/<\/?br\b[^>]*>/gi;if(a.test(o)){const e=o.replace(a,'\n');await setChatMessages([{message_id:n,message:e}]),console.log('[AutoRunner] 已移除<br>标签。')}}await eventEmit(getButtonEvent('重新读取初始变量')),await eventEmit(getButtonEvent('重新处理变量')),C('success','“一键处理”完成。')}catch(e){console.error('[AutoRunner] 执行“一键处理”时出错:',e),C('error','执行“一键处理”时发生错误。',!0)}}(),await U(5e3),!0}catch(e){return console.error('[Auto Optimizer] 流程执行出错:',e),C('error',e.message,!0),!1}}async function B(e=!1){if(b)console.log('[AutoRunner] Automation is already running. Ignoring concurrent trigger.');else if(g!==v.RUNNING||h.value.executedCount>=h.value.totalReplies&&(C('info','已达到总回复次数，全自动运行结束。',!0),1))G();else try{b=!0,e||await P();const t=(getChatMessages(-1)||[])[0];if(!t)return C('error','无法获取最后一条消息，自动化暂停。',!0),void(g=v.PAUSED);if('user'===t.role)C('info','检测到用户消息，触发主AI生成...'),await triggerSlash('/trigger await=true');else{C('info','检测到AI消息，开始完整循环...');if(!await T())return void G({skipFinalProcessing:!0,userCancelled:!0});let e=null,t=0;for(;t<=h.value.maxRetries;){const n=await D();if(n===p)return void G({skipFinalProcessing:!0,userCancelled:!0});if(n){e=n;break}if(t++,t>h.value.maxRetries)return C('error',`调用副AI已达到最大重试次数 (${h.value.maxRetries})，自动化已停止。`,!0),void G({skipFinalProcessing:!0});C('warning',`调用副AI失败，将在5秒后重试 (${t}/${h.value.maxRetries})`),await U(5e3)}if(!e)return;const n=A(e,h.value.subAiRegexRules);console.log('处理后的回复:',n),C('info','以用户身份发送处理后的消息...'),await triggerSlash(`/send ${n}`),await triggerSlash('/trigger await=true')}'user'!==t.role&&await async function(){h.value.executedCount++}()}catch(e){console.error('自动化循环出错:',e),C('error',`自动化循环发生意外错误: ${e.message}，流程已终止。`,!0),g=v.ERROR,G({skipFinalProcessing:!0})}finally{b=!1}}function O(){g===v.RUNNING&&setTimeout(()=>B(!1),1e3)}function L(){g===v.RUNNING&&(h.value.conciseNotifications||C('warning','来自系统的停止信号，全自动运行已终止。'),G({skipFinalProcessing:!0}))}function j(){g===v.RUNNING?G():async function(){if(g===v.RUNNING)return;if(b=!1,!h.value.enabled)return void C('warning','脚本未启用，请先勾选“启用脚本”。',!0);await U(1e3),await P(),C('success','全自动运行已启动！',!0),g=v.RUNNING,x=0,E=0,h.value.executedCount=0,eventOn(tavern_events.MESSAGE_RECEIVED,O),eventOn(tavern_events.GENERATION_STOPPED,L),B(!0)}()}async function G(e={}){if(g===v.IDLE)return;let t;if(t=e.userCancelled?'用户取消了操作，全自动运行已停止。':e.skipFinalProcessing?'全自动运行已因错误而终止。':'全自动运行已停止。',C('info',t,!0),g=v.IDLE,b=!1,eventRemoveListener(tavern_events.MESSAGE_RECEIVED,O),eventRemoveListener(tavern_events.GENERATION_STOPPED,L),F(),triggerSlash('/stop'),e.skipFinalProcessing)return h.value.conciseNotifications||C('warning','因发生错误而跳过最终处理，脚本已彻底结束。'),void(y&&(y=!1,C('info','“真·自动化”模式已随运行停止而关闭。')));C('info','正在对最后生成的消息执行最终处理...'),await U(1e3);const n=(getChatMessages(-1)||[])[0];if(n&&'assistant'===n.role){h.value.exemptionCount>0&&(E=h.value.exemptionCount);await T()?C('success','最终处理完成，脚本已彻底结束。',!0):C('warning','最终处理被用户取消，脚本已彻底结束。',!0)}else C('info','没有需要最终处理的AI消息，脚本已结束。');y&&(y=!1,C('info','“真·自动化”模式已随运行停止而关闭。'))}function F(){f&&(f.abort(),console.log('[AutoRunner] Abort signal sent to sub AI call.'))}const J={class:'flex-container flexFlowColumn'},K=['onDragstart','onDrop'],H={class:'rule-header'},q=['onUpdate:modelValue'],W=['onUpdate:modelValue','readonly'],Q={class:'buttons'},X=['onClick'],Y=['onClick'],Z={key:0,class:'rule-body'},ee=['onUpdate:modelValue'],te=['onUpdate:modelValue'],ne=(0,l.defineComponent)({__name:'PromptEditor',props:{entries:{}},emits:['update:entries'],setup(e,{emit:t}){const n=e,o=t,a=(0,l.computed)(()=>n.entries.reduce((e,t)=>e+(t.enabled?t.content.length:0),0));function r(){o('update:entries',n.entries)}function i(){const e=c.parse({name:'新条目',content:'',enabled:!0,editing:!0,role:'user'}),t=[...n.entries,e];o('update:entries',t)}let s=-1;return(t,c)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',J,[(0,l.createElementVNode)('div',null,[c[1]||(c[1]=(0,l.createElementVNode)('strong',null,'提示词设置',-1)),(0,l.createTextVNode)(' (总词符数: '+(0,l.toDisplayString)(a.value)+')',1)]),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(e.entries,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:(0,l.normalizeClass)(['rule-item',{'chat-history-placeholder':e.is_chat_history}]),draggable:'true',onDragstart:e=>function(e){s=e}(t),onDragover:c[0]||(c[0]=(0,l.withModifiers)(()=>{},['prevent'])),onDrop:e=>function(e){if(-1===s||s===e)return;const t=[...n.entries],[a]=t.splice(s,1);t.splice(e,0,a),s=-1,o('update:entries',t)}(t)},[(0,l.createElementVNode)('div',H,[c[3]||(c[3]=(0,l.createElementVNode)('span',{class:'drag-handle'},'☰',-1)),e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):(0,l.withDirectives)(((0,l.openBlock)(),(0,l.createElementBlock)('input',{key:0,'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle',onChange:r},null,40,q)),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',readonly:e.is_chat_history,placeholder:'条目名称',onInput:r},null,40,W),[[l.vModelText,e.name]]),(0,l.createElementVNode)('div',Q,[e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('button',{key:0,class:'menu_button icon-button',onClick:t=>function(e){e.editing=!e.editing,r()}(e)},[(0,l.createElementVNode)('i',{class:(0,l.normalizeClass)(['fa-solid',e.editing?'fa-folder-open':'fa-folder'])},null,2)],8,X)),e.is_chat_history?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('button',{key:1,class:'menu_button icon-button',onClick:e=>function(e){const t=[...n.entries];t.splice(e,1),o('update:entries',t)}(t)},[...c[2]||(c[2]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])],8,Y))])]),e.editing&&!e.is_chat_history?((0,l.openBlock)(),(0,l.createElementBlock)('div',Z,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.content=t,class:'text_pole',placeholder:'提示词内容...',onInput:r},null,40,ee),[[l.vModelText,e.content]]),(0,l.withDirectives)((0,l.createElementVNode)('select',{'onUpdate:modelValue':t=>e.role=t,class:'text_pole',onChange:r},[...c[4]||(c[4]=[(0,l.createElementVNode)('option',null,'user',-1),(0,l.createElementVNode)('option',null,'system',-1),(0,l.createElementVNode)('option',null,'assistant',-1)])],40,te),[[l.vModelSelect,e.role]])])):(0,l.createCommentVNode)('v-if',!0)],42,K))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:i},'添加提示词条目')]))}});o(427);var oe=o(42);const ae=(0,oe.A)(ne,[['__scopeId','data-v-1bbbb5ab']]),re={class:'inline-drawer'},le={class:'inline-drawer-content'},ie={class:'flex-container flexFlowColumn',style:{'padding-bottom':'0.5em'}},se={class:'checkbox_label',for:'auto_runner_enabled'},ce={class:'section-wrapper'},de={class:'section-content'},ue={class:'set-manager'},pe=['value'],me={class:'set-buttons'},fe={class:'set-manager',style:{'margin-top':'10px'}},ve={class:'section-wrapper'},ge={class:'section-content'},be={class:'rule-header'},he=['onUpdate:modelValue'],xe=['onUpdate:modelValue'],_e=['onClick'],Ee={class:'rule-body'},ye=['onUpdate:modelValue'],we=['onUpdate:modelValue'],Ne={class:'section-wrapper'},Ve={class:'section-content'},ke={class:'rule-header'},Se=['onUpdate:modelValue'],Re=['onUpdate:modelValue'],Ie=['onClick'],Ce={class:'rule-body'},Ae=['onUpdate:modelValue'],Ue=['onUpdate:modelValue'],Pe={class:'section-wrapper'},ze={class:'section-content flex-container flexFlowColumn'},De={key:0,value:''},Me=['value'],Te={for:'auto_runner_temperature'},$e={for:'auto_runner_top_p'},Be={for:'auto_runner_top_k'},Oe={for:'auto_runner_max_tokens'},Le={class:'section-wrapper'},je={class:'section-content flex-container flexFlowColumn'},Ge={class:'checkbox_label',for:'auto_runner_concise_notifications'},Fe={id:'auto_runner_executed_count',class:'text_pole'},Je=['disabled','title'],Ke=(0,l.defineComponent)({__name:'app',setup(e){const t=(0,l.ref)([]);(0,l.watch)(()=>h.value.enabled,(e,t)=>{!1===e&&!0===t&&G()}),(0,l.onMounted)(()=>{h.value.model&&!t.value.includes(h.value.model)&&t.value.push(h.value.model)});const n=e=>{if(w.value){const t=h.value.promptSets.find(e=>e.id===w.value.id);t&&(t.promptEntries=e)}},o=e=>{const t=s.parse({});'context'===e?h.value.contextRegexRules.push(t):h.value.subAiRegexRules.push(t)},a=(e,t)=>{'context'===e?h.value.contextRegexRules.splice(t,1):h.value.subAiRegexRules.splice(t,1)},i=async()=>{if(h.value.apiUrl)try{const e=await fetch(`${h.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=(await e.json()).data.map(e=>e.id);t.value=r().union(t.value,n),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e),toastr.error('获取模型列表失败')}else toastr.error('请先填写API地址')};return(e,r)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',re,[r[47]||(r[47]=(0,l.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,l.createElementVNode)('b',null,'自动化运行脚本设置'),(0,l.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,l.createElementVNode)('div',le,[(0,l.createElementVNode)('div',ie,[(0,l.createElementVNode)('label',se,[(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':r[0]||(r[0]=e=>(0,l.unref)(h).enabled=e),type:'checkbox'},null,512),[[l.vModelCheckbox,(0,l.unref)(h).enabled]]),r[21]||(r[21]=(0,l.createElementVNode)('span',null,'启用脚本 (核心功能)',-1))])]),(0,l.createElementVNode)('div',ce,[r[26]||(r[26]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-prompts',class:'section-toggle-checkbox'},null,-1)),r[27]||(r[27]=(0,l.createElementVNode)('label',{for:'section-toggle-prompts',class:'section-header'},[(0,l.createElementVNode)('strong',null,'提示词配置集'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',de,[(0,l.createElementVNode)('div',ue,[(0,l.withDirectives)((0,l.createElementVNode)('select',{'onUpdate:modelValue':r[1]||(r[1]=e=>(0,l.unref)(h).activePromptSetId=e),class:'text_pole set-select'},[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(h).promptSets,e=>((0,l.openBlock)(),(0,l.createElementBlock)('option',{key:e.id,value:e.id},(0,l.toDisplayString)(e.name),9,pe))),128))],512),[[l.vModelSelect,(0,l.unref)(h).activePromptSetId]]),(0,l.createElementVNode)('div',me,[(0,l.createElementVNode)('button',{class:'menu_button icon-button',title:'新建配置',onClick:r[2]||(r[2]=(...e)=>(0,l.unref)(N)&&(0,l.unref)(N)(...e))},[...r[22]||(r[22]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])]),(0,l.createElementVNode)('button',{class:'menu_button icon-button',title:'重命名当前配置',onClick:r[3]||(r[3]=(...e)=>(0,l.unref)(V)&&(0,l.unref)(V)(...e))},[...r[23]||(r[23]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-pen-to-square'},null,-1)])]),(0,l.createElementVNode)('button',{class:'menu_button icon-button danger',title:'删除当前配置',onClick:r[4]||(r[4]=(...e)=>(0,l.unref)(k)&&(0,l.unref)(k)(...e))},[...r[24]||(r[24]=[(0,l.createElementVNode)('i',{class:'fa-solid fa-trash'},null,-1)])])])]),(0,l.createElementVNode)('div',fe,[(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[5]||(r[5]=(...e)=>(0,l.unref)(R)&&(0,l.unref)(R)(...e))},'导入配置'),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[6]||(r[6]=(...e)=>(0,l.unref)(S)&&(0,l.unref)(S)(...e))},'导出当前配置')]),r[25]||(r[25]=(0,l.createElementVNode)('hr',{style:{margin:'15px 0'}},null,-1)),(0,l.createVNode)(ae,{entries:(0,l.unref)(w).promptEntries,'onUpdate:entries':n},null,8,['entries'])])]),(0,l.createElementVNode)('div',ve,[r[29]||(r[29]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-context-regex',class:'section-toggle-checkbox'},null,-1)),r[30]||(r[30]=(0,l.createElementVNode)('label',{for:'section-toggle-context-regex',class:'section-header'},[(0,l.createElementVNode)('strong',null,'上下文正则处理'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',ge,[r[28]||(r[28]=(0,l.createElementVNode)('p',{class:'description'},'在将聊天记录发送给副AI之前，按顺序应用以下规则。',-1)),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(h).contextRegexRules,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,l.createElementVNode)('div',be,[(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,he),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,xe),[[l.vModelText,e.name]]),(0,l.createElementVNode)('button',{class:'menu_button',onClick:e=>a('context',t)},'删除',8,_e)]),(0,l.createElementVNode)('div',Ee,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,ye),[[l.vModelText,e.find]]),(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,we),[[l.vModelText,e.replace]])])]))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[7]||(r[7]=e=>o('context'))},'添加上下文规则')])]),(0,l.createElementVNode)('div',Ne,[r[32]||(r[32]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-subai-regex',class:'section-toggle-checkbox'},null,-1)),r[33]||(r[33]=(0,l.createElementVNode)('label',{for:'section-toggle-subai-regex',class:'section-header'},[(0,l.createElementVNode)('strong',null,'副AI输出正则处理'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',Ve,[r[31]||(r[31]=(0,l.createElementVNode)('p',{class:'description'},'在收到副AI的回复后，按顺序应用以下规则。',-1)),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(h).subAiRegexRules,(e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)('div',{key:e.id,class:'rule-item'},[(0,l.createElementVNode)('div',ke,[(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox',class:'rule-toggle'},null,8,Se),[[l.vModelCheckbox,e.enabled]]),(0,l.withDirectives)((0,l.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text',class:'text_pole rule-name',placeholder:'规则名称'},null,8,Re),[[l.vModelText,e.name]]),(0,l.createElementVNode)('button',{class:'menu_button',onClick:e=>a('subAi',t)},'删除',8,Ie)]),(0,l.createElementVNode)('div',Ce,[(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.find=t,class:'text_pole',placeholder:'查找 (支持 /.../flags 格式)'},null,8,Ae),[[l.vModelText,e.find]]),(0,l.withDirectives)((0,l.createElementVNode)('textarea',{'onUpdate:modelValue':t=>e.replace=t,class:'text_pole',placeholder:'替换为 (留空则为删除)'},null,8,Ue),[[l.vModelText,e.replace]])])]))),128)),(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:r[8]||(r[8]=e=>o('subAi'))},'添加副AI输出规则')])]),(0,l.createElementVNode)('div',Pe,[r[37]||(r[37]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-api',class:'section-toggle-checkbox'},null,-1)),r[38]||(r[38]=(0,l.createElementVNode)('label',{for:'section-toggle-api',class:'section-header'},[(0,l.createElementVNode)('strong',null,'API 调用设置'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',ze,[r[34]||(r[34]=(0,l.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':r[9]||(r[9]=e=>(0,l.unref)(h).apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[l.vModelText,(0,l.unref)(h).apiUrl]]),r[35]||(r[35]=(0,l.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':r[10]||(r[10]=e=>(0,l.unref)(h).apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[l.vModelText,(0,l.unref)(h).apiKey]]),(0,l.createElementVNode)('div',{class:'flex-container'},[(0,l.createElementVNode)('button',{class:'menu_button wide-button',onClick:i},'获取模型')]),r[36]||(r[36]=(0,l.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,l.withDirectives)((0,l.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':r[11]||(r[11]=e=>(0,l.unref)(h).model=e),class:'text_pole'},[(0,l.unref)(h).model?(0,l.createCommentVNode)('v-if',!0):((0,l.openBlock)(),(0,l.createElementBlock)('option',De,'请先获取模型')),((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(t.value,e=>((0,l.openBlock)(),(0,l.createElementBlock)('option',{key:e,value:e},(0,l.toDisplayString)(e),9,Me))),128))],512),[[l.vModelSelect,(0,l.unref)(h).model]]),(0,l.createElementVNode)('label',Te,'Temperature: '+(0,l.toDisplayString)((0,l.unref)(h).temperature),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':r[12]||(r[12]=e=>(0,l.unref)(h).temperature=e),type:'range',step:'0.01',min:'0',max:'2'},null,512),[[l.vModelText,(0,l.unref)(h).temperature,void 0,{number:!0}]]),(0,l.createElementVNode)('label',$e,'Top P: '+(0,l.toDisplayString)((0,l.unref)(h).top_p),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':r[13]||(r[13]=e=>(0,l.unref)(h).top_p=e),type:'range',step:'0.01',min:'0',max:'1'},null,512),[[l.vModelText,(0,l.unref)(h).top_p,void 0,{number:!0}]]),(0,l.createElementVNode)('label',Be,'Top K: '+(0,l.toDisplayString)((0,l.unref)(h).top_k),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':r[14]||(r[14]=e=>(0,l.unref)(h).top_k=e),type:'range',step:'1',min:'0',max:'500'},null,512),[[l.vModelText,(0,l.unref)(h).top_k,void 0,{number:!0}]]),(0,l.createElementVNode)('label',Oe,'Max Tokens: '+(0,l.toDisplayString)((0,l.unref)(h).max_tokens),1),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':r[15]||(r[15]=e=>(0,l.unref)(h).max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[l.vModelText,(0,l.unref)(h).max_tokens,void 0,{number:!0}]])])]),(0,l.createElementVNode)('div',Le,[r[45]||(r[45]=(0,l.createElementVNode)('input',{type:'checkbox',id:'section-toggle-automation',class:'section-toggle-checkbox'},null,-1)),r[46]||(r[46]=(0,l.createElementVNode)('label',{for:'section-toggle-automation',class:'section-header'},[(0,l.createElementVNode)('strong',null,'自动化设置'),(0,l.createElementVNode)('i',{class:'fa-solid fa-chevron-right'})],-1)),(0,l.createElementVNode)('div',je,[r[41]||(r[41]=(0,l.createElementVNode)('label',{for:'auto_runner_total_replies'},'总回复次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_total_replies','onUpdate:modelValue':r[16]||(r[16]=e=>(0,l.unref)(h).totalReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[l.vModelText,(0,l.unref)(h).totalReplies,void 0,{number:!0}]]),r[42]||(r[42]=(0,l.createElementVNode)('label',{for:'auto_runner_max_retries'},'最大重试次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_max_retries','onUpdate:modelValue':r[17]||(r[17]=e=>(0,l.unref)(h).maxRetries=e),type:'number',class:'text_pole',min:'0'},null,512),[[l.vModelText,(0,l.unref)(h).maxRetries,void 0,{number:!0}]]),r[43]||(r[43]=(0,l.createElementVNode)('label',{for:'auto_runner_exemption_count'},'SSC及一键处理豁免次数',-1)),(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_exemption_count','onUpdate:modelValue':r[18]||(r[18]=e=>(0,l.unref)(h).exemptionCount=e),type:'number',class:'text_pole',min:'0'},null,512),[[l.vModelText,(0,l.unref)(h).exemptionCount,void 0,{number:!0}]]),(0,l.createElementVNode)('label',Ge,[(0,l.withDirectives)((0,l.createElementVNode)('input',{id:'auto_runner_concise_notifications','onUpdate:modelValue':r[19]||(r[19]=e=>(0,l.unref)(h).conciseNotifications=e),type:'checkbox'},null,512),[[l.vModelCheckbox,(0,l.unref)(h).conciseNotifications]]),r[39]||(r[39]=(0,l.createElementVNode)('span',null,'简洁通知模式',-1))]),r[44]||(r[44]=(0,l.createElementVNode)('label',{for:'auto_runner_executed_count'},'自动执行次数计数',-1)),(0,l.createElementVNode)('div',Fe,(0,l.toDisplayString)((0,l.unref)(h).executedCount),1),(0,l.createElementVNode)('button',{disabled:!(0,l.unref)(m),class:(0,l.normalizeClass)(['menu_button','wide-button',{danger:(0,l.unref)(m)}]),style:{'margin-top':'15px'},onClick:r[20]||(r[20]=(...e)=>(0,l.unref)(F)&&(0,l.unref)(F)(...e)),title:(0,l.unref)(m)?'点击以中止请求':'（无正在进行的请求）'},[r[40]||(r[40]=(0,l.createElementVNode)('i',{class:'fa-solid fa-stop'},null,-1)),(0,l.createTextVNode)(' '+(0,l.toDisplayString)(((0,l.unref)(m),'中断副 AI')),1)],10,Je)])])])]))}});o(223);const He=(0,oe.A)(Ke,[['__scopeId','data-v-2b3034fc']]),qe=(0,l.createApp)(He);function We(){try{!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');const n=$('<div>').attr('script_id',getScriptId());t.append(n),qe.use(e()).mount(n[0]),toastr.success('Auto脚本加载成功')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function Qe(){qe.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(async()=>{await P(),We(),eventOn(getButtonEvent('全自动运行'),j),initializeGlobal('AutoRunnerCore',{toggleTrulyAutomatedMode:M,abortSubAICall:F})}),$(window).on('pagehide',()=>{Qe(),G(),eventRemoveListener(getButtonEvent('全自动运行'),j)});