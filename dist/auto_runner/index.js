import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,r]of t)n[e]=r;return n}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',r=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),r&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),r&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,r,o,a){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(r)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(l[s]=!0)}for(var u=0;u<e.length;u++){var d=[].concat(e[u]);r&&l[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=a),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),o&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=o):d[4]=''.concat(o)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},421:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var r=n(93),o=n.n(r),a=n(54),l=n.n(a)()(o());l.push([e.id,'.wide-button[data-v-2d0e8d19]{width:100%}label[data-v-2d0e8d19]{margin-top:10px;margin-bottom:5px;font-size:.9em;color:#ccc}hr[data-v-2d0e8d19]{border:none;border-top:1px solid var(--bg2);margin:15px 0}input[type=range][data-v-2d0e8d19]{width:100%}','']);const i=l},424:(e,t,n)=>{function r(e,t){for(var n=[],r={},o=0;o<t.length;o++){var a=t[o],l=a[0],i={id:e+':'+o,css:a[1],media:a[2],sourceMap:a[3]};r[l]?r[l].parts.push(i):n.push(r[l]={id:l,parts:[i]})}return n}n.d(t,{A:()=>v});var o='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!o)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var a={},l=o&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,u=!1,d=function(){},c=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,n,o){u=n,c=o||{};var l=r(e,t);return f(l),function(t){for(var n=[],o=0;o<l.length;o++){var i=l[o];(s=a[i.id]).refs--,n.push(s)}t?f(l=r(e,t)):l=[];for(o=0;o<n.length;o++){var s;if(0===(s=n[o]).refs){for(var u=0;u<s.parts.length;u++)s.parts[u]();delete a[s.id]}}}}function f(e){for(var t=0;t<e.length;t++){var n=e[t],r=a[n.id];if(r){r.refs++;for(var o=0;o<r.parts.length;o++)r.parts[o](n.parts[o]);for(;o<n.parts.length;o++)r.parts.push(h(n.parts[o]));r.parts.length>n.parts.length&&(r.parts.length=n.parts.length)}else{var l=[];for(o=0;o<n.parts.length;o++)l.push(h(n.parts[o]));a[n.id]={id:n.id,refs:1,parts:l}}}}function g(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function h(e){var t,n,r=document.querySelector('style['+p+'~="'+e.id+'"]');if(r){if(u)return d;r.parentNode.removeChild(r)}if(m){var o=s++;r=i||(i=g()),t=y.bind(null,r,o,!1),n=y.bind(null,r,o,!0)}else r=g(),t=E.bind(null,r),n=function(){r.parentNode.removeChild(r)};return t(e),function(r){if(r){if(r.css===e.css&&r.media===e.media&&r.sourceMap===e.sourceMap)return;t(e=r)}else n()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function y(e,t,n,r){var o=n?'':r.css;if(e.styleSheet)e.styleSheet.cssText=x(t,o);else{var a=document.createTextNode(o),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(a,l[t]):e.appendChild(a)}}function E(e,t){var n=t.css,r=t.media,o=t.sourceMap;if(r&&e.setAttribute('media',r),c.ssrId&&e.setAttribute(p,t.id),o&&(n+='\n/*# sourceURL='+o.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},931:(e,t,n)=>{var r=n(421);r.__esModule&&(r=r.default),'string'==typeof r&&(r=[[e.id,r,'']]),r.locals&&(e.exports=r.locals);(0,n(424).A)('9d115e5e',r,!1,{ssrId:!0})}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={id:e,exports:{}};return t[e](a,a.exports,r),a.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const o=_;var a=r.n(o);const l=z,i=l.z.object({enabled:l.z.boolean().default(!1),prompt:l.z.preprocess(e=>e??'',l.z.string()),apiUrl:l.z.string().default(''),apiKey:l.z.string().default(''),model:l.z.string().default(''),temperature:l.z.number().min(0).max(2).default(.7),top_p:l.z.number().min(0).max(1).default(1),top_k:l.z.number().min(0).default(40),max_tokens:l.z.number().min(1).default(1024),maxReplies:l.z.number().min(1).default(10)});let s=0,u=!1;async function d(e){if(console.log(`[AutoRunner] GENERATION_ENDED 事件触发，message_id: ${e}`),u)return void console.log('[AutoRunner] 脚本正在运行中，跳过本次触发。');const t=i.parse(getVariables({type:'script',script_id:getScriptId()})||{}),n=getChatMessages(-1)[0];if(t.enabled)if(n)if('assistant'===n.role)if(s<=0)console.log('[AutoRunner] 剩余回复次数为0，跳过。');else{console.log('[AutoRunner] 所有条件满足，开始执行自动化流程。'),u=!0,toastr.info(`自动执行: ${t.maxReplies-s+1}/${t.maxReplies}`);try{const n=getChatMessages(`0-${e}`).map(e=>`${e.name}: ${e.message}`).join('\n'),r=await generate({user_input:`${n}\n\n${t.prompt}`,custom_api:{apiurl:t.apiUrl,key:t.apiKey,model:t.model,temperature:t.temperature,max_tokens:t.max_tokens},should_stream:!1});if(!r||''===r.trim())throw new Error('副AI没有返回有效指令。');await createChatMessages([{role:'user',name:SillyTavern.name1,message:r}]),s--}catch(e){const t=e;console.error('自动化脚本运行出错:',t),toastr.error(`脚本错误: ${t.message}`)}finally{if(u=!1,s<=0){toastr.info('自动化任务完成。');const e=i.parse(getVariables({type:'script',script_id:getScriptId()})||{});e.enabled&&(e.enabled=!1,replaceVariables(a().cloneDeep(e),{type:'script',script_id:getScriptId()}))}}}else console.log(`[AutoRunner] 最后一条消息的角色是 "${n.role}" 而不是 "assistant"，跳过。`);else console.log('[AutoRunner] 未获取到最后一条消息，跳过。');else console.log('[AutoRunner] 脚本未启用，跳过。')}function c(){const e=i.parse(getVariables({type:'script',script_id:getScriptId()})||{});e.enabled&&(s=e.maxReplies)}const p=Vue,m={class:'inline-drawer'},v={class:'inline-drawer-content'},f={class:'flex-container flexFlowColumn'},g={class:'checkbox_label',for:'auto_runner_enabled'},h={class:'flex-container flexFlowColumn'},b={class:'flex-container flexFlowColumn'},x={key:0,value:''},y=['value'],E={for:'auto_runner_temperature'},V={for:'auto_runner_top_p'},N={for:'auto_runner_top_k'},w={for:'auto_runner_max_tokens'},k={class:'flex-container flexFlowColumn'},S=(0,p.defineComponent)({__name:'app',setup(e){const t=(0,p.ref)(i.parse({})),n=(0,p.ref)([]);(0,p.onMounted)(()=>{try{const e=getVariables({type:'script',script_id:getScriptId()});t.value=i.parse(e)}catch(e){console.error('加载设置失败:',e),t.value=i.parse({})}}),(0,p.watch)(t,e=>{try{const t=i.parse(e);replaceVariables(a().cloneDeep(t),{type:'script',script_id:getScriptId()})}catch(e){const t=e;console.error('自动保存设置失败:',t)}},{deep:!0});const r=async()=>{if(t.value.apiUrl)try{const e=await fetch(`${t.value.apiUrl}/models`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=await e.json();n.value=r.data.map(e=>e.id),toastr.success('模型列表已获取')}catch(e){console.error('获取模型列表失败:',e)}};return(e,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',m,[o[21]||(o[21]=(0,p.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,p.createElementVNode)('b',null,'自动化运行脚本设置'),(0,p.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,p.createElementVNode)('div',v,[(0,p.createElementVNode)('div',f,[(0,p.createElementVNode)('label',g,[(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_enabled','onUpdate:modelValue':o[0]||(o[0]=e=>t.value.enabled=e),type:'checkbox'},null,512),[[p.vModelCheckbox,t.value.enabled]]),o[10]||(o[10]=(0,p.createElementVNode)('span',null,'启用脚本',-1))])]),o[18]||(o[18]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('div',h,[o[11]||(o[11]=(0,p.createElementVNode)('div',null,[(0,p.createElementVNode)('strong',null,'提示词设置')],-1)),(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':o[1]||(o[1]=e=>t.value.prompt=e),class:'text_pole',placeholder:'输入给副AI的指令...'},null,512),[[p.vModelText,t.value.prompt]])]),o[19]||(o[19]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('div',b,[o[12]||(o[12]=(0,p.createElementVNode)('div',null,[(0,p.createElementVNode)('strong',null,'API 调用设置')],-1)),o[13]||(o[13]=(0,p.createElementVNode)('label',{for:'auto_runner_api_url'},'API 地址',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_api_url','onUpdate:modelValue':o[2]||(o[2]=e=>t.value.apiUrl=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[p.vModelText,t.value.apiUrl]]),o[14]||(o[14]=(0,p.createElementVNode)('label',{for:'auto_runner_api_key'},'API 密钥',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_api_key','onUpdate:modelValue':o[3]||(o[3]=e=>t.value.apiKey=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[p.vModelText,t.value.apiKey]]),(0,p.createElementVNode)('div',{class:'flex-container'},[(0,p.createElementVNode)('button',{class:'menu_button wide-button',onClick:r},'获取模型')]),o[15]||(o[15]=(0,p.createElementVNode)('label',{for:'auto_runner_model'},'模型',-1)),(0,p.withDirectives)((0,p.createElementVNode)('select',{id:'auto_runner_model','onUpdate:modelValue':o[4]||(o[4]=e=>t.value.model=e),class:'text_pole'},[t.value.model?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('option',x,'请先获取模型')),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,y))),128))],512),[[p.vModelSelect,t.value.model]]),(0,p.createElementVNode)('label',E,'Temperature: '+(0,p.toDisplayString)(t.value.temperature),1),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_temperature','onUpdate:modelValue':o[5]||(o[5]=e=>t.value.temperature=e),type:'range',step:'0.1',min:'0',max:'2'},null,512),[[p.vModelText,t.value.temperature,void 0,{number:!0}]]),(0,p.createElementVNode)('label',V,'Top P: '+(0,p.toDisplayString)(t.value.top_p),1),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_top_p','onUpdate:modelValue':o[6]||(o[6]=e=>t.value.top_p=e),type:'range',step:'0.05',min:'0',max:'1'},null,512),[[p.vModelText,t.value.top_p,void 0,{number:!0}]]),(0,p.createElementVNode)('label',N,'Top K: '+(0,p.toDisplayString)(t.value.top_k),1),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_top_k','onUpdate:modelValue':o[7]||(o[7]=e=>t.value.top_k=e),type:'range',step:'1',min:'0',max:'100'},null,512),[[p.vModelText,t.value.top_k,void 0,{number:!0}]]),(0,p.createElementVNode)('label',w,'Max Tokens: '+(0,p.toDisplayString)(t.value.max_tokens),1),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_max_tokens','onUpdate:modelValue':o[8]||(o[8]=e=>t.value.max_tokens=e),type:'number',class:'text_pole',min:'1'},null,512),[[p.vModelText,t.value.max_tokens,void 0,{number:!0}]])]),o[20]||(o[20]=(0,p.createElementVNode)('hr',null,null,-1)),(0,p.createElementVNode)('div',k,[o[16]||(o[16]=(0,p.createElementVNode)('div',null,[(0,p.createElementVNode)('strong',null,'自动化设置')],-1)),o[17]||(o[17]=(0,p.createElementVNode)('label',{for:'auto_runner_max_replies'},'最大回复次数',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{id:'auto_runner_max_replies','onUpdate:modelValue':o[9]||(o[9]=e=>t.value.maxReplies=e),type:'number',class:'text_pole',min:'1'},null,512),[[p.vModelText,t.value.maxReplies,void 0,{number:!0}]])])])]))}});r(931);const A=(0,r(42).A)(S,[['__scopeId','data-v-2d0e8d19']]),M=(0,p.createApp)(A);function R(){try{toastr.info('[AutoRunner] 开始初始化面板...'),function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const t=$('#extensions_settings2');if(0===t.length)return void toastr.error('找不到注入点 #extensions_settings2，无法创建界面。','[AutoRunner] 错误');toastr.success('成功找到注入点 #extensions_settings2。','[AutoRunner]');const n=$('<div>').attr('script_id',getScriptId());t.append(n),toastr.info('Vue 容器已注入页面。','[AutoRunner]'),M.use(e()).mount(n[0]),toastr.success('Vue 应用已成功挂载！','[AutoRunner]')}catch(e){console.error('[AutoRunner] 初始化面板时出错:',e),toastr.error(`初始化面板时出错: ${e.message}`,'[AutoRunner] 致命错误')}}function T(){M.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}$(()=>{R(),eventOn(tavern_events.GENERATION_ENDED,d),eventOn(tavern_events.MESSAGE_SENT,c),console.log('自动化运行脚本已启动并监听事件。')}),$(window).on('pagehide',()=>{T()});